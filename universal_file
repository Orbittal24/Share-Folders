/// 7 March 2022 3:21 PM Added 3 points to cross check stop prod, set serial pack no, swal
// var mysql = require("mysql"); // 02022022: 21:11
var sql = require('mssql');
var async = require("async");
var moment = require('moment');
var express = require("express"),
    app = require("express")(),
    http = require("http").Server(app),
    io = require("socket.io")(http),
    util = require("util"),
    fs = require("fs");
// app.use(cors());
const { resolve } = require('path');
const nrc = require('node-run-cmd');

const sqlConfig = {
    user: "user_mis",
    password: "admin",
    database: "taco_treceability",
    server: '10.9.4.28\\MSSQLSERVER',
    pool: {
      max: 10,
      min: 0,
      idleTimeoutMillis: 30000
    },
    options: {
      encrypt: true, // for azure
      trustServerCertificate: true // change to true for local dev / self-signed certs
    }
  };
  const sqlConfig_new = {
    user: "user_mis",
    password: "admin",
    database: "taco_treceability",
    server: '10.9.4.28\\MSSQLSERVER',
    pool: {
        max: 10,
        min: 0,
        idleTimeoutMillis: 30000
    },
    options: {
        encrypt: true, // for azure
        trustServerCertificate: true // change to true for local dev / self-signed certs
    }
};



  // Initialize connection pool
    var dbConn = new sql.ConnectionPool(sqlConfig);
    //console.log("1111111111111111111111....");
    dbConn.connect().then(function () {
        //console.log("Connected....",sqlConfig);
    });

    var dbConn_new = new sql.ConnectionPool(sqlConfig_new);
    console.log("1111111111111111111111....");
    dbConn_new.connect().then(function () {
        console.log("Connected....", sqlConfig);
    });
     
    const sqlConfig2 = {
        user: "user_mis",
        password: "admin",
        database: "taco_traceability_admin",
        server: '10.9.4.28\\MSSQLSERVER',
        pool: {
          max: 10,
          min: 0,
          idleTimeoutMillis: 30000
        },
        options: {
          encrypt: true, // for azure
          trustServerCertificate: true // change to true for local dev / self-signed certs
        }
      };
    
      // Initialize connection pool
        var dbConn2 = new sql.ConnectionPool(sqlConfig2);
        //console.log("1111111111111111111111....");
        dbConn2.connect().then(function () {
            //console.log("Connected....",sqlConfig2);
        });


http.listen(4041, "0.0.0.0", function () {
    console.log("Connected to :4041");
});

//////////////////////////////////
//TCP SERVER
const net = require('net');
const port = 7468;
const host = 'localhost';
const server = net.createServer();
server.listen(port, host, () => {
    //console.log('TCP Server is running on port ' + port +'.');
});
let sockets = [];

server.on('connection', function(sock) {
    //console.log('CONNECTED: ' + sock.remoteAddress + ':' + sock.remotePort);
    sockets.push(sock);

    sock.on('data', function(data) {
        //console.log('DATA ' + sock.remoteAddress + ': ' + data);
        // Write the data back to all the connected, the client will receive it as data from the server
        sockets.forEach(function(sock, index, array) {
            sock.write(sock.remoteAddress + ':' + sock.remotePort + " said " + data + '\n');
        });
    });
});




////////////////////////////////

// var production_count = require('./app_productionCount');
// production_count.includeCode(io);

var globalCellQRCodeStore=[];
var globalProduction_count_array = [];
var  globalCellQRCodeStore_line2 = [];
var globalDATABASEQueueModuleComplete =[];
var global_from_test_line6,global_to_test_line6;
var globalAllowedBatches=[];
var globalbatchstring;
var globalplant_code;
var global_batch_reset_flag = 0;
setInterval(() => {
    if(parseInt(globalDATABASEQueueModuleComplete.length) > 0){
        executeQueuedQeryies_module();
        //console.log('Queue found queries')
    }
    
}, 500);

function executeQueuedQeryies_module() {
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();


        request.query(globalDATABASEQueueModuleComplete[0], function (err, recordset) {
           //var result = recordset.recordset;
    // globalDATABASEQueueModuleComplete[0], function (err, result) {
            if (err) {
                console.log(err);
                //console.log('errcodecodecodecode:',err.code);
                if(err.code == 'ER_DUP_ENTRY' || err.code == 'EREQUEST' || parseInt(err.errno) == 1062) {
                    globalDATABASEQueueModuleComplete.shift();
                }
            
            }
            else{
            
                globalDATABASEQueueModuleComplete.shift();
                //console.log('query excecuted and queue updated')
            }
        
        });
    });
}
(async function main(){
    refreshInMemoryData();
})();





var line1FirstStartFlag=false;
var globalStation_status_Flag = 0;
async function packRegisterCheckModule(packname, serialNumber1, serialNumber2, serialNumber3) {
    //console.log('serialNumber1, serialNumber2, serialNumber3',serialNumber1, serialNumber2, serialNumber3);

    var serialNumbersArr=[];
    if(serialNumber1) {
        serialNumbersArr.push(serialNumber1);
    }
    if(serialNumber2) {
        serialNumbersArr.push(serialNumber2);
    }
    if(serialNumber3) {
        serialNumbersArr.push(serialNumber3);
    }
    
    line1FirstStartFlag=true;
    var iterration1 = 0;
    /////generate FINALQR CODE
    var FINALQRCODE;
    var CustomerQRCode;

    var tempStr='T635800122000043';
    var TMLPartNo = '00512380600101';
    var DrawingRefNo = 'OE';
    if(packname == 'Limber'){
        TMLPartNo ='00545680600113';
        DrawingRefNo = '0C';
    }
    else if(packname == 'Kanger 1 AIO'){
        //TMLPartNo ='00512386600104';
        TMLPartNo ='00512380600104';
        DrawingRefNo = 'NR';
    } else if(packname == 'Kanger 1 Gen 3'){
        TMLPartNo ='00512380600101';
        DrawingRefNo = '0D';
    } else if(packname == 'Kanger 2'){
        TMLPartNo ='00512380600103';
        DrawingRefNo = '0A';
    }
    else if (packname == 'NOVA MROPS') {
        TMLPartNo = '00546880600137';
        DrawingRefNo = '01';
    }
    else if (packname == 'NOVA LROPS') {
        TMLPartNo = '00546880600141';
        DrawingRefNo = '01';
    }
    else if (packname == 'Tamor') {
        TMLPartNo = '00547280609905';
        DrawingRefNo = '02';
    }

var supplierCode = 'T63666';
var MMYY='MMYY';

var dateStr = newDateReturn();
var curMM = dateStr.getMonth()+1;
var curYY = dateStr.getFullYear().toString().substring(2,);
curMM = (curMM.toString().length<2)?"0"+curMM:curMM;
var globalMMYY=curMM+curYY;
var CustSerNo='';
if (CustSerNo.length == 1) { CustSerNo = '00000' + CustSerNo }
if (CustSerNo.length == 2) { CustSerNo = '0000' + CustSerNo }
if (CustSerNo.length == 3) { CustSerNo = '000' + CustSerNo }
if (CustSerNo.length == 4) { CustSerNo = '00' + CustSerNo }
if (CustSerNo.length == 5) { CustSerNo = '0' + CustSerNo }

CustomerQRCode = TMLPartNo + DrawingRefNo + supplierCode + globalMMYY + CustSerNo;

var Systemyear,SystemMonth,SystemDate;
var dateToInsertInDB;
var todayDateStr = moment().format("YYYY-MM-DD HH:mm:ss");
var previousDateStr = moment();
previousDateStr = previousDateStr.subtract(1, "days");
previousDateStr = previousDateStr.format("YYYY-MM-DD HH:mm:ss");

//console.log('todayDateStr:',todayDateStr);
//console.log('previousDateStr:',previousDateStr);

var hourStr=todayDateStr.split(' ')[1].split(':');
var hourVar=hourStr[0];
var minuteVar=hourStr[1];
//console.log('hourStr:',hourStr);
//console.log('hourVar:',hourVar);
//console.log('minuteVar:',minuteVar);

if(current_shift==3) {
if(parseInt(hourVar)>=0 && parseInt(hourVar)<6) { 
    dateToInsertInDB=previousDateStr;
    var splitStr=previousDateStr.split(" ")[0].split("-");
    Systemyear=splitStr[0];
    SystemMonth=splitStr[1];
    SystemDate=splitStr[2];
} else if(parseInt(hourVar)==6) {
    if(parseInt(minuteVar)<30) {
        dateToInsertInDB=previousDateStr;
        var splitStr=previousDateStr.split(" ")[0].split("-");
        Systemyear=splitStr[0];
        SystemMonth=splitStr[1];
        SystemDate=splitStr[2];
    }
} else {
    dateToInsertInDB=todayDateStr;
    var splitStr=todayDateStr.split(" ")[0].split("-");
    Systemyear=splitStr[0];
    SystemMonth=splitStr[1];
    SystemDate=splitStr[2];
}
} else {
dateToInsertInDB=todayDateStr;
var splitStr=todayDateStr.split(" ")[0].split("-");
Systemyear=splitStr[0];
SystemMonth=splitStr[1];
SystemDate=splitStr[2];
}

var serial1Array=[];
var serial2Array=[];
var serial3Array=[];
    // console.log('5th step')

    var ProdAddress = '4';  // line code
    var packwiseallcellentry=[],module_code_arr=[],module_name_arr=[],countArr=[],module_barcodeArr=[];
    var Vendorcode,ProductType,BatteryType,moduleName,ExtensionCode,ProdPlantCode; // ProdLineCode - is plantcode
    var prev_index_module,prevcurrentModuleSerialNumber;
    var moduleGroupStr,moduleCellCountNum;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query("SELECT * FROM taco_traceability_admin.dbo.battery_pack_details where pack_name='"+packname.replace(/\s+/g, '_')+"' order by module_sequence_number", function (err, recordset) {
            if (err) console.log(err);
            if(recordset){
                var result1 = recordset.recordset;
                for (var i in result1) {
                    var pack_name = result1[i].pack_name;
                    var module_name = result1[i].module_name;
                    var module_number = result1[i].module_number;
                    var module_sequence_number = result1[i].module_sequence_number;
                    var cell_count = result1[i].cell_count;

                    packwiseallcellentry.push(pack_name);
                    packwiseallcellentry.push(module_name);
                    packwiseallcellentry.push(module_number);
                    packwiseallcellentry.push(module_sequence_number);
                    packwiseallcellentry.push(cell_count);
                }
                setTimeout(function () {
                   
                    request.query("SELECT * FROM taco_traceability_admin.dbo.tml_module_code where module_type_name='"+packname+"'", async function (err, recordset) {
                        if (err) console.log(err);
                        if(recordset){
                            var result1 = recordset.recordset;
                            for (var i in result1) {
                               var module_code_no = result1[i].module_code_no;
                               var module_name = result1[i].module_name;

                               module_code_arr.push(module_code_no);
                               module_name_arr.push(module_name);
                            }

                            request.query("SELECT TOP(1) * FROM taco_traceability_admin.dbo.tml_nom where type='"+packname+"' ORDER BY sr_no DESC", function (err, recordset) {
                                if (err) console.log(err);
                                if(recordset){
                                    var result1 = recordset.recordset;
                                    for (var i in result1) {
                                       var nomenclature = result1[i].nomenclature;

                                     //01TMB01620002-----1
                                     //01TMB---60001-----
                                    
                                   
                                        Vendorcode = nomenclature.substring(0, 3);
                                        ProductType = nomenclature.substring(3, 4);
                                        BatteryType = nomenclature.substring(4, 5);
                                      //  moduleName = nomenclature.substring(5, 8);
                                        batchCode = nomenclature.substring(8, 9);
                                        ExtensionCode = nomenclature.substring(9, 12);
                                        ProdPlantCode = nomenclature.substring(12, 13);

                                        

                                    }

                                    request.query("SELECT Substring(module_name, 1, 1) as Project,COUNT(module_name) as count_module FROM taco_traceability_admin.dbo.battery_pack_details  where pack_name='"+packname.replace(/\s+/g, '_')+"' group by Substring(module_name, 1, 1)", async function (err, recordset) {
                                        if (err) console.log(err);
                                        if(recordset){
                                            var result1 = recordset.recordset;
                                            for (var i in result1) {
                                              countArr.push(result1[i].count_module);
                                            }
                                        }
                                        });

                                    var watchdog = 0;

                                    var runningModule;
                                    var moduleIndex;
                                    var moduleNumber = 0;
                                    var MODULEBARCODE_final = '';
                                    var modulesCharArr=[];
(async ()=>{                                
    for(var i=0;i<packwiseallcellentry.length;i=i+5){

        moduleNumber=parseInt(packwiseallcellentry[i+3]);
        moduleGroupStr=packwiseallcellentry[i+2];
        moduleCellCountNum=packwiseallcellentry[i+4];
            var ModuleName1 = packwiseallcellentry[i+1];
            // runningModule = A6p6s;    //comment
            /// new module creation 
            
            for (var l = 0; l < parseInt(packwiseallcellentry[i+4]); l++) {
                //  console.log('iiiiii',l);
                var rowNum1 = l;
                var rowName1 = '';
                var total_cell_count_last=parseInt(packwiseallcellentry[i+4])-1;
                if (rowNum1 == 0) { rowName1 = 'first'; }
                else if (rowNum1 == total_cell_count_last) { rowName1 = 'last'; }
                else { rowName1 = 'mid'; }
                //startProdEntry(packname, rowName1, ModuleName1, '7', FINALQRCODE,l,runningModule,function(data) {

                //});

                var n_index=module_name_arr.indexOf(ModuleName1);
                var totalModule = countArr[n_index];   //comment
                if(i==0) {
                    totalModule = countArr[0];
                }
                var lastModuleSerialNumber = 0;

                if (runningModule == 0) {
                    //console.log('runningModulewwwwwwwwwwwwwwwwww', runningModule);
                }

                //console.log('value of i',i)
                if (rowName1 == 'first') {

                    var currentTime = moment().format("YYYY-MM-DD HH:mm:ss");

                    var Year = ''; // done
                    var Month = '';
                    var Date = '';
                    var FeatureCode = '0';
                    var serialNumber = '123456'; ///done

                    ///serial number
                    //console.log('ModuleSerialCode of module', ModuleName1, 'i', i)

                    var serailnumbertempResult;
                    var serialnumbermodulename = ModuleName1

                    var tempArray1 = [];
                    // console.log(' 6th step initial array1',tempArray1);

                    ///wait for select to finish
                    tempArray1 = await runModuleSerialQuery173(ModuleName1);





                    //generateOrbittalFinalQRcode();
                    //generateOrbittalModuleBarcode();
                    var index_module=module_name_arr.indexOf(ModuleName1);
                    
                    moduleName=module_code_arr[index_module];
                    var curserialNumber=serialNumbersArr[index_module];

                    //console.log('tempArrayyyyyyyyyyyyyyyyyyyyyyyyy', tempArray1.length);
                    if (tempArray1.length == 0) {
                        tempArray1.push('000000');
                    }
                    lastModuleSerialNumber = tempArray1[tempArray1.length - 1];
                    //console.log('tgtgtgtgtgtgtg',lastModuleSerialNumber)
                    var currentModuleSerialNumber;// = parseInt(curserialNumber) + 1;
                    if(i==0) {
                        prevcurrentModuleSerialNumber=parseInt(curserialNumber);
                    }
                    if(prev_index_module!=index_module) {
                        currentModuleSerialNumber = parseInt(curserialNumber);
                        prevcurrentModuleSerialNumber=currentModuleSerialNumber;
                        prev_index_module=index_module;
                    } else {
                        currentModuleSerialNumber = parseInt(prevcurrentModuleSerialNumber) + 1;
                        prevcurrentModuleSerialNumber=currentModuleSerialNumber;
                    }
                    

                    serialNumber = currentModuleSerialNumber.toString();
                    ///// check positive - negative
                    // var positiveNum=[1,3,5,7,9,10,12];
                    // var negativeNum=[2,4,6,8,11,13];
                    var polarity=packwiseallcellentry[i+2];

                    if(polarity[polarity.length-2]=="+") {
                        if (serialNumber.length == 1) { serialNumber = '10000' + serialNumber.toString() }
                        if (serialNumber.length == 2) { serialNumber = '1000' + serialNumber.toString() }
                        if (serialNumber.length == 3) { serialNumber = '100' + serialNumber.toString() }
                        if (serialNumber.length == 4) { serialNumber = '10' + serialNumber.toString() }
                        if (serialNumber.length == 5) { serialNumber = '1' + serialNumber.toString() }

                    } else if(polarity[polarity.length-2]=="-") {
                        if (serialNumber.length == 1) { serialNumber = '20000' + serialNumber.toString() }
                        if (serialNumber.length == 2) { serialNumber = '2000' + serialNumber.toString() }
                        if (serialNumber.length == 3) { serialNumber = '200' + serialNumber.toString() }
                        if (serialNumber.length == 4) { serialNumber = '20' + serialNumber.toString() }
                        if (serialNumber.length == 5) { serialNumber = '2' + serialNumber.toString() }
                    }

                    
                   
                    // console.log('7th step serial number of packkkkkkkkkkkkkkkkkkkkkkkkkkk', serialNumber)



                    if (Systemyear == 2021) { Year = 'B' } if (Systemyear == 2022) { Year = 'C' } if (Systemyear == 2023) { Year = 'D' } if (Systemyear == 2024) { Year = 'E' } if (Systemyear == 2025) { Year = 'F' } if (Systemyear == 2026) { Year = 'G' }
                    if (SystemMonth == 1) { Month = '1'; } if (SystemMonth == 2) { Month = '2'; } if (SystemMonth == 3) { Month = '3'; } if (SystemMonth == 4) { Month = '4'; } if (SystemMonth == 5) { Month = '5'; } if (SystemMonth == 6) { Month = '6'; } if (SystemMonth == 7) { Month = '7'; } if (SystemMonth == 8) { Month = '8'; } if (SystemMonth == 9) { Month = '9'; } if (SystemMonth == 10) { Month = 'A'; } if (SystemMonth == 11) { Month = 'B'; } if (SystemMonth == 12) { Month = 'C'; }
                    if (SystemDate == 1) { Date = '1'; } if (SystemDate == 2) { Date = '2'; } if (SystemDate == 3) { Date = 3; } if (SystemDate == 4) { Date = '4'; } if (SystemDate == 5) { Date = '5'; } if (SystemDate == 6) { Date = '6'; } if (SystemDate == 7) { Date = '7'; } if (SystemDate == 8) { Date = '8'; } if (SystemDate == 9) { Date = '9'; } if (SystemDate == '10') { Date = 'A'; } if (SystemDate == 11) { Date = 'B'; } if (SystemDate == 12) { Date = 'C'; } if (SystemDate == 13) { Date = 'D'; } if (SystemDate == 14) { Date = 'E'; } if (SystemDate == 15) { Date = 'F'; } if (SystemDate == 16) { Date = 'G'; } if (SystemDate == 17) { Date = 'H'; } if (SystemDate == 18) { Date = 'J'; } if (SystemDate == 19) { Date = 'K'; } if (SystemDate == 20) { Date = 'L'; } if (SystemDate == 21) { Date = 'M'; } if (SystemDate == 22) { Date = 'N'; } if (SystemDate == 23) { Date = 'P'; } if (SystemDate == 24) { Date = 'R'; } if (SystemDate == 25) { Date = 'S'; } if (SystemDate == 26) { Date = 'T'; } if (SystemDate == 27) { Date = 'V'; } if (SystemDate == 28) { Date = 'W'; } if (SystemDate == 29) { Date = 'X'; } if (SystemDate == 30) { Date = 'Y'; } if (SystemDate == 31) { Date = '0'; }

                    
                    MODULEBARCODE_final = Vendorcode + ProductType + BatteryType + moduleName + batchCode + ExtensionCode + ProdPlantCode + ProdAddress + Year + Month + Date + FeatureCode + serialNumber;

                    if(i==0) {
                        serial1Array.push(MODULEBARCODE_final);
                    } else if(i==1) {
                        serial2Array.push(MODULEBARCODE_final);
                    } else if(i==2) {
                        serial3Array.push(MODULEBARCODE_final);
                    }
                    //console.log('ModuleBarcode------', MODULEBARCODE_final);
                    module_barcodeArr.push(MODULEBARCODE_final);
                    var moduleSerialNumberGen = MODULEBARCODE_final.substr(MODULEBARCODE_final.length - 6);
                    var moduleIdStr = ModuleName1 + "-" + moduleSerialNumberGen;



                }

            }

            

    }

})();
                                 
    }
                                });


/////////////////////////////////////DYNAMIC END /////////////////////////////////////////
                        }
                    }); 
                }, 200);
            }
        });
    });
    return [serial1Array,serial2Array,serial3Array];
}
function checkForDuplicateModules(type1,type2,type3) {
    var invalidEntry=[];
    return new Promise((resolve, reject) => {
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();

        async.forEachOf(type1, function(obj, i, inner_callback) {
            var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
            // dataElement['undercut'] = i;
            request.query(query, function (err, recordset) {
                if (err) console.log(err);
                var result=recordset.recordset;
                if(result.length>0) {
                    invalidEntry.push({
                        "type": "1",
                        "element": obj,
                        "status": "invalid"
                    });
                    resolve(invalidEntry);
                }
                inner_callback(null);
            });
        }, function(err) {
            if (err) {
                //console.log('checkForDuplicateModules::', err);
            } else {
                //process further
                async.forEachOf(type2, function(obj, i, inner_callback) {
                    var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
                    // dataElement['undercut'] = i;
                    request.query(query, function (err, recordset) {
                        if (err) console.log(err);
                        var result=recordset.recordset;
                        if(result.length>0) {
                            invalidEntry.push({
                                "type": "2",
                                "element": obj,
                                "status": "invalid"
                            });
                            resolve(invalidEntry);
                        }
                        inner_callback(null);
                    });
                }, function(err) {
                    if (err) {
                        //console.log('checkForDuplicateModules::', err);
                    } else {
                        async.forEachOf(type3, function(obj, i, inner_callback) {
                            var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
                            // dataElement['undercut'] = i;
                            request.query(query, function (err, recordset) {
                                if (err) console.log(err);
                                var result=recordset.recordset;
                                if(result.length>0) {
                                    invalidEntry.push({
                                        "type": "3",
                                        "element": obj,
                                        "status": "invalid"
                                    });
                                    resolve(invalidEntry);
                                }
                                inner_callback(null);
                            });
                        }, function(err) {
                            if (err) {
                                //console.log('checkForDuplicateModules::', err);
                            } else {
                                if(invalidEntry.length==0) {
                                    // not found in station_status table
                                    async.forEachOf(type1, function(obj, i, inner2_callback) {
                                        var query = `SELECT * FROM taco_treceability.taco_treceability.production_count_archive_compress where module_barcode='${obj}'`;
                                        // dataElement['undercut'] = i;
                                        request.query(query, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result=recordset.recordset;
                                            if(result.length>0) {
                                                invalidEntry.push({
                                                    "type": "1",
                                                    "element": obj,
                                                    "status": "invalid"
                                                });
                                                resolve(invalidEntry);
                                            }
                                            inner2_callback(null);
                                        });
                                    }, function(err) {
                                        if (err) {
                                            //console.log('checkForDuplicateModules::', err);
                                        } else {
                                            //process further
                                            async.forEachOf(type2, function(obj, i, inner2_callback) {
                                                var query = `SELECT * FROM taco_treceability.taco_treceability.production_count_archive_compress where module_barcode='${obj}'`;
                                                // dataElement['undercut'] = i;
                                                request.query(query, function (err, recordset) {
                                                    if (err) console.log(err);
                                                    var result=recordset.recordset;
                                                    if(result.length>0) {
                                                        invalidEntry.push({
                                                            "type": "2",
                                                            "element": obj,
                                                            "status": "invalid"
                                                        });
                                                        resolve(invalidEntry);
                                                    }
                                                    inner2_callback(null);
                                                });
                                            }, function(err) {
                                                if (err) {
                                                    //console.log('checkForDuplicateModules::', err);
                                                } else {
                                                    async.forEachOf(type3, function(obj, i, inner2_callback) {
                                                        var query = `SELECT * FROM taco_treceability.taco_treceability.production_count_archive_compress where module_barcode='${obj}'`;
                                                        // dataElement['undercut'] = i;
                                                        request.query(query, function (err, recordset) {
                                                            if (err) console.log(err);
                                                            var result=recordset.recordset;
                                                            if(result.length>0) {
                                                                invalidEntry.push({
                                                                    "type": "3",
                                                                    "element": obj,
                                                                    "status": "invalid"
                                                                });
                                                                resolve(invalidEntry);
                                                            }
                                                            inner2_callback(null);
                                                        });
                                                    }, function(err) {
                                                        if (err) {
                                                            //console.log('checkForDuplicateModules::', err);
                                                        } else {
                                                            if(invalidEntry.length==0) {
                                                                invalidEntry.push({
                                                                    "element": "all_entries_valid",
                                                                    "status": "valid"
                                                                });
                                                            }
                                                            resolve(invalidEntry);
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    });
                                }
                                // resolve(invalidEntry);
                            }
                        });
                    }
                });
            }
        });  
    });
});
}
/*
function checkForDuplicateModules(type1,type2,type3) {
    var invalidEntry=[];
    return new Promise((resolve, reject) => {
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();

        async.forEachOf(type1, function(obj, i, inner_callback) {
            var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
            console.log('query-1:',query);
            // dataElement['undercut'] = i;
            request.query(query, function (err, recordset) {
                if (err) console.log(err);
                var result=recordset.recordset;
                if(result.length>0) {
                    invalidEntry.push({
                        "type": "1",
                        "element": obj,
                        "status": "invalid"
                    });
                    resolve(invalidEntry);
                }
                inner_callback(null);
            });
        }, function(err) {
            if (err) {
                console.log('checkForDuplicateModules::', err);
            } else {
                //process further
                async.forEachOf(type2, function(obj, i, inner_callback) {
                    var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
                    // dataElement['undercut'] = i;
                    request.query(query, function (err, recordset) {
                        if (err) console.log(err);
                        var result=recordset.recordset;
                        if(result.length>0) {
                            invalidEntry.push({
                                "type": "2",
                                "element": obj,
                                "status": "invalid"
                            });
                            resolve(invalidEntry);
                        }
                        inner_callback(null);
                    });
                }, function(err) {
                    if (err) {
                        console.log('checkForDuplicateModules::', err);
                    } else {
                        async.forEachOf(type3, function(obj, i, inner_callback) {
                            var query = `SELECT * FROM taco_treceability.taco_treceability.station_status where ModuleBarcode='${obj}'`;
                            // dataElement['undercut'] = i;
                            request.query(query, function (err, recordset) {
                                if (err) console.log(err);
                                var result=recordset.recordset;
                                if(result.length>0) {
                                    invalidEntry.push({
                                        "type": "3",
                                        "element": obj,
                                        "status": "invalid"
                                    });
                                    resolve(invalidEntry);
                                }
                                inner_callback(null);
                            });
                        }, function(err) {
                            if (err) {
                                console.log('checkForDuplicateModules::', err);
                            } else {
                                if(invalidEntry.length==0) {
                                    invalidEntry.push({
                                        "element": "all_entries_valid",
                                        "status": "valid"
                                    });
                                }
                                resolve(invalidEntry);
                            }
                        });
                    }
                });
            }
        });  
    });
});
}
*/
//check module duplication function - end

io.on('connection', (socket) => {

    socket.on('setBatchArray', async(bachesArray)=>{
        globalbatchstring = bachesArray;
        globalAllowedBatches = globalbatchstring.split(',');
    })
     ////////////////////////////Cell range and voltage range check////
     socket.on('getDuplicateAndVoltageIrVal', async(module_barcode)=>{
        var getVals = await getDuplicateAndVoltageIrVal(module_barcode);
        var checkScanStatus1 = await checkScanStatuss();
        var batch_validation = await getBatchval(module_barcode);
        var class_validation = await getcapacity_classval(module_barcode);
        var interlock_status="ON";
        var batchinterlock_status="ON";
        var kvalueinterlock_status="ON";
        var classinterlock_status="ON";
        sql.connect(sqlConfig2, function (err) {
            request = new sql.Request();
            request.query("SELECT * FROM taco_traceability_admin.dbo.interlock_status WHERE line_name='Line4'", function (err, recordset2) {
                var result = recordset2.recordset;
                if(result.length>0){
                    for (var i in result) {
                        interlock_status = result[i].status;
                     }
                     request.query("SELECT * FROM taco_treceability.taco_treceability.line1runningBatch WHERE LineName='line4'", function (err, recordset) {
                        var result331 = recordset.recordset;
                        if(result331.length>0){
                            for (var i in result331) {
                                batchinterlock_status = result331[i].batch_interlock;
                                kvalueinterlock_status = result331[i].kvalue_interlock;
                                classinterlock_status = result331[i].class_interlock;
                             }
    
                             socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1,interlock_status,batchinterlock_status,batch_validation,kvalueinterlock_status,class_validation,classinterlock_status);
                        }
                        else{
                            socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1,interlock_status,batchinterlock_status,batch_validation,kvalueinterlock_status,class_validation,classinterlock_status);
                        }
                    });
    
                   // socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1,interlock_status);
    
                }
                else{
                    socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1,interlock_status,batchinterlock_status,batch_validation,kvalueinterlock_status,class_validation,classinterlock_status);
    
               }
           
           });
       });
     //socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1);
    });
    function getcapacity_classval(barcode) {
        return new Promise(async(resolve, reject) => {
            var cell_capacity,cell_class,ocv_cell_capacity,ocv_cell_class;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT * FROM taco_treceability.taco_treceability.line1runningbatch WHERE LineName = 'line4'`, function (err2, recordset) {
                        if (err2) console.log(err2);
                        var result = recordset.recordset;
                        if(result.length>0) {
                            cell_capacity=result[0].cell_capacity;
                            cell_class = result[0].cell_class;
                            if(cell_class!=""){
                                request.query(`SELECT * FROM taco_treceability.taco_treceability.ocv_machine_data WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
                                    if (err2) console.log(err2);
                                    var result = recordset.recordset;
                                    if(result.length>0) {
                                        ocv_cell_capacity=result[0].cell_capacity;
                                        ocv_cell_class = result[0].cell_class;

                                        if(cell_class.includes('-')){
                                            if(ocv_cell_class.split('-')[0]==cell_class.split('-')[0]){
                                                resolve("Valid Class");
                                            }
                                            else{
                                                resolve("Invalid Class");
                                            }
                                        }
                                        else{
                                            if(ocv_cell_class==cell_class){
                                                resolve("Valid Class");
                                            }
                                            else{
                                                resolve("Invalid Class");
                                            }
                                        }
                                        
                                     }
                                     else{
                                        resolve("Invalid Class");
                                    }
                            });
                            }
                            else{
                                resolve("Invalid Class");
                            }
                          
                         }
                         else{
                            resolve("Invalid Class");
                         }
                 
                });
            });
    
            
        });
      
    }
    function getDuplicateAndVoltageIrVal(barcode) {
        return new Promise(async(resolve, reject) => {
        var voltage_ir_val = await getVoltageIrVal(barcode);
        if(voltage_ir_val.split(",").length == 7) {
            voltage_str=voltage_ir_val.split(",")[0];
            ir_str=voltage_ir_val.split(",")[1];
            ocv_updatetime_str=voltage_ir_val.split(",")[2];
            ocv_macloc_str=voltage_ir_val.split(",")[3];
            kvalue_str=voltage_ir_val.split(",")[4];
            class_str=voltage_ir_val.split(",")[5];
            capacity_str=voltage_ir_val.split(",")[6];
        } else {
            voltage_str="NOT_FOUND";
            ir_str="NOT_FOUND";
            ocv_updatetime_str="NOT_FOUND";
            ocv_macloc_str="NOT_FOUND";
            kvalue_str="NOT_FOUND";
            class_str="NOT_FOUND";
            capacity_str="NOT_FOUND";
        }
        var returnVolVal=voltage_str+","+ir_str+","+ocv_updatetime_str+","+ocv_macloc_str+","+kvalue_str+","+class_str+","+capacity_str;
        var isQRCodePresent="false";
        if(globalCellQRCodeStore.includes(barcode) ) {
            isQRCodePresent="true";
        }
        resolve(isQRCodePresent+","+returnVolVal);
        });
    }
    //////////////////////Cell scanning new fields start///////////////////////////////////
    // socket.on('set_cell_soc_data',(pckname,live_pckno,cell_grade,soc_per,line)=>{
    //     console.log("cell_data:",pckname,live_pckno,cell_grade,soc_per,line,live_pckno.trim());
    //   var pnumber=live_pckno.trim();
    //     var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.cell_new_fields where packname='${pckname}' and pack_number='${pnumber}'`;
    //    console.log("inser123:",dqQuery);
    //     sql.connect(sqlConfig, function (err) {
    //         request = new sql.Request();
    //         request.query(dqQuery, function (err, recordset) {
    //             // if (err) console.log(err);
    //             var result = recordset.recordset;
    //             if(result.length ==0){
    //                 var dbQuery=`insert into taco_treceability.taco_treceability.cell_new_fields(packname,pack_number,cell_grade,soc_per,line) values('${pckname}','${pnumber}','${cell_grade}','${soc_per}','${line}')`;
    //         console.log('insert new fields query', dbQuery);
          
    //             request1 = new sql.Request();
    //             request1.query(dbQuery, function (err, recordset) {
    //                 if (err) console.log(err);
    //             })
    //      //   });
    //             }
    //             else{
                  
    //             }
    //         });
    //     });
    // });

    // socket.on('get_cell_soc_data',(runningPackName,packnum,line)=>{
    //     console.log("wwwwwwwwwww1111:",runningPackName,packnum,line);
    //     if(packnum.length==1){
    //         packnum='00000'+packnum;
    //     }
    //     if(packnum.length==2){
    //         packnum='0000'+packnum;
    //     }
    //     if(packnum.length==3){
    //         packnum='000'+packnum;
    //     }
    //     if(packnum.length==4){
    //         packnum='00'+packnum;
    //     }
    //     if(packnum.length==5){
    //         packnum='0'+packnum;
    //     }
    //     if(packnum.length==6){
    //         packnum=packnum;
    //     }

    //     sql.connect(sqlConfig, function (err) {
    //         var cell_grade,soc_per;
    //     var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.cell_new_fields where packname='${runningPackName}' and pack_number='${packnum.trim()}'`;  // and line='${line}'
    //     console.log("wwwwwwwwwww22222222:",dqQuery);
       
      
           
    //         request = new sql.Request();
    //         request.query(dqQuery, function (err, recordset) {
    //             // if (err) console.log(err);
               
    //             var result = recordset.recordset;
    //             if(result.length !=0){
    //                 for(var i in result) {

    //                      cell_grade=result[i].cell_grade;
    //                     soc_per=result[i].soc_per;
                       
    //                 }
    //                 console.log("wwwwwwwwwww3333333333333333333:",cell_grade,soc_per);
    //      socket.emit("set_final_soc_data",cell_grade,soc_per);
    //             }
                
    //         });
    //     });
    // });
    ///////////////////////Cell scanning new fields end////////////////////
    socket.on('get_range_ofcell_barcode', async(packname,barcode)=>{
        console.log("get_range_ofcell_barcode",packname,barcode);
        var grade;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query("SELECT TOP(1)* FROM taco_treceability.taco_treceability.ocv_machine_data where cell_qrcode='"+barcode+"'", function (err, recordset) {
                var result = recordset.recordset;
                console.log("yu:",result);
                if(result.length>0){
                    console.log("yogita111:");
                    grade=result[0].grade;
                     console.log("grade:",grade);
                    sendcell_grade(grade,packname);
                
                  
                }
                else{
                    console.log("yogita123:");
                    grade='';
                    sendcell_grade(grade,packname);
                    
                }
               
               
            });
        });
     });
    
    
     function sendcell_grade(grade,packname){
        var range_from,range_to;
        console.log("grade,packname:",grade,packname);

       // var grade=' D [OK]';
        var grade_final=grade.trim().split(' ')[0];
        sql.connect(sqlConfig, function (err) {
            var request = new sql.Request();
            request.query("SELECT * FROM taco_treceability.taco_treceability.admin_voltage_rage_grad where grad='"+grade_final+"' and packname='"+packname+"'", function (err, recordset) {
                var result = recordset.recordset;
                console.log("tttttt:",result,result.length);
                if(result.length>0){
                    range_from=result[0].voltage_from;
                    range_to=result[0].voltage_to;
                   
                console.log("Grade 11111111111111111:",range_from,range_to);
                  socket.emit("set_range_ofcell_barcode",range_from,range_to);
                }
                else{
                    range_from='';
                    range_to='';
                    console.log("Grade 222222222:",range_from,range_to);
                    socket.emit("set_range_ofcell_barcode",range_from,range_to);
                }
               
               
            });
        });
     }
   //////////////////////Cell scanning new fields start///////////////////////////////////
   socket.on('get_capacity_class_ofcell_barcode', async(capacity_barcode)=>{
    console.log("CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC",capacity_barcode);
    var cell_capacity,cell_class;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query("SELECT TOP(1)* FROM taco_treceability.taco_treceability.ocv_machine_data where cell_qrcode='"+capacity_barcode+"' and (cell_class NOT IN ('null','NULL','')) order by sr_no desc", function (err, recordset) {
       // request.query("SELECT TOP(1)* FROM taco_treceability.taco_treceability.ocv_machine_data where cell_qrcode='"+capacity_barcode+"'", function (err, recordset) {
            var result = recordset.recordset;
            if(result.length>0){
              //  for(var i in result) {
                    cell_capacity=result[0].cell_capacity;
                    cell_class=result[0].cell_class;
              // }
               console.log("CCCCCCCCCCCCCCCCCCCCCCCCC",cell_capacity,cell_class);
               request.query("UPDATE taco_treceability.taco_treceability.line1runningBatch SET cell_capacity='"+cell_capacity+"',cell_class='"+cell_class+"' where LineName = 'line4'", function (err, recordset) {
            });
            socket.emit("set_cell_class_data_new",cell_class);
            }
            else{
                request.query("UPDATE taco_treceability.taco_treceability.line1runningBatch SET cell_capacity='',cell_class='' where LineName = 'line4'", function (err, recordset) {
                });
             
            }
           
        });
    });
 });
   socket.on('set_cell_soc_data',(pckname,live_pckno,cell_grade,soc_per,line,qcheckby)=>{
    // console.log("cell_data:",pckname,live_pckno,cell_grade,soc_per,line,live_pckno.trim());
   var pnumber=live_pckno.trim();
     var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.cell_new_fields where packname='${pckname}' and pack_number='${pnumber}'`;
  //  console.log("inser123:",dqQuery);
     sql.connect(sqlConfig, function (err) {
         request = new sql.Request();
         request.query(dqQuery, function (err, recordset) {
             // if (err) console.log(err);
             var result = recordset.recordset;
             if(result.length ==0){
                 var dbQuery=`insert into taco_treceability.taco_treceability.cell_new_fields(packname,pack_number,cell_grade,soc_per,line,qcheckby) values('${pckname}','${pnumber}','${cell_grade}','${soc_per}','${line}','${qcheckby}')`;
      //   console.log('insert new fields query', dbQuery);
       
             request1 = new sql.Request();
             request1.query(dbQuery, function (err, recordset) {
                 if (err) console.log(err);
             })
      //   });
             }
             else{
                 var dbQuery=`Update taco_treceability.taco_treceability.cell_new_fields set cell_grade='${cell_grade}',soc_per=${soc_per},qcheckby='${qcheckby}' where packname='${pckname}' and pack_number='${pnumber}'`;
                 //   console.log('insert new fields query', dbQuery);
                  
                        request1 = new sql.Request();
                        request1.query(dbQuery, function (err, recordset) {
                            if (err) console.log(err);
                        })
             }
         });
     });
 });

 socket.on('get_cell_soc_data',(runningPackName,packnum,line)=>{
    // console.log("wwwwwwwwwww1111:",runningPackName,packnum,line);
     if(packnum.length==1){
         packnum='00000'+packnum;
     }
     if(packnum.length==2){
         packnum='0000'+packnum;
     }
     if(packnum.length==3){
         packnum='000'+packnum;
     }
     if(packnum.length==4){
         packnum='00'+packnum;
     }
     if(packnum.length==5){
         packnum='0'+packnum;
     }
     if(packnum.length==6){
         packnum=packnum;
     }

     sql.connect(sqlConfig, function (err) {
         var cell_grade,soc_per,quality_per;
     var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.cell_new_fields where packname='${runningPackName}' and pack_number='${packnum.trim()}'`;  // and line='${line}'
   //  console.log("wwwwwwwwwww22222222:",dqQuery);
    
   
        
         request = new sql.Request();
         request.query(dqQuery, function (err, recordset) {
             // if (err) console.log(err);
            
             var result = recordset.recordset;
             if(result.length !=0){
                 for(var i in result) {

                    //  cell_grade=result[i].cell_grade;
                     soc_per=result[i].soc_per;
                     quality_per=result[i].qcheckby;
                 }
                 request.query("SELECT * FROM taco_treceability.taco_treceability.line1runningbatch where LineName = 'line4'", function (err, recordset) {
                    var result = recordset.recordset;
                   if(result.length !=0){
                       for(var i in result) {
      
                            cell_grade=result[i].cell_class;
                       }
            socket.emit("set_final_soc_data",cell_grade,soc_per,quality_per);
                   }
                   
               });
            
     // socket.emit("set_final_soc_data",cell_grade,soc_per,quality_per);
             }
             
         });
     });
 });
 ///////////////////////Cell scanning new fields end////////////////////
    // socket.on('getBatchMixingLimits', async(packName,batchCode,plantcode)=>{
    //     if(global_batch_reset_flag == 0)
    //      {
    //           globalplant_code=plantcode;
          
    //      //socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1);
    //      var dqQuery = `SELECT * FROM taco_traceability_admin.dbo.batchMix_limit where battery_pack_name='${packName}'`;
    //      var dbquery44 =`UPDATE taco_treceability.taco_treceability.line1runningBatch SET mixed_batches = '', selected_batches = '' where LineName = 'line4'`;
    //      sql.connect(sqlConfig2, function (err) {
    //          request = new sql.Request();
    //          request.query(dqQuery, function (err, recordset) {
    //              // if (err) console.log(err);
    //              var result = recordset.recordset;
                
    //              socket.emit('setBatchMixingLimits',result,batchCode,plantcode);
    //          });
    //      });
    
    //      sql.connect(sqlConfig, function (err) {
    //          request = new sql.Request();
             
    //              request.query(dbquery44, function (err, recordset) {
    //                  // if (err) console.log(err);
    //                  global_batch_reset_flag = 1;
                     
    //              });
               
            
    //      });
    
    //  }
    //  });


    
socket.on('getBatchMixingLimits', async(packName,batchCode,plantcode)=>{
    if(global_batch_reset_flag == 0)
     {
          globalplant_code=plantcode;
      
     //socket.emit('setDuplicateAndVoltageIrVal',module_barcode,getVals,checkScanStatus1);
     var dqQuery = `SELECT * FROM taco_traceability_admin.dbo.batchMix_limit where battery_pack_name='${packName}'`;
     var dbquery44 =`UPDATE taco_treceability.taco_treceability.line1runningBatch SET mixed_batches = '', selected_batches = '' where LineName = 'line4'`;
     sql.connect(sqlConfig2, function (err) {
         request = new sql.Request();
         request.query(dqQuery, function (err, recordset) {
             // if (err) console.log(err);
             var result = recordset.recordset;
            
             socket.emit('setBatchMixingLimits',result,batchCode,plantcode);
         });
     });

     global_batch_reset_flag = 1;

 
 }
 });


 socket.on('getBatchMixingLimits_empty', async()=>{
     var dbquery44 =`UPDATE taco_treceability.taco_treceability.line1runningBatch SET mixed_batches = '', selected_batches = '' where LineName = 'line4'`;
    

   
     sql.connect(sqlConfig, function (err) {
         request = new sql.Request();
         
             request.query(dbquery44, function (err, recordset) {
              
                 
             });
           
        
     });


 });

///////////////////////////////
    //check module duplication
    socket.on('checkForDuplicateModules',(packname,type1,type2,type3)=>{

        (async ()=> {

            var [a1,a2,a3] = await packRegisterCheckModule(packname,type1,type2,type3);
            //console.log('a1:',a1);
            //console.log('a2:',a2);
            //console.log('a3:',a3);
    
            var arr1=['01TMB02D10001AC337000005',
            '01TMB01610002AC8J7000002',
            '01TMB01610002AC8J7000003',
            '01TMB01610002AC8J7000004',
            '01TMB01610002AC8J7000005',
            '01TMB01610002AC8J7000006',
            '01TMB01610002AC8J7000007'];
            var arr2=[];
            var arr3=[];
            
            var checkModules = await checkForDuplicateModules(a1,a2,a3);
            //console.log('checkModules:',checkModules); 
            socket.emit('setCheckForDuplicateModules',checkModules);
            
        })();

    });
    

    socket.on('checkPacksInDB',(data)=>{
        // Check production_count
        var query4=`SELECT * FROM taco_treceability.taco_treceability.production_count where line='4' and battery_status='running' and cell_qr_code not like '03HC%'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(query4, function (err, recordset) {
                if (err) console.log(err);
                var result=recordset.recordset;
                if(result) {
                    if(result.length==0) {
                        // Change status of battery pack
                        var updateQuery1=`UPDATE taco_treceability.taco_treceability.production_count set battery_status='pending' where line='4' and battery_status='running'`;
                        request.query(updateQuery1, function (err, recordset) {
                            if (err) console.log(err);
                            // Check station_status
                            var query2=`UPDATE taco_treceability.taco_treceability.station_status set ModulePrintStatus='OK' where line='4'`;
                            request.query(query2, function (err, recordset) {
                                if (err) console.log(err);
                                // Update ocv_scanned_cell
                                var query3=`DELETE FROM taco_treceability.taco_treceability.ocv_scanned_cell where line='4'`;
                                request.query(query3, function (err, recordset) {
                                    if (err) console.log(err);
                                    // Send acknowledgement
                                    socket.emit('setCheckPacksInDB','data');
                                });
                            });
                        });
                    } else {
                        // Update station_status
                        var query2=`UPDATE taco_treceability.taco_treceability.station_status set ModulePrintStatus='OK' where line='4'`;
                        request.query(query2, function (err, recordset) {
                            if (err) console.log(err);
                            // Update ocv_scanned_cell
                            var query3=`DELETE FROM taco_treceability.taco_treceability.ocv_scanned_cell where line='4'`;
                            request.query(query3, function (err, recordset) {
                                if (err) console.log(err);
                                // Send acknowledgement
                                socket.emit('setCheckPacksInDB','data');
                            });
                        });
                    }
                }
            });
        });
    });
    
    //console.log('a user connected');
//if(backend_barcode_string != NA){
    async function get_station_status_flag(){
        var checkScanStatus = await checkScanStatuss();
        globalStation_status_Flag = checkScanStatus;
    }       
// function sendScanData(backend_barcode_string) {
//     console.log('TESTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT')
//     //io.emit("backend_barcode_string",backend_barcode_string);
// }
//}
    // Loader 
    socket.on('getline1FirstStartFlag', (data)=> {
        socket.emit('setline1FirstStartFlag',line1FirstStartFlag);
    });
    socket.on('check_station_status_flag',async (data)=> {
        await get_station_status_flag();
     
        socket.emit('set_station_status_flag',globalStation_status_Flag);
    });

    socket.on('check_pack_duplication',(packName,packSerialNumber)=>{
        var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}' and packName ='${packName}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dqQuery, function (err, recordset) {
                // if (err) console.log(err);
                var result = recordset.recordset;
                if(result.length >0){
                    socket.emit('set_check_pack_duplication','invalid_pack',result);
                }
                else{
                    socket.emit('set_check_pack_duplication','valid_pack',result);
                }
            });
        });
    });

    // Get Next Pack Serial
    socket.on('getNextPackSerial', (packname)=> {
        (async function main() {
            global_batch_reset_flag = 0;
            var lastPackSerialNumber1 = await getPackSerialNumber(packname);
            //lastPackSerialNumber = resolve;
            // console.log('3rd step result lastPackSerialNumber', lastPackSerialNumber);   // line 1----------------
            if (lastPackSerialNumber1 == undefined) { lastPackSerialNumber1 = 0; }
            var currentPackSerialNumber1 = parseInt(lastPackSerialNumber1) + 1;

            var serialNumber1 = currentPackSerialNumber1.toString();
            // if (serialNumber1.length == 1) { serialNumber1 = '000000' + serialNumber1 }
            // if (serialNumber1.length == 2) { serialNumber1 = '00000' + serialNumber1 }
            // if (serialNumber1.length == 3) { serialNumber1 = '0000' + serialNumber1 }
            // if (serialNumber1.length == 4) { serialNumber1 = '000' + serialNumber1 }
            // if (serialNumber1.length == 5) { serialNumber1 = '00' + serialNumber1 }
            // if (serialNumber1.length == 6) { serialNumber1 = '0' + serialNumber1 }

            if (serialNumber1.length == 1) { serialNumber1 = '10000' + serialNumber1 }
            if (serialNumber1.length == 2) { serialNumber1 = '1000' + serialNumber1 }
            if (serialNumber1.length == 3) { serialNumber1 = '100' + serialNumber1 }
            if (serialNumber1.length == 4) { serialNumber1 = '10' + serialNumber1 }
            if (serialNumber1.length == 5) { serialNumber1 = '1' + serialNumber1 }

            var dbQuery;
            if(packname.trim() == 'Limber') { 
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'Front - 5p6s' ORDER BY srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'Rear - 5p21s' ORDER BY srno DESC)
                select * from cte1 union all select * from cte2`;
                // dbQuery=`(SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'Front - 5p6s' ORDER BY srno DESC LIMIT 1) union all
                // (SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'Rear - 5p21s' ORDER BY srno DESC LIMIT 1)`;
            } else if(packname.trim() == 'Kanger 2') {
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 8p8s' ORDER BY srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 8p9s' order by srno DESC),
                cte3 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'C - 8p7s' order by srno DESC)
                select * from cte1 union all select * from cte2 union all select * from cte3`;
//                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'A - 8p8s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'B - 8p9s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'C - 8p7s' ORDER BY srno DESC LIMIT 1)`;
            } else if(packname.trim() == 'Challenger LR') {
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 5p25s' order by srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 5p15s' order by srno DESC)
                select * from cte1 union all select * from cte2`;
//                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'A - 6p6s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'B - 6p9s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'C - 6p10s' ORDER BY srno DESC LIMIT 1)`;
            }
            else if(packname.trim() == 'Challenger MR') {
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 4p25s' order by srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 4p15s' order by srno DESC)
                select * from cte1 union all select * from cte2`;
//                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'A - 6p6s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'B - 6p9s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'C - 6p10s' ORDER BY srno DESC LIMIT 1)`;
            }
            else if (packname.trim() == 'NOVA MROPS') {
                dbQuery = `with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 5p12s' order by srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 5p7s' order by srno DESC)
                select * from cte1 union all select * from cte2`;
                //                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'A - 6p6s' ORDER BY srno DESC LIMIT 1) union all
                // (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'B - 6p9s' ORDER BY srno DESC LIMIT 1) union all
                // (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'C - 6p10s' ORDER BY srno DESC LIMIT 1)`;
            }
            else if(packname.trim() == 'Tamor') {
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 1p4s' ORDER BY srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 1p22s' order by srno DESC),
                cte3 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'C - 1p15s' order by srno DESC)
                select * from cte1 union all select * from cte2 union all select * from cte3`;
//                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'A - 8p8s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'B - 8p9s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM createModule WHERE line='1' and moduleName = 'C - 8p7s' ORDER BY srno DESC LIMIT 1)`;
            } 
            else if (packname.trim() == 'NOVA LROPS') {
                dbQuery = `with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 7p17s' order by srno DESC)
                select * from cte1`;
                //                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'A - 6p6s' ORDER BY srno DESC LIMIT 1) union all
                // (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'B - 6p9s' ORDER BY srno DESC LIMIT 1) union all
                // (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='1' and moduleName = 'C - 6p10s' ORDER BY srno DESC LIMIT 1)`;
            }
            else {
                dbQuery=`with
                cte1 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'A - 6p6s' order by srno DESC),
                cte2 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'B - 6p9s' order by srno DESC),
                cte3 as (SELECT top 1 moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = 'C - 6p10s' order by srno DESC)
                select * from cte1 union all select * from cte2 union all select * from cte3`;
//                 dbQuery =`(SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='2' and moduleName = 'A - 6p6s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='2' and moduleName = 'B - 6p9s' ORDER BY srno DESC LIMIT 1) union all
// (SELECT moduleName,moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='2' and moduleName = 'C - 6p10s' ORDER BY srno DESC LIMIT 1)`;
            }
            //console.log('dqQuery getNextPackSerial',dbQuery);
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
        
                request.query(dbQuery, function (err, recordset) {
                    if (err) console.log(err);
                   var result2 = recordset.recordset;
            // dbQuery, function (err2, result2, fields2) {
                socket.emit('setNextPackSerial', serialNumber1, result2);
            });
        });




            
        })();
        
    });

    // Get Next Queued Module
    socket.on('getNextQueueModule', (data)=> {
        var dbQuery=`with
        cte1 as (SELECT distinct module_barcode,battery_pack_name,final_qr_code,moduleNumber,module_name,module_status FROM taco_treceability.taco_treceability.production_count WHERE module_status='running' AND battery_status = 'running' and line='4'),
        cte2 as (SELECT distinct module_barcode,battery_pack_name,final_qr_code,moduleNumber,module_name,module_status FROM taco_treceability.taco_treceability.production_count WHERE module_status='queue' AND battery_status = 'running' and line='4')
        select top 1 * from cte1 union all select top 1 * from cte2`;
        // var dbQuery=`(SELECT distinct module_barcode,battery_pack_name,final_qr_code,moduleNumber,module_name,module_status FROM taco_treceability.production_count WHERE module_status='running' AND battery_status = 'running' and line='1' limit 1) union all
        // (SELECT distinct module_barcode,battery_pack_name,final_qr_code,moduleNumber,module_name,module_status FROM taco_treceability.production_count WHERE module_status='queue' AND battery_status = 'running' and line='1' limit 1)`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
    
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
               var result2 = recordset.recordset;
            // dbQuery, function (err2, result2, fields2) {
                socket.emit('setNextQueueModule', result2);
            });
        });
    });

    function CheckCellForReset(globalRunningModuleBarCodeTemp) {
        console.log("RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR22222222222222222222222222222");
     
        var dqQuery2=`SELECT TOP 1 sr_no FROM taco_treceability.taco_treceability.production_count WHERE cell_qr_code LIKE '03HC%' and module_barcode='${globalRunningModuleBarCodeTemp}' OR cell_qr_code LIKE 'S%' and module_barcode='${globalRunningModuleBarCodeTemp}' OR cell_qr_code LIKE 'nul%' and module_barcode='${globalRunningModuleBarCodeTemp}' OR cell_qr_code LIKE '01TM%' and module_barcode='${globalRunningModuleBarCodeTemp}' OR cell_qr_code LIKE 'CapsLock%' and module_barcode='${globalRunningModuleBarCodeTemp}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dqQuery2, function (err, recordset) {
            if (err) console.log(err);
            //console.log('step 2');
            var result = recordset.recordset;
            for(var i in result) {
                updateCellForReset(result[i].sr_no,globalRunningModuleBarCodeTemp);
            }
            if(result.length == 0) {
                refreshInMemoryData();
                var dqQuery2=`SELECT cell_qr_code FROM taco_treceability.taco_treceability.production_count WHERE Month(date_time_start)=Month(getdate()) and Year(date_time_start)=Year(getdate()) and module_barcode!='${globalRunningModuleBarCodeTemp}'`;

                    request.query(dqQuery2, function (err, recordset) {
                        if (err) console.log(err);
                       var result = recordset.recordset;
                        for(var i in result) {
                            
                        }
                    socket.emit('reloadOCVPage', 'data');
                });     
            // });           
            }
        })
        });
    }
    function updateCellForReset(srno,globalRunningModuleBarCodeTemp) {
        console.log("RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR33333333333333333333333333333333333");
     
        var dbQuery=`update taco_treceability.taco_treceability.production_count set cell_status='incomplete',cell_qr_code='${getNanoSecTime()}' where sr_no='${srno}'`;
        //console.log('resetRunningModule',dbQuery)
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
               //var result = recordset.recordset;
        // dbQuery, function (err2, result2, fields2) {
            CheckCellForReset(globalRunningModuleBarCodeTemp);
            
        });
    });
    }
    // Reset Current Running Module
    socket.on('resetRunningModule', (globalFinalQRCodeStr,globalBatteryPackNameStr,globalRunningModuleBarCode)=> {
        console.log("RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR111111111111111111111111111111");
        CheckCellForReset(globalRunningModuleBarCode);

    });

        // Temp scanned cells
        socket.on('insertScannedCells', (barcode, moduleBarcode,voltage_val,voltageirStr,class_validation_str) => {

            var dbQuery=`insert into taco_treceability.taco_treceability.ocv_scanned_cell(SrNo,cell_barcode,line,voltage_val,kvalue,cell_class) values('NA','${barcode}','4','${voltage_val}','${voltageirStr.split(',')[5]}','${class_validation_str}')`;
            //console.log('insertScannedCells query', dbQuery);
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(dbQuery, function (err, recordset) {
                    if (err) console.log(err);
                   var result = recordset.recordset;
    
            
                request2 = new sql.Request();
                request2.query("select * from taco_treceability.taco_treceability.ocv_scanned_cell where line='4'", function (err2, recordset2) {
                    if (err2) console.log(err);
                   var result2 = recordset2.recordset;
                // "select * from ocv_scanned_cell where line='1'", function (err2, result2, fields2) {
                    request3 = new sql.Request();
                    request3.query(`SELECT sr_no,cell_qr_code,cell_status FROM taco_treceability.taco_treceability.production_count  WHERE module_barcode='${moduleBarcode}'`, function (err3, recordset3) {
                    if (err3) console.log(err3);
                   var result3 = recordset2.recordset;
                    // `SELECT sr_no,cell_qr_code,cell_status FROM taco_treceability.taco_treceability.production_count  WHERE module_barcode='${moduleBarcode}'`, function (err3, result3, fields3) {
                       // console.log('result3:',result3);
                       var interlock_status="ON";
                       var batchinterlock_status="ON";
                       sql.connect(sqlConfig2, function (err) {
                        request = new sql.Request();
                        request.query("SELECT * FROM taco_traceability_admin.dbo.interlock_status WHERE line_name='Line4'", function (err, recordset) {
                            var result33 = recordset.recordset;
                            if(result33.length>0){
                                for (var i in result33) {
                                    interlock_status = result33[i].status;
                                 }
    
                                 request.query("SELECT * FROM taco_treceability.taco_treceability.line1runningBatch WHERE LineName='line4'", function (err, recordset) {
                                    var result331 = recordset.recordset;
                                    if(result331.length>0){
                                        for (var i in result331) {
                                            batchinterlock_status = result331[i].batch_interlock;
                                         }
        
                                        socket.emit('setScannedCells', result2,result3,voltageirStr,interlock_status,batchinterlock_status);
                                    }
                                    else{
                                        socket.emit('setScannedCells', result2,result3,voltageirStr,interlock_status,batchinterlock_status);
                                    }
                                });
    
                                //socket.emit('setScannedCells', result2,result3,voltageirStr,interlock_status);
                            }
                            else{
                                socket.emit('setScannedCells', result2,result3,voltageirStr,interlock_status,batchinterlock_status);
                            }
                        });
                    });
                        //socket.emit('setScannedCells', result2,result3,voltageirStr,interlock_status);
                    });
                    //  socket.emit('setScannedCells', result2);
                });
            });
    
            });
        });
        socket.on('resetScannedCell', () => {
    
            var dbQuery=`delete from taco_treceability.taco_treceability.ocv_scanned_cell where line='4'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(dbQuery, function (err, recordset) {
                    if (err) console.log(err);
                   var result = recordset.recordset;
            

                
            });
        });
    
        });

        // Reset batch table

        socket.on('resetLine1BatchTable', () => {
    
            var dbQuery=`update taco_treceability.taco_treceability.line1runningBatch set allowed_batch2='0',allowed_batch3='0' where LineName='line4'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(dbQuery, function (err, recordset) {
                    if (err) console.log(err);
                   //var result = recordset.recordset;
            
                
            });
        });
    
        });
    
    
    
        socket.on('getScannedCells', (tempModBarcode) => {
    //            `SELECT  FROM taco_treceability.production_count  WHERE module_barcode='${globalRunningModuleBarCode}'`, function (err2, result2, fields2) {
//console.log('check prod module barcode',tempModBarcode)
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query("select * from taco_treceability.taco_treceability.ocv_scanned_cell where line='4'", function (err2, recordset2) {
                    if (err2) console.log(err2);
                var result2 = recordset2.recordset;
            // "select * from ocv_scanned_cell where line='1'", function (err2, result2, fields2) {
                request2 = new sql.Request();
                request2.query(`SELECT sr_no,cell_qr_code,cell_status FROM taco_treceability.taco_treceability.production_count WHERE cell_qr_code like '03HC%' AND module_barcode='${tempModBarcode}'`, function (err3, recordset3) {
                    if (err3) console.log(err3);
                    if(recordset3) {
                        var result3 = recordset3.recordset;
                        // `SELECT sr_no,cell_qr_code,cell_status FROM taco_treceability.taco_treceability.production_count WHERE cell_qr_code like '03HC%' AND module_barcode='${tempModBarcode}'`, function (err3, result3, fields3) {
                        // console.log('result3:',result3);
                            socket.emit('setScannedCells', result2,result3);
                    } else {
                        //socket.emit('setScannedCells', result2,[]);
                    }
                
                });
                //  socket.emit('setScannedCells', result2);
            });
        });
    
        });
    
    // socket.on('changePrintStatus', (battery_qrcode,packNameId,moduleName) => {
    //     var sqlQry = `UPDATE taco_treceability.taco_treceability.station_status SET ModulePrintStatus = 'OK' WHERE ModuleBarcode = '${battery_qrcode}'`;//
    //     sql.connect(sqlConfig, function (err) {
    //         request = new sql.Request();
    //         request.query(sqlQry, function (err, recordset2) {
    //             if (err) console.log(err);
    //         //var result = recordset2.recordset;
        
    //         //console.log('sql queryyy',sql)
    //         resolve();
    //         // console.log(result.affectedRows + " record(s) updated");
    //     });
    // });
    // });
    socket.on('changePrintStatus', (battery_qrcode,packNameId,moduleName) => {
        console.log("RRRRRRRRRRRRRRRRRRRRRDDDDDDDDDDDDDDDDDDDDDD111111111111111111");
     
        var sqlQry = `UPDATE taco_treceability.taco_treceability.station_status SET ModulePrintStatus = 'OK' WHERE ModuleBarcode = '${battery_qrcode}'`;//
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(sqlQry, function (err, recordset2) {
                if (err) console.log(err);
            //var result = recordset2.recordset;
        
            request.query("DELETE FROM taco_treceability.taco_treceability.ocv_machine_data where used_on_line='line_4'", function (err, recordset2) {
                if (err) console.log(err);
            
            //console.log('sql queryyy',sql)
            resolve();
            
            
            });

            // request.query("DELETE FROM taco_treceability.taco_treceability.ocv_machine_data_threedays where used_on_line='line_4'", function (err, recordset2) {
            //     if (err) console.log(err);
            
            
            // });
            //console.log('sql queryyy',sql)
            // resolve();
            // console.log(result.affectedRows + " record(s) updated");
        });
    });
    });
    function autoPrintModuleCode(battery_qrcode,packNameId,moduleName,socket){
       
            //console.log('battery_qrcode,packNameId,moduleNamerrrrrrrrrrr',battery_qrcode,packNameId,moduleName)
                    
                 
                    var packIdNum=parseInt(packNameId);
                  
                    var data = `{D0180,0601,0150|}
                     {AY;+06,0|}
                     {C|}
                     {XB00;0048,0023,T,L,04,A,0,M2=${battery_qrcode}|}
                     {XB01;0201,0025,A,3,01,0,0071,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
                     {PV00;0179,0123,0021,0021,B,00,B=${battery_qrcode}|}
                     {XS;I,0001,0002C3200|}
                     {D0176,0615,0156|}
                     {AY;+06,0|}
                     {C|}
                     {PV00;0238,0064,0049,0049,B,00,B=${packIdNum}|}
                     {PV01;0086,0131,0049,0049,B,00,B=MODULE-${moduleName}|}
                     {XS;I,0001,0002C3200|}`;
                    
            
                    // After printer setting - current prn
                    var data2=`{D0180,0601,0150|}
                    {AY;+06,0|}
                    {C|}
                    {PC000;0238,0050,05,05,I,00,B=${packNameId}|}
                    {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
                    {XS;I,0001,0002C3200|}
                    `;
            
                    fs.writeFile("prn_data/barcode.prn", data, (err) => {
                        if (err)
                            console.log(err);
                        else {
                            console.log("File written successfully\n");
                            nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\SQL\\TACO-Treceability_Line4_Challenger_Dynamic\\prn_data\\barcode.prn "10.9.4.91" LPT1`).then(
                                function (existCodes) {
                                    console.log('Command executed successfully!');
                                    socket.emit('autoBarcodePrinted',battery_qrcode,packNameId,moduleName);
                                }, function (err) {
                                    console.log('Command failed to execute!');
                                }
                            );
            
                         
                            
                        }
                    });
            
            
            

    }
    socket.on('printBarCode', (battery_qrcode,packNameId,moduleName) => {
        //console.log('battery_qrcode,packNameId,moduleNamerrrrrrrrrrr',battery_qrcode,packNameId,moduleName)
        
        // var data = `{D0165,0601,0145|}
        // {C|}
        // {XB00;0025,0024,T,L,03,A,0,M2=${battery_qrcode}|}
        // {XB01;0121,0025,A,3,01,0,0060,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
        // {PV00;0133,0105,0020,0020,B,00,B=${battery_qrcode}|}
        // {XS;I,0001,0000C4000|}
        // `;
        
        // var data=`{D0420,0801,0400|}
        // {C|}
        // {XB00;0066,0131,T,L,04,A,0,M2=${battery_qrcode}|}
        // {XB01;0226,0135,A,3,02,0,0093,+0000000000,000,0,00=>6DJ>51828>6-ABC0>5000001|}
        // {PV00;0286,0261,0031,0031,B,00,B=${battery_qrcode}|}
        // {XS;I,0001,0000C4000|}`;

        // var data =`{D0170,0601,0150|}
        // {C|}
        // {XB00;0048,0040,T,L,04,A,0,M2=${battery_qrcode}|}
        // {XB01;0201,0041,A,3,01,0,0071,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
        // {PV00;0179,0139,0021,0021,B,00,B=${battery_qrcode}|}
        // {XS;I,0001,0000C4000|}
        // `;
        // After printer setting - current prn
        var packIdNum=parseInt(packNameId);
        // var data = `{D0180,0601,0150|}
        //  {AY;+06,0|}
        //  {C|}
        //  {XB00;0048,0023,T,L,04,A,0,M2=${battery_qrcode}|}
        //  {XB01;0201,0025,A,3,01,0,0071,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
        //  {PV00;0179,0123,0021,0021,B,00,B=${battery_qrcode}|}
        //  {XS;I,0001,0002C3200|}
        //  {D0180,0601,0150|}
        // {AY;+06,0|}
        // {C|}
        // {PC000;0238,0050,05,05,I,00,B=${packIdNum}|}
        // {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
        // {XS;I,0001,0002C3200|}`;
        var data = `{D0180,0601,0150|}
         {AY;+06,0|}
         {C|}
         {XB00;0048,0023,T,L,04,A,0,M2=${battery_qrcode}|}
         {XB01;0201,0025,A,3,01,0,0071,+0000000000,000,0,00=>501>6${battery_qrcode.substring(2,6)}>4${battery_qrcode.substring(6,13)}>6${battery_qrcode.substring(12,18)}>5${battery_qrcode.substring(battery_qrcode.length - 6)}|}
         {PV00;0179,0123,0021,0021,B,00,B=${battery_qrcode}|}
         {XS;I,0001,0002C3200|}
         {D0176,0615,0156|}
         {AY;+06,0|}
         {C|}
         {PV00;0238,0064,0049,0049,B,00,B=${packIdNum}|}
         {PV01;0086,0131,0049,0049,B,00,B=MODULE-${moduleName}|}
         {XS;I,0001,0002C3200|}`;
        

         
        // var data2 = `{D0165,0601,0145|}
        // {C|}
        // {PV00;0133,0105,0020,0020,B,00,B=${battery_qrcode}|}
        // {PC000;0193,0026,05,05,G,00,B=${packNameId}|
        // {PC001;0193,0075,05,05,G,00,B=Module-${moduleName}|
        // {XS;I,0001,0000C4000|}`;

        // var data2=`{D0180,0601,0150|}
        // {AY;+05,0|}
        // {C|}
        // {PC000;0238,0050,05,05,I,00,B=${packNameId}|}
        // {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
        // {XS;I,0001,0002C3200|}
        // `;

        // After printer setting - current prn
        var data2=`{D0180,0601,0150|}
        {AY;+06,0|}
        {C|}
        {PC000;0238,0050,05,05,I,00,B=${packNameId}|}
        {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
        {XS;I,0001,0002C3200|}
        `;

        fs.writeFile("prn_data/barcode.prn", data, (err) => {
            if (err)
                console.log(err);
            else {
                //console.log("File written successfully\n");
                nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\SQL\\TACO-Treceability_Line4_Challenger_Dynamic\\prn_data\\barcode.prn "10.9.4.91" LPT1`).then(
                    function (existCodes) {
                        //console.log('Command executed successfully!');
                    }, function (err) {
                        //console.log('Command failed to execute!');
                    }
                );

                // fs.writeFile("prn_data/barcode_packname.prn", data2, (err) => {
                //     if (err)
                //         console.log(err);
                //     else {
                //         console.log("File written successfully\n");


                //         //setTimeout(() => {
                //             nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\TACO-Treceability\\prn_data\\barcode.prn "10.9.4.91" LPT1`).then(
                //                 function (existCodes) {
                //                     console.log('Command executed successfully!');
                //                 }, function (err) {
                //                     console.log('Command failed to execute!');
                //                 }
                //             );
                //         //}, 3000);

                //         setTimeout(() => {
                //             nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\TACO-Treceability\\prn_data\\barcode_packname.prn "10.9.4.91" LPT1`).then(
                //                 function (existCodes) {
                //                     console.log('Command executed successfully!');
                //                 }, function (err) {
                //                     console.log('Command failed to execute!');
                //                 }
                //             );
                //         }, 10000);

                //     }
                // });
                //   console.log("The written has the following contents:");
                //   console.log(fs.readFileSync("books.txt", "utf8"));

                
            }
        });



    });

    // Temp Page Code Start 
    socket.on('printBarCodeModuleTempPage', (packName,module_type,serial_number) => {

        var Vendorcode = '01T';
        var ProductType = 'M';
        var BatteryType = 'B';
        var moduleName = '02E';
        var batchCode = '2';
        var ExtensionCode = '000';
        var ProdLineCode = '2';
        // var ProdLineCode = '4';
        var ProdAddress = '4';  // line code
        var DateStr = '';
        var FeatureCode = '0';
        /*if(current_shift == 1){
                ProdAddress = 'A';
        }
        else if(current_shift == 2){
                ProdAddress = 'B';
        }
        else if(current_shift == 3){
                ProdAddress = 'C';
        }*/
        if(packName=="Kanger 1 AIO" || packName=="Kanger 1 Gen 3") {
            if(module_type=="6p6s") {
                moduleName = "016";
            } else if(module_type=="6p9s") {
                moduleName = "017";
            } else if(module_type=="6p10s") {
                moduleName = "018";
            }
        } else if(packName=="Kanger 2" ) {
            if(module_type=="8p8s") {
                moduleName = "03L";
            } else if(module_type=="8p9s") {
                moduleName = "03M";
            } else if(module_type=="8p7s") {
                moduleName = "03P";
            }
        } else if(packName=="Limber" ) {
            if(module_type=="5p6s") {
                moduleName = "02D";
            } else if(module_type=="5p21s") {
                moduleName = "02E";
            }
        }

                                        
        var currentModuleSerialNumber = serial_number;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber = currentModuleSerialNumber.toString();
        if (serialNumber.length == 1) { serialNumber = '10000' + serialNumber.toString() }
        if (serialNumber.length == 2) { serialNumber = '1000' + serialNumber.toString() }
        if (serialNumber.length == 3) { serialNumber = '100' + serialNumber.toString() }
        if (serialNumber.length == 4) { serialNumber = '10' + serialNumber.toString() }
        if (serialNumber.length == 5) { serialNumber = '1' + serialNumber.toString() }
                                        
        var Systemyear = parseInt(new Date().getFullYear());
        var SystemMonth = parseInt(new Date().getMonth() + 1);
        var SystemDate = parseInt(new Date().getDate());


        if (Systemyear == '2021') { Year = 'B' } if (Systemyear == '2022') { Year = 'C' } if (Systemyear == '2023') { Year = 'D' } if (Systemyear == '2024') { Year = 'E' } if (Systemyear == '2025') { Year = 'G' } if (Systemyear == '2026') { Year = 'H' }
        if (SystemMonth == 1) { Month = '1'; } if (SystemMonth == 2) { Month = '2'; } if (SystemMonth == 3) { Month = '3'; } if (SystemMonth == 4) { Month = '4'; } if (SystemMonth == 5) { Month = '5'; } if (SystemMonth == 6) { Month = '6'; } if (SystemMonth == 7) { Month = '7'; } if (SystemMonth == 8) { Month = '8'; } if (SystemMonth == 9) { Month = '9'; } if (SystemMonth == 10) { Month = 'A'; } if (SystemMonth == 11) { Month = 'B'; } if (SystemMonth == 12) { Month = 'C'; }
        if (SystemDate == 1) { DateStr = '1'; } if (SystemDate == 2) { DateStr = '2'; } if (SystemDate == 3) { DateStr = 3; } if (SystemDate == 4) { DateStr = '4'; } if (SystemDate == 5) { DateStr = '5'; } if (SystemDate == 6) { DateStr = '6'; } if (SystemDate == 7) { DateStr = '7'; } if (SystemDate == 8) { DateStr = '8'; } if (SystemDate == 9) { DateStr = '9'; } if (SystemDate == '10') { DateStr = 'A'; } if (SystemDate == 11) { DateStr = 'B'; } if (SystemDate == 12) { DateStr = 'C'; } if (SystemDate == 13) { DateStr = 'D'; } if (SystemDate == 14) { DateStr = 'E'; } if (SystemDate == 15) { DateStr = 'F'; } if (SystemDate == 16) { DateStr = 'G'; } if (SystemDate == 17) { DateStr = 'H'; } if (SystemDate == 18) { DateStr = 'J'; } if (SystemDate == 19) { DateStr = 'K'; } if (SystemDate == 20) { DateStr = 'L'; } if (SystemDate == 21) { DateStr = 'M'; } if (SystemDate == 22) { DateStr = 'N'; } if (SystemDate == 23) { DateStr = 'P'; } if (SystemDate == 24) { DateStr = 'R'; } if (SystemDate == 25) { DateStr = 'S'; } if (SystemDate == 26) { DateStr = 'T'; } if (SystemDate == 27) { DateStr = 'V'; } if (SystemDate == 28) { DateStr = 'W'; } if (SystemDate == 29) { DateStr = 'X'; } if (SystemDate == 30) { DateStr = 'Y'; } if (SystemDate == 31) { DateStr = '0'; }

        var MODULEBARCODE = Vendorcode + ProductType + BatteryType  + moduleName + batchCode + ExtensionCode + ProdLineCode + ProdAddress + Year + Month + DateStr + FeatureCode + serialNumber;

        // var data =`{D0170,0601,0150|}
        // {C|}
        // {XB00;0048,0040,T,L,04,A,0,M2=${MODULEBARCODE}|}
        // {XB01;0201,0041,A,3,01,0,0071,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
        // {PV00;0179,0139,0021,0021,B,00,B=${MODULEBARCODE}|}
        // {XS;I,0001,0000C4000|}
        // `;

         // After printer setting - current prn
         var data = `{D0180,0601,0150|}
         {AY;+06,0|}
         {C|}
         {XB00;0048,0023,T,L,04,A,0,M2=${MODULEBARCODE}|}
         {XB01;0201,0025,A,3,01,0,0071,+0000000000,000,0,00=>501>6TMC0>5170000>6AAC1M0>5000385|}
         {PV00;0179,0123,0021,0021,B,00,B=${MODULEBARCODE}|}
         {XS;I,0001,0002C3200|}`;

        fs.writeFile("prn_data/barcode_temp.prn", data, (err) => {
            if (err)
                console.log(err);
            else {
                //console.log("File written successfully\n");

                setTimeout(() => {
                    nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\SQL\\TACO-Treceability_Line4_Challenger_Dynamic\\prn_data\\barcode_temp.prn "10.9.4.91" LPT1`).then(
                        function (existCodes) {
                            //console.log('Command executed successfully - Barcode: '+MODULEBARCODE);
                        }, function (err) {
                            //console.log('Command failed to execute!');
                        }
                    );
                }, 5000);
            }
        });



    });

    socket.on('printBarCodePackTempPage', (packNameId,moduleName) => {

        
        // var data2=`{D0180,0601,0150|}
        // {AY;+05,0|}
        // {C|}
        // {PC000;0238,0050,05,05,I,00,B=${packNameId}|}
        // {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
        // {XS;I,0001,0002C3200|}
        // `;

        // After printer setting - current prn
        var data2=`{D0180,0601,0150|}
        {AY;+06,0|}
        {C|}
        {PC000;0238,0050,05,05,I,00,B=${packNameId}|}
        {PC001;0198,0116,05,05,I,00,B=Module-${moduleName}|}
        {XS;I,0001,0002C3200|}
        `;
        fs.writeFile("prn_data/barcode_packname_temp.prn", data2, (err) => {
            if (err)
                console.log(err);
            else {
                //console.log("File written successfully\n");

                setTimeout(() => {
                    nrc.run(`"C:\\Program Files (x86)\\Printfil\\Printfil.exe" C:\\Project\\EV_Battery_MIS\\SQL\\TACO-Treceability_Line4_Challenger_Dynamic\\prn_data\\barcode_packname_temp.prn "10.9.4.91" LPT1`).then(
                        function (existCodes) {
                            //console.log('Command executed successfully - Packname!');
                        }, function (err) {
                            //console.log('Command failed to execute!');
                        }
                    );
                }, 1000);

            }
        });

    });

    // Temp Page Code End

    ////Section 1... get welding data
    socket.on('getCurrentWeldData', (packQR) => {
        ///connect to database for details of modules 
        //console.log('step1', packQR);
        var resp = getWeldDataNow(packQR);

    });
    async function getWeldDataNow(packQR) {
        //console.log('pack1',packQR)
        var runningPackWeldDATA = await getWeldingDetails(packQR); //completed weldings
        //console.log('pack2',packQR)
        var getTotalModuleWelding = await getWeldingTotalModuleDetails(packQR);
        //console.log('pack3',packQR)
        var totalOCVreadyModules = await totocvmmod();

        var remainingModules =  await remainingModules2(packQR);

        socket.emit('current_weld_data', runningPackWeldDATA, getTotalModuleWelding,totalOCVreadyModules,remainingModules);

    }
    function remainingModules2(packQR) {
        //console.log(packQR,'dwwwewewew')
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT *  FROM taco_treceability.taco_treceability.station_status WHERE Welding_status ='NOT OK' AND  FinalQRCode ='${packQR[0].FinalQRCode}'`, function (err, recordset) {
                    if (err) console.log(err);
                var result = recordset.recordset;
            // `SELECT *  FROM taco_treceability.station_status WHERE Welding_status ='NOT OK' AND  FinalQRCode ='${packQR[0].FinalQRCode}';`, function (err, recordset) {
                // console.log('step 3',result,`SELECT *  FROM taco_treceability.station_status WHERE FinalQRCode ='${packQR[0].FinalQRCode}' ;`);
                resolve(result);
            });
        });
        })
    }
    function getWeldingTotalModuleDetails(packQR) {
        //console.log(packQR,'dwwwewewew')
        return new Promise((resolve, reject) => {
            var sqlQry = `SELECT DISTINCT module_barcode,module_name FROM taco_treceability.taco_treceability.production_count_archive_compress WHERE final_qr_code ='${packQR[0].FinalQRCode}' `;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT DISTINCT module_barcode,module_name FROM taco_treceability.taco_treceability.production_count_archive_compress WHERE final_qr_code ='${packQR[0].FinalQRCode}'`, function (err, recordset) {
                    if (err) console.log(err);
                var result = recordset.recordset;
            // `SELECT DISTINCT module_barcode,module_name FROM taco_treceability.production_count WHERE final_qr_code ='${packQR[0].FinalQRCode}' ;`, function (err, recordset) {
                //console.log('step 2',result,'sql',sql);
                resolve(result);
            });
        });
        })
    }
    function getWeldingDetails(packQR) {
        //console.log("qweqweqweqwdenjnjbvjdfbvjdfnjvjdfjvnjdfnjv",packQR)
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT *  FROM taco_treceability.taco_treceability.station_status WHERE FinalQRCode ='${packQR[0].FinalQRCode}'`, function (err, recordset) {
                   if (err) console.log(err)
                   var result=recordset.recordset;
            // `SELECT *  FROM taco_treceability.station_status WHERE FinalQRCode ='${packQR[0].FinalQRCode}' ;`, function (err, recordset) {
                // if (err) console.log(err);
                // console.log('step 3',result,`SELECT *  FROM taco_treceability.station_status WHERE FinalQRCode ='${packQR[0].FinalQRCode}' ;`);
                resolve(result);
            });
        });
        })
    }
    function totocvmmod() {
        //console.log("qweqweqweqwdenjnjbvjdfbvjdfnjvjdfjvnjdfnjv",packQR)
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT *  FROM taco_treceability.taco_treceability.station_status WHERE Welding_status ='NOT OK'`, function (err, recordset2) {
                    if (err) console.log(err);
                var result = recordset2.recordset;
            // `SELECT *  FROM taco_treceability.station_status WHERE Welding_status ='NOT OK' ;`, function (err, recordset) {
                // if (err) console.log(err);
                // console.log('step 3',result,`SELECT *  FROM taco_treceability.station_status WHERE FinalQRCode ='${packQR[0].FinalQRCode}' ;`);
                resolve(result);
            });
        });
        })
    }
    ////////////// scan received from welding page //////////// Static testing for welding fixed welding
    socket.on('WeldingQRScanncode', (Modulebarcode) => {
        //console.log('barcode', Modulebarcode);
        WeldingQRscanned(Modulebarcode);//Modulebarcode 01TPC017000AAC170000330

    });

    async function WeldingQRscanned(Modulebarcode) {
        var weldPackQR = await weldingQRPackSearch(Modulebarcode);
        //console.log("here is pack",weldPackQR,'pdating module',Modulebarcode)
        var tempinser = await weldingQRscannEntry(Modulebarcode);
        io.emit('testWelDdata', weldPackQR)
    }
    function weldingQRPackSearch(Modulebarcode) {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT FinalQRCode FROM taco_treceability.taco_treceability.station_status WHERE ModuleBarcode ='${Modulebarcode}'`, function (err, recordset2) {
                    if (err) console.log(err);
                    var result = recordset2.recordset;
            // `SELECT FinalQRCode FROM taco_treceability.station_status WHERE ModuleBarcode ='${Modulebarcode}' ;`, function (err, recordset) {
               // if (err) console.log(err);
                //console.log('step 2');
                resolve(result);
            });
        });
        });
    }
    function weldingQRscannEntry(Modulebarcode) {
        return new Promise((resolve, reject) => {
            var sqlQry = `UPDATE taco_treceability.taco_treceability.station_status SET Welding_status = 'OK' WHERE ModuleBarcode = '${Modulebarcode}'`;//
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sqlQry, function (err, recordset2) {
                    if (err) console.log(err);
                    //var result = recordset2.recordset;
            
                // if (err) console.log(err);
                //console.log('sql queryyy',sql)
                resolve();
                // console.log(result.affectedRows + " record(s) updated");
            });
        });
        })
    }
    function checkScanStatuss() {
        return new Promise((resolve, reject) => {
            var sqlQry = `SELECT * FROM taco_treceability.taco_treceability.station_status WHERE line='4' and ModulePrintStatus = 'NOT OK'`;//
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sqlQry, function (err, recordset2) {
                    if (err) console.log(err);
                    var result = recordset2.recordset;
            
                // if (err) console.log(err);
                //console.log('sql hhhhhhhhhhhhhhhhhhhhhhhhhh')
                resolve(result.length);
                // console.log(result.affectedRows + " record(s) updated");
            });
        });

        })
    }
    async function checkAllPrinted(barcode,tepC) {
        //console.log('checkAllPrinted--------->', barcode);

       // var checkScanStatus = await checkScanStatuss();
        socket.emit('decideScanning', globalStation_status_Flag,barcode,tepC);

    }
    String.prototype.replaceAt = function(index, replacement) {
        if (index >= this.length) {
            return this.valueOf();
        }
     
        return this.substring(0, index) + replacement + this.substring(index + 1);
    }
     
    function updateModuleNewBatchEntry(globalUsedBatches, batchName,globalRunningModuleBarCode) {
        
        return new Promise((resolve, reject) => {
            if(parseInt(globalUsedBatches) == 1) {
                var sqlQry=`update line1runningBatch set allowed_batch2='${batchName}' where LineName='line4';`;  //line1runningBatch
                var str = globalRunningModuleBarCode.toString();
                str = str.replaceAt(8, '2');
                //console.log(str);
                var newModuleBarcode=str;
                var sql2=`update taco_treceability.taco_treceability.production_count set module_barcode='${newModuleBarcode}' where module_barcode='${globalRunningModuleBarCode}'`; //production_count
                var sql3=`update taco_treceability.taco_treceability.battery_details set module_barcode_string='${newModuleBarcode}' where module_barcode_string='${globalRunningModuleBarCode}';`; //battery_details
                var sql4=`update taco_treceability.taco_treceability.station_status set ModuleBarcode='${newModuleBarcode}' where ModuleBarcode='${globalRunningModuleBarCode}';`; //station_status
                var sql5=`update taco_treceability.taco_treceability.test_cell_table set module_barcode='${newModuleBarcode}' where module_barcode='${globalRunningModuleBarCode}';`; //test_cell_table
                var sql6=`update taco_treceability.taco_treceability.total_module_count set module_id='${newModuleBarcode}' where module_id='${globalRunningModuleBarCode}';`; //total_module_count
                
                sql.connect(sqlConfig, function (err) {
                    request = new sql.Request();
                    request.query(sqlQry, function (err, recordset) {
                        if (err) console.log(err);
                        //var result = recordset.recordset;
                
                    // if (err) console.log(err);
                    request2 = new sql.Request();
                    request2.query(sql2, function (err2, recordset2) {
                        if (err2) console.log(err2);
                        //var result2 = recordset2.recordset;
                    // sql2, function (err2, result2) {
                        // if (err2) console.log(err2);
                        request3 = new sql.Request();
                        request3.query(sql3, function (err3, recordset3) {
                            if (err3) console.log(err3);
                            //var result3 = recordset3.recordset;
                        // sql3, function (err3, result3) {
                            // if (err3) console.log(err3);
                            request4 = new sql.Request();
                            request4.query(sql4, function (err4, recordset4) {
                                if (err4) console.log(err4);
                                //var result4 = recordset4.recordset;
                            // sql4, function (err4, result4) {
                                // if (err4) console.log(err4);
                                request5 = new sql.Request();
                                request5.query(sql5, function (err5, recordset5) {
                                    if (err5) console.log(err5);
                                    //var result5 = recordset5.recordset;
                                // sql5, function (err5, result5) {
                                    // if (err5) console.log(err5);
                                    request6 = new sql.Request();
                                    request6.query(sql6, function (err6, recordset6) {
                                        if (err6) console.log(err6);
                                        //var result6 = recordset6.recordset;
                                    // sql6, function (err6, result6) {
                                        // if (err6) console.log(err6);
                                        //console.log('Module barcode update successfull - ', new Date());
                                        resolve();
                                    });
                                });
                            });
                        });
                    });
                });
            });
            } else if(parseInt(globalUsedBatches) == 2) { 
                var sqlQry=`update line1runningBatch set allowed_batch3='${batchName}' where LineName='line4';`;  //line1runningBatch
                var str = globalRunningModuleBarCode.toString();
                str = str.replaceAt(8, '3');
                //console.log(str);
                var newModuleBarcode=str;
                var sql2=`update taco_treceability.taco_treceability.production_count set module_barcode='${newModuleBarcode}' where module_barcode='${globalRunningModuleBarCode}'`; //production_count
                var sql3=`update taco_treceability.taco_treceability.battery_details set module_barcode_string='${newModuleBarcode}' where module_barcode_string='${globalRunningModuleBarCode}';`; //battery_details
                var sql4=`update taco_treceability.taco_treceability.station_status set ModuleBarcode='${newModuleBarcode}' where ModuleBarcode='${globalRunningModuleBarCode}';`; //station_status
                var sql5=`update taco_treceability.taco_treceability.test_cell_table set module_barcode='${newModuleBarcode}' where module_barcode='${globalRunningModuleBarCode}';`; //test_cell_table
                var sql6=`update taco_treceability.taco_treceability.total_module_count set module_id='${newModuleBarcode}' where module_id='${globalRunningModuleBarCode}';`; //total_module_count
                
                sql.connect(sqlConfig, function (err) {
                    request = new sql.Request();
                    request.query(sqlQry, function (err, recordset) {
                        if (err) console.log(err);
                        //var result = recordset.recordset;
                
                    // if (err) console.log(err);
                    request2 = new sql.Request();
                    request2.query(sql2, function (err2, recordset2) {
                        if (err2) console.log(err2);
                        //var result2 = recordset2.recordset;
                    // sql2, function (err2, result2) {
                        // if (err2) console.log(err2);
                        request3 = new sql.Request();
                        request3.query(sql3, function (err3, recordset3) {
                            if (err3) console.log(err3);
                            //var result3 = recordset3.recordset;
                        // sql3, function (err3, result3) {
                            // if (err3) console.log(err3);
                            request4 = new sql.Request();
                            request4.query(sql4, function (err4, recordset4) {
                                if (err4) console.log(err4);
                                //var result4 = recordset4.recordset;
                            // sql4, function (err4, result4) {
                                // if (err4) console.log(err4);
                                request5 = new sql.Request();
                                request5.query(sql5, function (err5, recordset5) {
                                    if (err5) console.log(err5);
                                    //var result5 = recordset5.recordset;
                                // sql5, function (err5, result5) {
                                    // if (err5) console.log(err5);
                                    request6 = new sql.Request();
                                    request6.query(sql6, function (err6, recordset6) {
                                        if (err6) console.log(err6);
                                        //var result6 = recordset6.recordset;
                
                //     if (err) console.log(err);
                //     sql2, function (err2, result2) {
                //         if (err2) console.log(err2);
                //         sql3, function (err3, result3) {
                //             if (err3) console.log(err3);
                //             sql4, function (err4, result4) {
                //                 if (err4) console.log(err4);
                //                 sql5, function (err5, result5) {
                //                     if (err5) console.log(err5);
                //                     sql6, function (err6, result6) {
                //                         if (err6) console.log(err6);
                                        //console.log('Module barcode update successfull - ', new Date());
                                        resolve();
                                    });
                                });
                            });
                        });
                    });
                });
            });
            }
        });
    }
    socket.on('checkScanStatus', (barcode, globalSelectedScannedId, status, globalUsedBatches,batchName,globalRunningModuleBarCode,tepC) => {
       
        //console.log('checkScanStatus------>>>>',barcode);
        // if(globalSelectedScannedId != '') {
            
        //     checkAllPrinted(barcode);
        //     //updateScannedID(globalSelectedScannedId,barcode,socket);
        // } else {
        //     checkAllPrinted(barcode);
        // }
        if(status == '0') {
            checkAllPrinted(barcode,tepC);
        } else if(status == '1') {
            checkAllPrinted(barcode,tepC);
            updateModuleNewBatchEntry(globalUsedBatches.length,batchName,globalRunningModuleBarCode);   
        }
        

//console.log('rrrrrrrrrrrrrrrrrrrrrrrrrrrrr')
        // (async function main() {
            

        //     var checkScanStatus = await checkScanStatuss();
       
        // socket.emit('decideScanning', checkScanStatus)
        // })();
        //checkAllPrinted(barcode);

    });
    socket.on('updateOCVScannedDATA', (barcode, globalSelectedScannedId,oldQRCode) => {
        //console.log('updateOCVScannedDATA',barcode, globalSelectedScannedId,oldQRCode);
    updateScannedID(globalSelectedScannedId,barcode,socket,oldQRCode);

});

socket.on('Recheck', (barcode,voltageirStr) => {
    check_with_prod_count(barcode,voltageirStr);
});
async function check_with_prod_count(barcode,voltageirStr){
    ////////////////////////////////new code 18 jan 2024 start ///////////
    var temp_resultsss=false;
    // var temp_resultsss=  await checking_vs_prod_count(barcode);
    var batch_validation = await getBatchval(barcode);
    if(batch_validation=='Valid Batch'){
         temp_resultsss=  await runCrossCheckCellQR(barcode);
    }
    else{
        temp_resultsss=true;
    }
  
    ////////////////////////////////new code 18 jan 2024 end ///////////
   // var temp_resultsss=  await runCrossCheckCellQR(barcode);
   // console.log('recheck',barcode)
    if(temp_resultsss == true){
       // console.log('recheck2',barcode)
        callingDuplicate('',barcode,'re-checked-dupli');
    }
    else{
       // cellQRscanned(barcode, '',4,voltageirStr); need to add interlock off check
      //  console.log('recheck3',barcode)
    }  
   }

function checking_vs_prod_count(barcode){
    globalProduction_count_array =[];
    return new Promise((resolve, reject) => {
        var sqlQry = `SELECT * FROM taco_treceability.taco_treceability.production_count WHERE line='4' and cell_qr_code like '03HC%'`;//
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(sqlQry, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
            
            //     if (err) console.log(err);
                for( var i in result){
                    globalProduction_count_array.push(result[i].cell_qr_code);
                }
                if(globalProduction_count_array.includes(barcode)){
                    resolve(true);
                }else{
                    resolve(false);
                }
            
                // console.log(result.affectedRows + " record(s) updated");
            });
        });
    })
    
}
socket.on('CellQRScanncode', (barcode, globalSelectedScannedId,tepC,voltageirStr) => {
    //  console.log('barcode------->>>>>>>>>>>>', barcode,voltageirStr);
      cellQRscanned(barcode, globalSelectedScannedId,tepC,voltageirStr);
  
  });

    socket.on('bufferCellQRScanncode', (barcodeArray, globalSelectedScannedId,tepC) => {
        //console.log('barcode', barcode);
        processBufferData(barcodeArray,globalSelectedScannedId,tepC);
    });
    async function processBufferData(barcodeArray,globalSelectedScannedId,tepC) {
        await Promise.all(barcodeArray.map(async (barcode) => {
            await bufferCellQRscanned(barcode, globalSelectedScannedId,tepC);
        }))
    }

    function callingDuplicate(globalSelectedScannedId,barcode,tepC) {
        //console.log('duplicate called');
        socket.emit('duplicate', globalSelectedScannedId,barcode,tepC);

    }
    function updateScannedID(sr_no,barcode,socket,oldQRCode) {
        var recordSrno;
        if(sr_no!='') {

            var check_srno =`SELECT * FROM taco_treceability.taco_treceability.ocv_scanned_cell where cell_barcode='${oldQRCode}' OR cell_barcode='ScanAgain-${oldQRCode}'`;
            //console.log('updateScannedID:',sql);
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(check_srno, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                    if(result.length>0) {
                        recordSrno=result[0].sr_no;
                        var sqlQry =`update taco_treceability.taco_treceability.ocv_scanned_cell set cell_barcode='${barcode}' where sr_no=${recordSrno}`;
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err2, recordset2) {
                            if (err2) console.log(err2);
                            //var result2 = recordset2.recordset;
                        socket.emit('resetScanId','data');
                        });
                    }
                //socket.emit('resetScanId','data');
                });
            });
        }
        
    }
    async function bufferCellQRscanned(barcode, globalSelectedScannedId,tepC) {
        return new Promise(async (resolve, reject) => {
        var checkDuplicate = await runCrossCheckCellQR(barcode);
        io.emit('testdata', 'msg')
        //console.log('checkDuplicate',checkDuplicate)
        //var fer = 0;
        // 01TMB03P000011C1M7000022
         //var fer = parseInt(checkDuplicate);
        /////////Duplicate Repeat Disable Enable///// st fer = 0; to disable and parseInt to enable
        var fer2 = 0;
        // if (fer > fer2) {
        if (checkDuplicate == true) {
            //console.log('duplicate')

            callingDuplicate(globalSelectedScannedId,barcode,tepC);
            resolve();
        }
        else {
         //   updateScannedID(globalSelectedScannedId,barcode,io);
            socket.emit('ok_scann', barcode, globalSelectedScannedId);

            var voltage_ir_val = await getVoltageIrVal(barcode);
            // var voltage_ir_val='NOT_FOUND';

            
            var tempRes = await cellQRscannEntry();
            var result_srno = tempRes[0].sr_no;
            var result_rownum = tempRes[0].rownum;
            var result_module_name = tempRes[0].module_name;
            var result_module_barcode = tempRes[0].module_barcode;
            var result_module_number = tempRes[0].moduleNumber;
            var result_packQRCODE = tempRes[0].final_qr_code;
            var printPackNo = result_packQRCODE.substring(10,).replace(/^0+/, '');

            var modulenamesder ;
               if(tempRes[0].battery_pack_name == 'Kanger 1 AIO' || tempRes[0].battery_pack_name == 'Kanger 1 Gen 3'){
                if(result_module_number == '1'){
                    modulenamesder = 'A1 (+)';
                }
              
                else if(result_module_number == '2'){
                    modulenamesder = 'A2 (-)';
                }
                else if(result_module_number == '3'){
                    modulenamesder = 'A3 (+)';
                }
                else if(result_module_number == '4'){
                    modulenamesder = 'A4 (-)';
                }
                else if(result_module_number == '5'){
                    modulenamesder = 'A5 (+)';
                }
                else if(result_module_number == '6'){
                    modulenamesder = 'A6 (-)';
                }
                else if(result_module_number == '7'){
                    modulenamesder = 'A7 (+)';
                }
                else if(result_module_number == '8'){
                    modulenamesder = 'B8 (-)';
                }
                else if(result_module_number == '9'){
                    modulenamesder = 'B13 (+)';
                }
                else if(result_module_number == '10'){
                    modulenamesder = 'C9 (+)';
                }
                else if(result_module_number == '11'){
                    modulenamesder = 'C10 (-)';
                }
                else if(result_module_number == '12'){
                    modulenamesder = 'C11 (+)';
                }
                else if(result_module_number == '13'){
                    modulenamesder = 'C12 (-)';
                    checkForLastPrintFlag =1;
                }
               } 

               else if(tempRes[0].battery_pack_name == 'Limber'){
                if(result_module_number == '1'){
                    modulenamesder = 'M1 (+)';
                }
              
                else if(result_module_number == '2'){
                    modulenamesder = 'M2 (-)';
                }
                else if(result_module_number == '3'){
                    modulenamesder = 'M3 (+)';
                }
                else if(result_module_number == '4'){
                    modulenamesder = 'M4 (-)';
                }
                else if(result_module_number == '5'){
                    modulenamesder = 'M5 (+)';
                }
                else if(result_module_number == '6'){
                    modulenamesder = 'M6 (-)';
                }
                else if(result_module_number == '7'){
                    modulenamesder = 'M7 (+)';
                }
                else if(result_module_number == '8'){
                    modulenamesder = 'M8 (-)';
                    checkForLastPrintFlag =1 ;
                }
                
                }
                else if(tempRes[0].battery_pack_name == 'NOVA MROPS'){
                    if(result_module_number == '1'){
                        modulenamesder = 'A1 (-)';
                    }
                
                    else if(result_module_number == '2'){
                        modulenamesder = 'A2 (+)';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'A3 (-)';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'A4 (+)';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'A5 (-)';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'B6 (+)';
                    }
                    else if(result_module_number == '7'){
                        modulenamesder = 'B7 (-)';
                    }
                    else if(result_module_number == '8'){
                        modulenamesder = 'B8 (+)';
                    }
                    else if(result_module_number == '9'){
                        modulenamesder = 'B9 (-)';
                    }
                    else if(result_module_number == '10'){
                        modulenamesder = 'B10 (+)';
                    }
                    else if(result_module_number == '11'){
                        modulenamesder = 'B11 (-)';
                    }
                  
                   
                } 
                else if(tempRes[0].battery_pack_name == 'NOVA LROPS'){
                    if(result_module_number == '1'){
                        modulenamesder = 'M1 (+)';
                    }
                
                    else if(result_module_number == '2'){
                        modulenamesder = 'M2 (-)';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'M3 (+)';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'M4 (-)';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'M5 (+)';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'M6 (-)';
                    }
                   
                   
                } 
                 
                else if(tempRes[0].battery_pack_name == 'Tamor'){
                    if(result_module_number == '1'){
                        modulenamesder = 'A1 (-)';
                    }
                
                    else if(result_module_number == '2'){
                        modulenamesder = 'B2 (+)';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'B3 (+)';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'C4 (-)';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'C5 (+)';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'C6 (-)';
                    }
                    else if(result_module_number == '7'){
                        modulenamesder = 'C7 (+)';
                    }
                   
                } 
                else{// if(runningModuleDATA[i].PackName == 'Kanger 2'){
                    //console.log('98428342347234234',result_module_number)
                    if(result_module_number == '1'){
                        modulenamesder = 'A1';
                    }
                  
                    else if(result_module_number == '2'){
                        modulenamesder = 'B2';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'B3';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'B4';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'B5';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'B6';
                    }
                    else if(result_module_number == '7'){
                        modulenamesder = 'B7';
                    }
                    else if(result_module_number == '8'){
                        modulenamesder = 'C8';
                    }
                    else if(result_module_number == '9'){
                        modulenamesder = 'C9';
                    }
                    else if(result_module_number == '10'){
                        modulenamesder = 'C10';
                    }
                    else if(result_module_number == '11'){
                        modulenamesder = 'C11';
                    }
                    else if(result_module_number == '12'){
                        modulenamesder = 'C12';
                    }
                    else if(result_module_number == '13'){
                        modulenamesder = 'C13';
                    }
                   }
            // console.log('next scann',result_srno,'result_rownum',result_rownum);

            // await updateCountInTotalModulesNew(result_module_barcode);
            updateCountInTotalModulesNew(result_module_barcode);

            if (result_rownum == 'first') {

                await runUpdateQueryForFirst(result_srno, barcode, voltage_ir_val);
                await runModuleStatusToRunning(result_module_barcode, barcode, result_module_name)
                resolve();
                // call shubham and kaustubh functions
                // finalQRCodeDetailsDBEntry(GlobalPackName,battery_id,final_qrcode);
                //getDataNow();

            }
            else if (result_rownum == 'last') {
                //console.log('last value2213.....result_module_barcode,result_srno,barcode',result_module_barcode,result_srno,barcode)
                var checkEntry = await runUpdateQueryForLast(result_srno, barcode, result_srno, voltage_ir_val);
                if(checkEntry == true){
                    await runUpdateQueryForLastModuleStatus(result_module_barcode, tempRes, result_module_number);
                   
                }
                resolve();
               // autoPrintModuleCode(result_module_barcode,printPackNo,modulenamesder,socket);
                // call shubham and kaustubh functions
                //getDataNow();


            }
            else {
                await runUpdateQueryForMid(result_srno, barcode, voltage_ir_val);
                resolve();
                // call shubham and kaustubh functions
                //getDataNow();
            }
        }
    });

    }
//     async function cellQRscanned(barcode, globalSelectedScannedId,tepC) {
//         var checkDuplicate = await runCrossCheckCellQR(barcode);
//         io.emit('testdata', 'msg')
//         //console.log('checkDuplicate',checkDuplicate)
//         //var fer = 0;
//         // 01TMB03P000011C1M7000022
//          //var fer = parseInt(checkDuplicate);
//         /////////Duplicate Repeat Disable Enable///// st fer = 0; to disable and parseInt to enable




//         //////////////////////////////queue/////////////////////
//         var fer2 = 0;
//         // if (fer > fer2) {
//         if (checkDuplicate == true) {
//             //console.log('duplicate')

//             callingDuplicate(globalSelectedScannedId,barcode,tepC);
//         }
//         else {
//          //   updateScannedID(globalSelectedScannedId,barcode,io);
           
//             var tempRes = await cellQRscannEntry();
//             var result_srno = tempRes[0].sr_no;
//             var result_rownum = tempRes[0].rownum;
//             var result_module_name = tempRes[0].module_name;
//             var result_module_barcode = tempRes[0].module_barcode;
//             var result_module_number = tempRes[0].moduleNumber;
//             var result_packQRCODE = tempRes[0].final_qr_code;
//             var printPackNo = result_packQRCODE.substring(10,).replace(/^0+/, '');

//             var modulenamesder ;
//                if(tempRes[0].battery_pack_name == 'Kanger 1 AIO' || tempRes[0].battery_pack_name == 'Kanger 1 Gen 3'){
//                 if(result_module_number == '1'){
//                     modulenamesder = 'A1 (+)';
//                 }
              
//                 else if(result_module_number == '2'){
//                     modulenamesder = 'A2 (-)';
//                 }
//                 else if(result_module_number == '3'){
//                     modulenamesder = 'A3 (+)';
//                 }
//                 else if(result_module_number == '4'){
//                     modulenamesder = 'A4 (-)';
//                 }
//                 else if(result_module_number == '5'){
//                     modulenamesder = 'A5 (+)';
//                 }
//                 else if(result_module_number == '6'){
//                     modulenamesder = 'A6 (-)';
//                 }
//                 else if(result_module_number == '7'){
//                     modulenamesder = 'A7 (+)';
//                 }
//                 else if(result_module_number == '8'){
//                     modulenamesder = 'B8 (-)';
//                 }
//                 else if(result_module_number == '9'){
//                     modulenamesder = 'B13 (+)';
//                 }
//                 else if(result_module_number == '10'){
//                     modulenamesder = 'C9 (+)';
//                 }
//                 else if(result_module_number == '11'){
//                     modulenamesder = 'C10 (-)';
//                 }
//                 else if(result_module_number == '12'){
//                     modulenamesder = 'C11 (+)';
//                 }
//                 else if(result_module_number == '13'){
//                     modulenamesder = 'C12 (-)';
//                     checkForLastPrintFlag =1;
//                 }
//                } 

//                else if(tempRes[0].battery_pack_name == 'Limber'){
//                 if(result_module_number == '1'){
//                     modulenamesder = 'M1 (+)';
//                 }
              
//                 else if(result_module_number == '2'){
//                     modulenamesder = 'M2 (-)';
//                 }
//                 else if(result_module_number == '3'){
//                     modulenamesder = 'M3 (+)';
//                 }
//                 else if(result_module_number == '4'){
//                     modulenamesder = 'M4 (-)';
//                 }
//                 else if(result_module_number == '5'){
//                     modulenamesder = 'M5 (+)';
//                 }
//                 else if(result_module_number == '6'){
//                     modulenamesder = 'M6 (-)';
//                 }
//                 else if(result_module_number == '7'){
//                     modulenamesder = 'M7 (+)';
//                 }
//                 else if(result_module_number == '8'){
//                     modulenamesder = 'M8 (-)';
//                     checkForLastPrintFlag =1 ;
//                 }
                
//                 }
//                 else{// if(runningModuleDATA[i].PackName == 'Kanger 2'){
//                     //console.log('98428342347234234',result_module_number)
//                     if(result_module_number == '1'){
//                         modulenamesder = 'A1';
//                     }
                  
//                     else if(result_module_number == '2'){
//                         modulenamesder = 'B2';
//                     }
//                     else if(result_module_number == '3'){
//                         modulenamesder = 'B3';
//                     }
//                     else if(result_module_number == '4'){
//                         modulenamesder = 'B4';
//                     }
//                     else if(result_module_number == '5'){
//                         modulenamesder = 'B5';
//                     }
//                     else if(result_module_number == '6'){
//                         modulenamesder = 'B6';
//                     }
//                     else if(result_module_number == '7'){
//                         modulenamesder = 'B7';
//                     }
//                     else if(result_module_number == '8'){
//                         modulenamesder = 'C8';
//                     }
//                     else if(result_module_number == '9'){
//                         modulenamesder = 'C9';
//                     }
//                     else if(result_module_number == '10'){
//                         modulenamesder = 'C10';
//                     }
//                     else if(result_module_number == '11'){
//                         modulenamesder = 'C11';
//                     }
//                     else if(result_module_number == '12'){
//                         modulenamesder = 'C12';
//                     }
//                     else if(result_module_number == '13'){
//                         modulenamesder = 'C13';
//                     }
//                    }
//             // console.log('next scann',result_srno,'result_rownum',result_rownum);

//             // await updateCountInTotalModulesNew(result_module_barcode);
//             updateCountInTotalModulesNew(result_module_barcode);

//             if (result_rownum == 'first') {

//                 await runUpdateQueryForFirst(result_srno, barcode);
//                 await runModuleStatusToRunning(result_module_barcode, barcode, result_module_name)
//                 // call shubham and kaustubh functions
//                 // finalQRCodeDetailsDBEntry(GlobalPackName,battery_id,final_qrcode);
//                 //getDataNow();
//                 await get_station_status_flag();
//                 console.log('emitting okscan------------->>>>>>>>>>>',barcode)
//                 socket.emit('set_station_status_flag',globalStation_status_Flag);
//                 socket.emit('ok_scann', barcode, globalSelectedScannedId)
//             }
//             else if (result_rownum == 'last') {
//                 console.log('last value.....result_module_barcode,result_srno,barcode',result_module_barcode,result_srno,barcode)
//                 var checkEntry = await runUpdateQueryForLast(result_srno, barcode, result_srno);
//                if(checkEntry == true){
//                 await runUpdateQueryForLastModuleStatus(result_module_barcode, tempRes, result_module_number);
//                 // autoPrintModuleCode(result_module_barcode,printPackNo,modulenamesder,socket);
//                  // call shubham and kaustubh functions
//                  //getDataNow();
//                  await get_station_status_flag();
      
//                  socket.emit('set_station_status_flag',globalStation_status_Flag);
//                  socket.emit('ok_scann', barcode, globalSelectedScannedId)
//                  console.log('emitting okscan------------->>>>>>>>>>>',barcode)

//                }

               
              
//             }
//             else {
//                 await runUpdateQueryForMid(result_srno, barcode);
//                 // call shubham and kaustubh functions
//                 //getDataNow();
//                 socket.emit('ok_scann', barcode, globalSelectedScannedId)
//             }
//         }











// //////////////////////////////queue end//////////////////////







//     }
async function cellQRscanned(barcode, globalSelectedScannedId,tepC,voltageirStr) {

    var checkDuplicate = await runCrossCheckCellQR(barcode);
    io.emit('testdata', 'msg')
    //////////////////////////////queue/////////////////////
    var fer2 = 0;
    // if (fer > fer2) {
    if (checkDuplicate == true) {
        //console.log('duplicate')

        callingDuplicate(globalSelectedScannedId,barcode,tepC);
    }
    else {
        //   updateScannedID(globalSelectedScannedId,barcode,io);
        // get ocv voltage and ir values
       var voltage_ir_val = await getVoltageIrVal(barcode);
       //  var voltage_ir_val='NOT_FOUND';
        //var splitDatavolval=voltageirStr.split(',');
          //  var voltage_ir_val = splitDatavolval[1]+","+splitDatavolval[2]+","+splitDatavolval[3]+","+splitDatavolval[4];
        var tempRes = await cellQRscannEntry();
        if(tempRes[0]) {
            var result_srno = tempRes[0].sr_no;
            var result_rownum = tempRes[0].rownum;
            var result_module_name = tempRes[0].module_name;
            var result_module_barcode = tempRes[0].module_barcode;
            var result_module_number = tempRes[0].moduleNumber;
            var result_packQRCODE = tempRes[0].final_qr_code;
            var printPackNo = result_packQRCODE.substring(10,).replace(/^0+/, '');

            var modulenamesder ;
            if(tempRes[0].battery_pack_name == 'Kanger 1 AIO' || tempRes[0].battery_pack_name == 'Kanger 1 Gen 3'){
                if(result_module_number == '1'){
                    modulenamesder = 'A1 (+)';
                }
            
                else if(result_module_number == '2'){
                    modulenamesder = 'A2 (-)';
                }
                else if(result_module_number == '3'){
                    modulenamesder = 'A3 (+)';
                }
                else if(result_module_number == '4'){
                    modulenamesder = 'A4 (-)';
                }
                else if(result_module_number == '5'){
                    modulenamesder = 'A5 (+)';
                }
                else if(result_module_number == '6'){
                    modulenamesder = 'A6 (-)';
                }
                else if(result_module_number == '7'){
                    modulenamesder = 'A7 (+)';
                }
                else if(result_module_number == '8'){
                    modulenamesder = 'B8 (-)';
                }
                else if(result_module_number == '9'){
                    modulenamesder = 'B13 (+)';
                }
                else if(result_module_number == '10'){
                    modulenamesder = 'C9 (+)';
                }
                else if(result_module_number == '11'){
                    modulenamesder = 'C10 (-)';
                }
                else if(result_module_number == '12'){
                    modulenamesder = 'C11 (+)';
                }
                else if(result_module_number == '13'){
                    modulenamesder = 'C12 (-)';
                    checkForLastPrintFlag =1;
                }
            } 
          

            else if(tempRes[0].battery_pack_name == 'Limber'){
                if(result_module_number == '1'){
                    modulenamesder = 'M1 (+)';
                }
                else if(result_module_number == '2'){
                    modulenamesder = 'M2 (-)';
                }
                else if(result_module_number == '3'){
                    modulenamesder = 'M3 (+)';
                }
                else if(result_module_number == '4'){
                    modulenamesder = 'M4 (-)';
                }
                else if(result_module_number == '5'){
                    modulenamesder = 'M5 (+)';
                }
                else if(result_module_number == '6'){
                    modulenamesder = 'M6 (-)';
                }
                else if(result_module_number == '7'){
                    modulenamesder = 'M7 (+)';
                }
                else if(result_module_number == '8'){
                    modulenamesder = 'M8 (-)';
                    checkForLastPrintFlag =1 ;
                }
                
                }
                else if(tempRes[0].battery_pack_name == 'Tamor'){
                    if(result_module_number == '1'){
                        modulenamesder = 'A1 (-)';
                    }
                
                    else if(result_module_number == '2'){
                        modulenamesder = 'B2 (+)';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'B3 (+)';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'C4 (-)';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'C5 (+)';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'C6 (-)';
                    }
                    else if(result_module_number == '7'){
                        modulenamesder = 'C7 (+)';
                    }
                   
                } 
                else{// if(runningModuleDATA[i].PackName == 'Kanger 2'){
                    //console.log('98428342347234234',result_module_number)
                    if(result_module_number == '1'){
                        modulenamesder = 'A1';
                    }
                
                    else if(result_module_number == '2'){
                        modulenamesder = 'B2';
                    }
                    else if(result_module_number == '3'){
                        modulenamesder = 'B3';
                    }
                    else if(result_module_number == '4'){
                        modulenamesder = 'B4';
                    }
                    else if(result_module_number == '5'){
                        modulenamesder = 'B5';
                    }
                    else if(result_module_number == '6'){
                        modulenamesder = 'B6';
                    }
                    else if(result_module_number == '7'){
                        modulenamesder = 'B7';
                    }
                    else if(result_module_number == '8'){
                        modulenamesder = 'C8';
                    }
                    else if(result_module_number == '9'){
                        modulenamesder = 'C9';
                    }
                    else if(result_module_number == '10'){
                        modulenamesder = 'C10';
                    }
                    else if(result_module_number == '11'){
                        modulenamesder = 'C11';
                    }
                    else if(result_module_number == '12'){
                        modulenamesder = 'C12';
                    }
                    else if(result_module_number == '13'){
                        modulenamesder = 'C13';
                    }
                }
            // console.log('next scann',result_srno,'result_rownum',result_rownum);

            // await updateCountInTotalModulesNew(result_module_barcode);
            updateCountInTotalModulesNew(result_module_barcode);

            if (result_rownum == 'first') {

                await runUpdateQueryForFirst(result_srno, barcode, voltage_ir_val);
                await runModuleStatusToRunning(result_module_barcode, barcode, result_module_name)
                resolve();
                // call shubham and kaustubh functions
                // finalQRCodeDetailsDBEntry(GlobalPackName,battery_id,final_qrcode);
                //getDataNow();

            }
            else if (result_rownum == 'last') {
                //console.log('last value2213.....result_module_barcode,result_srno,barcode',result_module_barcode,result_srno,barcode)
                var checkEntry = await runUpdateQueryForLast(result_srno, barcode, result_srno, voltage_ir_val);
                if(checkEntry == true){
                    await runUpdateQueryForLastModuleStatus(result_module_barcode, tempRes, result_module_number);
                   
                }
                resolve();
               // autoPrintModuleCode(result_module_barcode,printPackNo,modulenamesder,socket);
                // call shubham and kaustubh functions
                //getDataNow();


            }
            else {
                await runUpdateQueryForMid(result_srno, barcode, voltage_ir_val);
                resolve();
                // call shubham and kaustubh functions
                //getDataNow();
            }
        }
    }











//////////////////////////////queue end//////////////////////







}


    function runCrossCheckCellQR(barcode) {
        return new Promise((resolve, reject) => {
            // `SELECT * FROM taco_treceability.production_count WHERE cell_qr_code = '${barcode}' ;`, function (err, recordset) {
            //     if (err) console.log(err);
            //     //console.log('step 2');
            //     if(result.length>0){
            //         resolve(true);
            //     }
            //     else{
            //         resolve(false);
            //     }
                
            // });
            var isQRCodePresent=false;
            // if(globalCellQRCodeStore.includes(barcode) || globalCellQRCodeStore_line2.includes(barcode)) {
            if(globalCellQRCodeStore.includes(barcode) ) {
                isQRCodePresent=true;
            }
            resolve(isQRCodePresent);
        })
    }
    function runUpdateQueryForMid(result_srno, barcode, voltage_ir_val) {
        return new Promise((resolve, reject) => {
            var voltage_str;
            var ir_str;
            var ocv_updatetime_str;
            var ocv_macloc_str,kvalue_str,class_str,capacity_str;
            if(voltage_ir_val.split(",").length == 7) {
                voltage_str=voltage_ir_val.split(",")[0];
                ir_str=voltage_ir_val.split(",")[1];
                ocv_updatetime_str=voltage_ir_val.split(",")[2];
                ocv_macloc_str=voltage_ir_val.split(",")[3];
                kvalue_str=voltage_ir_val.split(",")[4];
                class_str=voltage_ir_val.split(",")[5];
                capacity_str=voltage_ir_val.split(",")[6];
            } else {
                voltage_str="NOT_FOUND";
                ir_str="NOT_FOUND";
                ocv_updatetime_str="NOT_FOUND";
                ocv_macloc_str="NOT_FOUND";
                kvalue_str="NOT_FOUND";
                class_str="NOT_FOUND";
                capacity_str="NOT_FOUND";
            }
            var sqlQry = `UPDATE taco_treceability.taco_treceability.production_count SET cell_qr_code = '${barcode}' ,cell_status='complete',cell_voltage='${voltage_str}',cell_ir='${ir_str}',ocv_machine_location='${ocv_macloc_str}',ocv_scanned_time='${ocv_updatetime_str}',ocv_kvalue='${kvalue_str}',ocv_class='${class_str}',ocv_capacity='${capacity_str}' WHERE sr_no = ${result_srno}`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sqlQry, function (err, recordset) {
                    // if (err) console.log(err);
                    //var result = recordset.recordset;
                if (err) {
                    if(err.code == 'ER_DUP_ENTRY' || err.code == 'EREQUEST' || parseInt(err.errno) == 1062) {
                        socket.emit('duplicate', '',barcode,'re-checked-dupli');
                    }
                    console.log(err);
                }
                resolve();
            });
        });
        })
    }
    function runUpdateQueryForLast(result_module_barcode, barcode, result_srno, voltage_ir_val) {
        return new Promise((resolve, reject) => {
            var voltage_str;
            var ir_str;
            var ocv_updatetime_str;
            var ocv_macloc_str,kvalue_str,class_str,capacity_str;
            if(voltage_ir_val.split(",").length == 7) {
                voltage_str=voltage_ir_val.split(",")[0];
                ir_str=voltage_ir_val.split(",")[1];
                ocv_updatetime_str=voltage_ir_val.split(",")[2];
                ocv_macloc_str=voltage_ir_val.split(",")[3];
                kvalue_str=voltage_ir_val.split(",")[4];
                class_str=voltage_ir_val.split(",")[5];
                capacity_str=voltage_ir_val.split(",")[6];

            } else {
                voltage_str="NOT_FOUND";
                ir_str="NOT_FOUND";
                ocv_updatetime_str="NOT_FOUND";
                ocv_macloc_str="NOT_FOUND";
                kvalue_str="NOT_FOUND";
                class_str="NOT_FOUND";
                capacity_str="NOT_FOUND";
            }
            var sqlQry = `UPDATE taco_treceability.taco_treceability.production_count SET cell_qr_code = '${barcode}' ,cell_status='complete',cell_voltage='${voltage_str}',cell_ir='${ir_str}',ocv_machine_location='${ocv_macloc_str}',ocv_scanned_time='${ocv_updatetime_str}',ocv_kvalue='${kvalue_str}',ocv_class='${class_str}',ocv_capacity='${capacity_str}' WHERE sr_no = ${result_srno}`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sqlQry, function (err, recordset) {
                    // if (err) console.log(err);
                    //var result = recordset.recordset;
                if (err) {
                    console.log(err);
                    globalDATABASEQueueModuleComplete.push(sql);
                    if(err.code == 'ER_DUP_ENTRY' || err.code == 'EREQUEST' || parseInt(err.errno) == 1062) {
                        socket.emit('duplicate', '',barcode,'re-checked-dupli');
                    }
                    resolve(false);
                }else{
                  //  console.log(result.affectedRows + " record(s) updated******************-----------"+barcode);
                    resolve(true);
                }
              
                // console.log(result.affectedRows + " record(s) updated");
            });
        });
        })
    }
    function runUpdateQueryForLastModuleStatus(result_module_barcode, tempRes, result_module_number) {
        return new Promise((resolve, reject) => {
            //console.log('Module COMPLETED',)
            var sqlQry = `Select count(*) as count from taco_traceability_admin.dbo.battery_pack_details where pack_name='${tempRes[0].battery_pack_name.replace(/\s+/g, '_')}'`;
                    sql.connect(sqlConfig2, function (err) {
                        request = new sql.Request();
                        request.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            if(recordset) {
                                var result=recordset.recordset;
                                var result_module_number_db=result[0].count;

                                if (parseInt(result_module_number) == result_module_number_db) {
                                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET battery_status= 'pending', module_status = 'complete' WHERE final_qr_code = '${tempRes[0].final_qr_code}'`;
                                    var sqlQry;
                                    if(tempRes[0].battery_pack_name.replace(/\s+/g, '_')=="NOVA MROPS"){
                                    sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                                    }
                                    else{
                                        sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                                    
                                    }
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sql2, function (err, recordset) {
                                            // if (err) console.log(err);
                                            //var result = recordset.recordset;
                                    
                                        if (err) {
                                            //console.log(err);
                                            globalDATABASEQueueModuleComplete.push(sql2);
                                            globalDATABASEQueueModuleComplete.push(sqlQry);
                                            resolve();
                                        }
                                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                                        
                                        request2 = new sql.Request();
                                        request2.query(sqlQry, function (err, recordset) {
                                            // if (err) console.log(err);
                                            //var result2 = recordset.recordset;
                                        
                                            if (err){
                                                console.log(err);
                                              
                                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                                resolve();
                                            }else{
                                                setTimeout(() => {
                                                    sendToArchive(tempRes[0].final_qr_code,'pending');
                                                    resolve();
                                                }, 1000);
                                            }
                                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                                            ///////////kaustubh function call to update status to pending for battery pack assemby.
                
                                            //updateFinalQRCodeBatteryStatus('${tempRes[0].final_qr_code}');
                                           
                                           
                                            
                                            //return;
                                        });
                                    });
                                });
                                }
                                else {
                                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET module_status = 'complete' WHERE module_barcode = '${result_module_barcode}' AND module_name = '${tempRes[0].module_name}'`;
                                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sql2, function (err, recordset) {
                                            // if (err) console.log(err);
                                            //var result = recordset.recordset;
                                    
                                        if (err){
                                            console.log(err);
                                            globalDATABASEQueueModuleComplete.push(sql2);
                                            globalDATABASEQueueModuleComplete.push(sqlQry);
                                            resolve();
                
                                        }
                                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                                        request2 = new sql.Request();
                                        request2.query(sqlQry, function (err, recordset) {
                                            // if (err) console.log(err);
                                            //var result2 = recordset.recordset;
                                        
                                            if (err){
                                                console.log(err);
                                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                                resolve();
                                            }
                                            else{
                                                setTimeout(() => {
                                                    refreshInMemoryData();
                                                resolve();
                                                }, 1000);
                                            }
                                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                                          
                                            
                                            //return;
                                        });
                                    });
                                });
                                }


                            }
                            
                    

                        })
                    });

/*
            if (tempRes[0].battery_pack_name == 'Kanger 1 Gen 3' || tempRes[0].battery_pack_name == 'Kanger 1 AIO' || tempRes[0].battery_pack_name == 'Kanger 2') {
                if (parseInt(result_module_number) == 13) {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET battery_status = 'pending', module_status = 'complete' WHERE final_qr_code = '${tempRes[0].final_qr_code}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                        if (err) {
                            console.log(err);
                           
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();
                        };
                        console.log('Last Module updated', result_module_barcode)
                       
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset2) {
                            // if (err) console.log(err);
                            //var result2 = recordset2.recordset;

                        
                            if (err) {
                                console.log(err);
                           
                              
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                resolve();
                            }
                            else{
                                setTimeout(() => {
                                    sendToArchive(tempRes[0].final_qr_code,'pending');
                                resolve();
                                }, 1000);
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);


                            ///////////kaustubh function call to update status to pending for battery pack assemby.

                            //updateFinalQRCodeBatteryStatus('${tempRes[0].final_qr_code}');
                          
                            
                            //return;
                        });
                    });
                });
                }
                else {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET module_status = 'complete' WHERE module_barcode = '${result_module_barcode}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                        if (err){
                            console.log(err);
                           
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();
                        } 
                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                            if (err){
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                console.log(err);
                                resolve();
                            }
                            else{
                                setTimeout(() => {
                                    refreshInMemoryData();
                                resolve();
                                }, 1000);
                                
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                          
                            
                            //return;
                        });
                    });
                });
                }

            }
            else if (tempRes[0].battery_pack_name == 'Limber') {
                if (parseInt(result_module_number) == 8) {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET battery_status= 'pending', module_status = 'complete' WHERE final_qr_code = '${tempRes[0].final_qr_code}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                    
                        if (err) {
                            console.log(err);
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();
                        }
                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                        
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result2 = recordset.recordset;
                        
                            if (err){
                                console.log(err);
                              
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                resolve();
                            }else{
                                setTimeout(() => {
                                    sendToArchive(tempRes[0].final_qr_code,'pending');
                                    resolve();
                                }, 1000);
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                            ///////////kaustubh function call to update status to pending for battery pack assemby.

                            //updateFinalQRCodeBatteryStatus('${tempRes[0].final_qr_code}');
                           
                           
                            
                            //return;
                        });
                    });
                });
                }
                else {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET module_status = 'complete' WHERE module_barcode = '${result_module_barcode}' AND module_name = '${tempRes[0].module_name}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                    
                        if (err){
                            console.log(err);
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();

                        }
                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result2 = recordset.recordset;
                        
                            if (err){
                                console.log(err);
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                resolve();
                            }
                            else{
                                setTimeout(() => {
                                    refreshInMemoryData();
                                resolve();
                                }, 1000);
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                          
                            
                            //return;
                        });
                    });
                });
                }
            }
            else if (tempRes[0].battery_pack_name == 'Challenger') {
                if (parseInt(result_module_number) == 6) {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET battery_status= 'pending', module_status = 'complete' WHERE final_qr_code = '${tempRes[0].final_qr_code}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                    
                        if (err) {
                            console.log(err);
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();
                        }
                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                        
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result2 = recordset.recordset;
                        
                            if (err){
                                console.log(err);
                              
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                resolve();
                            }else{
                                setTimeout(() => {
                                    sendToArchive(tempRes[0].final_qr_code,'pending');
                                    resolve();
                                }, 1000);
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                            ///////////kaustubh function call to update status to pending for battery pack assemby.

                            //updateFinalQRCodeBatteryStatus('${tempRes[0].final_qr_code}');
                           
                           
                            
                            //return;
                        });
                    });
                });
                }
                else {
                    var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET module_status = 'complete' WHERE module_barcode = '${result_module_barcode}' AND module_name = '${tempRes[0].module_name}'`;
                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.station_status (PackName,FinalQRCode, ModuleName,ModuleBarcode,ModulePrintStatus,ModuleOCV_status,Welding_status,IR_V_status,FinalQRCodePrint_status,AirLeakage_status,ChargingDischarging_status,PDI_status,EntryDateTime,moduleNumber,line) VALUES ('${tempRes[0].battery_pack_name}', '${tempRes[0].final_qr_code}', '${tempRes[0].module_name}', '${tempRes[0].module_barcode}','NOT OK','OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','NOT OK','${SystemcurrentTime}','${result_module_number}','4');`;
                    sql.connect(sqlConfig, function (err) {
                        request = new sql.Request();
                        request.query(sql2, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                    
                        if (err){
                            console.log(err);
                            globalDATABASEQueueModuleComplete.push(sql2);
                            globalDATABASEQueueModuleComplete.push(sqlQry);
                            resolve();

                        }
                        //console.log('New Welding Block last value updated with module status', result_module_barcode)
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result2 = recordset.recordset;
                        
                            if (err){
                                console.log(err);
                                globalDATABASEQueueModuleComplete.push(sqlQry);
                                resolve();
                            }
                            else{
                                setTimeout(() => {
                                    refreshInMemoryData();
                                resolve();
                                }, 1000);
                            }
                            //console.log("THIS IS MODULE COMPLETE", result_module_number);
                          
                            
                            //return;
                        });
                    });
                });
                }
            }*/



        })
    }
    function runModuleStatusToRunning(result_module_barcode, barcode, result_module_name) {
        //console.log('module barcode', result_module_barcode)
        return new Promise((resolve, reject) => {

            var sql1 = `SELECT * FROM taco_treceability.taco_treceability.station_status WHERE line='4' and ModulePrintStatus = 'NOT OK'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sql1, function (err, recordset) {
                    // if (err) console.log(err);
                    var result2 = recordset.recordset;
            // sql1, function (err, result2) {
                if (err) console.log(err);
                //console.log(result.affectedRows + " next Module started");
                if(result2.length == 0){
                    var sqlQry = `UPDATE taco_treceability.taco_treceability.production_count SET module_status = 'running' WHERE module_barcode = '${result_module_barcode}' AND module_name = '${result_module_name}'`;
                    request2 = new sql.Request();
                    request2.query(sqlQry, function (err, recordset) {
                    // if (err) console.log(err);
                    //var result = recordset.recordset;
                    
                        if (err) console.log(err);
                        //console.log(result.affectedRows + " next Module started");
                        resolve();
                    });                    
                }
            });
        });
        })
    }
    function runUpdateQueryForFirst(result_srno, barcode, voltage_ir_val) {
        return new Promise((resolve, reject) => {
            var sql1 = `SELECT * FROM taco_treceability.taco_treceability.station_status WHERE line='4' and ModulePrintStatus = 'NOT OK'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sql1, function (err2, recordset) {
                    // if (err) console.log(err);
                    var result2 = recordset.recordset;
                // sql1, function (err, result2) {
                    if (err2) console.log(err2);
                    //console.log(result.affectedRows + " next Module started");
                    if(result2.length == 0){
                        var voltage_str;
                        var ir_str;
                        var ocv_updatetime_str;
                        var ocv_macloc_str,kvalue_str,class_str,capacity_str;
                        if(voltage_ir_val.split(",").length == 7) {
                            voltage_str=voltage_ir_val.split(",")[0];
                            ir_str=voltage_ir_val.split(",")[1];
                            ocv_updatetime_str=voltage_ir_val.split(",")[2];
                            ocv_macloc_str=voltage_ir_val.split(",")[3];
                            kvalue_str=voltage_ir_val.split(",")[4];
                            class_str=voltage_ir_val.split(",")[5];
                            capacity_str=voltage_ir_val.split(",")[6];
                        } else {
                            voltage_str="NOT_FOUND";
                            ir_str="NOT_FOUND";
                            ocv_updatetime_str="NOT_FOUND";
                            ocv_macloc_str="NOT_FOUND";
                            kvalue_str="NOT_FOUND";
                            class_str="NOT_FOUND";
                            capacity_str="NOT_FOUND";
                        }
                        var sqlQry = `UPDATE taco_treceability.taco_treceability.production_count SET cell_qr_code='${barcode}',cell_status='complete',cell_voltage='${voltage_str}',cell_ir='${ir_str}',ocv_machine_location='${ocv_macloc_str}',ocv_scanned_time='${ocv_updatetime_str}',ocv_kvalue='${kvalue_str}',ocv_class='${class_str}',ocv_capacity='${capacity_str}' WHERE sr_no = ${result_srno}`;
                        request2 = new sql.Request();
                        request2.query(sqlQry, function (err, recordset) {
                            // if (err) console.log(err);
                            //var result = recordset.recordset;
                        
                            if (err) {
                                if(err.code == 'ER_DUP_ENTRY' || err.code == 'EREQUEST' || parseInt(err.errno) == 1062) {
                                    socket.emit('duplicate', '',barcode,'re-checked-dupli');
                                }
                                console.log(err);
                            }
                            //console.log(result.affectedRows + "first record(s) updated");
                            resolve();
                        });
                    }
                });
            });
        })
    }
    function cellQRscannEntry() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT TOP 1 * FROM taco_treceability.taco_treceability.production_count WHERE cell_status = 'incomplete' and line='4' ORDER BY sr_no ASC`, function (err2, recordset) {
                    // if (err) console.log(err);
                    var result = recordset.recordset;
        // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                    if (err2) console.log(err2);
                    //console.log('step 2');
                    resolve(result);
                });
            });
        })
    }


    socket.on('getModulesDataForPrint', (packQRCODE,packNameStr) => {
        ///connect to database for details of modules 
        // console.log('step1',packname);
        var resp = getDataNowPrinting(packQRCODE,packNameStr);

    });
    async function getDataNowPrinting(packQRCODE,packNameStr) {
        var runningPackDATA = await getRunningPackDetails2(packQRCODE,packNameStr);
        // var runningModuleDATA = await getRunningModuleDATA2(packQRCODE,packNameStr);
        // var ModuleCompletedCellsDATA = await getRunningModuleCompletedCellsDATA2(packQRCODE,packNameStr);
        // var runningCellDATA = await getRunningCellDATA2(packQRCODE,packNameStr);
        // var remainingModules = await getRemainingModules2(packQRCODE,packNameStr);
        // var remainingCells = await getRemainingCells2(packQRCODE,packNameStr);
        //var whenModuleCompleted = await whenModuleCompleted();
        //console.log('step3',ree);
        // var packName=runningModuleDATA[0].battery_pack_name;
        // var finalQRCode=runningModuleDATA[0].final_qr_code;
        // var productionBatches = await getProductionBatches(packName,finalQRCode);
        // var line1Batches = await getLineAllowedBatches();

        // socket.emit('current_data', runningPackDATA, runningModuleDATA, runningCellDATA, remainingModules, remainingCells, ModuleCompletedCellsDATA, line1FirstStartFlag, productionBatches, line1Batches);
        socket.emit('master_print_data', runningPackDATA);
        return;
    }
    function getRunningPackDetails2(packQRCODE,packNameStr) {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}' order by moduleNumber`, function (err2, recordset) {
                    // if (err) console.log(err);
                    var result = recordset.recordset;
            // `SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}';`, function (err, recordset) {
                    if (err2) console.log(err2);
                    if(result.length>0){
                        resolve(result);
                    }
                    else{
                        request2 = new sql.Request();
                        request2.query(`SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.taco_treceability.production_count_data_archive WHERE module_status in ('incomplete','queue','running','complete') AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}' order by moduleNumber`, function (err1, recordset2) {
                            // if (err) console.log(err);
                            var result1 = recordset2.recordset;
                        // `SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.production_count_data_archive WHERE module_status in ('incomplete','queue','running','complete') AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}';`, function (err1, result1, fields) {
                            if (err1) console.log(err1);
                            //console.log('step 2');
                            resolve(result1);
                        });
                    }
                    //console.log('step 2');
                
                });
            });
        });
    }
    // function getRunningModuleDATA2(packQRCODE,packNameStr) {
    //     var sqlQuery=`SELECT * FROM taco_treceability.production_count WHERE module_status='running' AND final_qr_code = '${packQRCODE}' and cell_status NOT in ('invalid') AND battery_pack_name = '${packNameStr}'` ;
    //     var Oldquery=`SELECT * FROM taco_treceability.production_count WHERE module_status='running' AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}';`;
    //     return new Promise((resolve, reject) => {
    //         Oldquery, function (err, recordset) {
    //             if (err) console.log(err);
    //           //  console.log('step 2222222222222',result);
    //             if(result.length > 0){
    //                 resolve(result);
    //             }
    //             else{
    //                 `SELECT * FROM taco_treceability.station_status WHERE ModulePrintStatus='NOT OK';`, function (err, recordset) {
    //                     if (err) console.log(err);
    //                    // console.log('step 3');
    //                     if(result.length > 0){
    //                         console.log('wwwwwwww',result.length)
    //                         resolve(result);
    //                     }
    //                     else{
                            
    //                     }
    //                 });
    //             }
    //         });
    //     })
    // }
    // function getRunningModuleCompletedCellsDATA2(packQRCODE,packNameStr) {
    //     return new Promise((resolve, reject) => {
    //         `SELECT * FROM taco_treceability.production_count WHERE module_status='running' AND cell_status = 'complete' AND final_qr_code = '${packQRCODE}' AND battery_pack_name = '${packNameStr}';`, function (err, recordset) {
    //             if (err) console.log(err);
    //             // console.log('completed cells ',result);
    //             resolve(result);
    //         });
    //     })
    // }
    // function getRunningCellDATA2(packQRCODE,packNameStr) {
    //     return new Promise((resolve, reject) => {
    //         `SELECT module_barcode,module_name  FROM taco_treceability.production_count WHERE final_qr_code = '${packQRCODE}' AND module_status in ('incomplete','queue','running','complete') AND battery_pack_name = '${packNameStr}' ;`, function (err, recordset) {
    //             if (err) console.log(err);
    //             //console.log('step 2');
    //             resolve(result);
    //         });
    //     })
    // }
    // function getRemainingModules2(packQRCODE,packNameStr) {
    //     return new Promise((resolve, reject) => {
    //         `SELECT distinct module_barcode,module_name  FROM taco_treceability.production_count WHERE final_qr_code = '${packQRCODE}' AND module_status in ('incomplete','queue') AND battery_pack_name = '${packNameStr}';`, function (err, recordset) {
    //             if (err) console.log(err);
    //             //console.log('step 2');
    //             resolve(result);
    //         });
    //     })
    // }
    // function getRemainingCells2(packQRCODE,packNameStr) {
    //     return new Promise((resolve, reject) => {
    //         var query=`SELECT * FROM taco_treceability.production_count WHERE final_qr_code='${packQRCODE}' AND battery_pack_name = '${packNameStr}' AND cell_status in ('incomplete','invalid')`;
    //         var oldQuery=`SELECT * FROM taco_treceability.production_count WHERE final_qr_code='${packQRCODE}' AND battery_pack_name = '${packNameStr}' AND cell_status = 'incomplete';`;
    //         query, function (err, recordset) {
    //             if (err) console.log(err);
    //             //console.log('step 2');
    //             resolve(result);
    //         });
    //     })
    // }






    ////Section 1.4 get view current data
    socket.on('getCurrentData', (packname) => {
        ///connect to database for details of modules 
        // console.log('step1',packname);
        var resp = getDataNow();

    });
    socket.on('saveSerialNumberMasterData', (packName, packSerialNumber,serialNumber,serialNumber2, serialNumber3)=> {

        var currentModuleSerialNumber = parseInt(packSerialNumber) +1 ;//parseInt(lastModuleSerialNumber) + 1;

        packSerialNumber = currentModuleSerialNumber.toString();
        if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
        if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }


        var currentModuleSerialNumber2 = serialNumber;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber = currentModuleSerialNumber2.toString();
        if (serialNumber.length == 1) { serialNumber = '00000' + serialNumber.toString() }
        if (serialNumber.length == 2) { serialNumber = '0000' + serialNumber.toString() }
        if (serialNumber.length == 3) { serialNumber = '000' + serialNumber.toString() }
        if (serialNumber.length == 4) { serialNumber = '00' + serialNumber.toString() }
        if (serialNumber.length == 5) { serialNumber = '0' + serialNumber.toString() }


        var currentModuleSerialNumber3 = serialNumber2;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber2 = currentModuleSerialNumber3.toString();
        if (serialNumber2.length == 1) { serialNumber2 = '00000' + serialNumber2.toString() }
        if (serialNumber2.length == 2) { serialNumber2 = '0000' + serialNumber2.toString() }
        if (serialNumber2.length == 3) { serialNumber2 = '000' + serialNumber2.toString() }
        if (serialNumber2.length == 4) { serialNumber2 = '00' + serialNumber2.toString() }
        if (serialNumber2.length == 5) { serialNumber2 = '0' + serialNumber2.toString() }


        var currentModuleSerialNumber4 = serialNumber3;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber3 = currentModuleSerialNumber4.toString();
        if (serialNumber3.length == 1) { serialNumber3 = '00000' + serialNumber3.toString() }
        if (serialNumber3.length == 2) { serialNumber3 = '0000' + serialNumber3.toString() }
        if (serialNumber3.length == 3) { serialNumber3 = '000' + serialNumber3.toString() }
        if (serialNumber3.length == 4) { serialNumber3 = '00' + serialNumber3.toString() }
        if (serialNumber3.length == 5) { serialNumber3 = '0' + serialNumber3.toString() }



        //var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}'`;
        var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}' and packName ='${packName}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dqQuery, function (err2, recordset) {
                // if (err) console.log(err);
                var result = recordset.recordset;
        // dqQuery, function (err, recordset) {
            if (err2) console.log(err2);
            if(result.length>0){
    
                var dqQuery2 = `SELECT * FROM taco_treceability.taco_treceability.production_count where battery_status= 'running' and line='4'`;
                request2 = new sql.Request();
                request2.query(dqQuery2, function (err3, recordset3) {
                    // if (err) console.log(err);
                    var result2 = recordset3.recordset;
                // dqQuery2, function (err, result2, fields) {
                    if (err3) console.log(err3);
                    if(result2.length>0){

                        socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_found','4');

                    }
                    else{


                        // var dqQuery = `SELECT * FROM taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                        // dqQuery, function (err, result3, fields) {
                        //     if (err) console.log(err);
                        //     if(result3.length>0){
                        //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                        //     }
                        //     else{
                        //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');

                        //     }
                        
                        // });
                        var dqQuery3 = `SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                        var dqQuery22 = `SELECT * FROM taco_treceability.taco_treceability.production_count where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                        request3 = new sql.Request();
                        request3.query(dqQuery3, function (err3, recordset4) {
                            // if (err) console.log(err);
                            var result3 = recordset4.recordset;
                        // dqQuery, function (err, result3, fields) {
                            if (err3) console.log(err3);
                            if(result3.length>0){
                                socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                            }
                            else{
                                request4 = new sql.Request();
                                request4.query(dqQuery22, function (err4, recordset5) {
                                    // if (err) console.log(err);
                                    var result4 = recordset5.recordset;
                                // dqQuery22, function (err3, result4, fields4) {
                                    if (err4) console.log(err4);
            
                                    if(result4.length>0){
                                        socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                                    }
                                    else{
                                        //console.log('already_registered_pack else production_count completed....................................')
            
                                        socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');
                                    }
                                });

                            }
                        
                        });





                     
                    }
            });
    
               
            }
            else{
                packSerialNumber = parseInt(packSerialNumber) - 1;
                packSerialNumber = packSerialNumber.toString();
                if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
                if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
                if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
                if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
                if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }

                var dqQuery = `insert into taco_treceability.taco_treceability.createpack(packName,packEntryDate,packSerialNumber,line) values('${packName}','${SystemcurrentTime}','${packSerialNumber}','4')`;
                // var dqQuery2 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('A - 6p6s','${SystemcurrentTime}','${serialNumber}','4')`;
                // var dqQuery3 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('B - 6p9s','${SystemcurrentTime}','${serialNumber2}','4')`;
                // var dqQuery4 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('C - 6p10s','${SystemcurrentTime}','${serialNumber3}','4')`;
        
                // if(packName.trim() == 'Kanger 2') {
                //     dqQuery = `insert into taco_treceability.taco_treceability.createpack(packName,packEntryDate,packSerialNumber,line) values('${packName}','${SystemcurrentTime}','${packSerialNumber}','4')`;
                //     dqQuery2 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('A - 8p8s','${SystemcurrentTime}','${serialNumber}','4')`;
                //     dqQuery3 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('B - 8p9s','${SystemcurrentTime}','${serialNumber2}','4')`;
                //     dqQuery4 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('C - 8p7s','${SystemcurrentTime}','${serialNumber3}','4')`;
                // }
        
                //console.log('dqQuery',dqQuery)
                //console.log('dqQuery',dqQuery2)
                //console.log('dqQuery3',dqQuery3)
                //console.log('dqQuery4',dqQuery4)
        
                request5 = new sql.Request();
                request5.query(dqQuery, function (err, recordset) {
                    if (err) console.log(err);

                    // request6 = new sql.Request();
                    // request6.query(dqQuery2, function (err2, recordset) {
                    //     if (err2) console.log(err2);
                    // // dqQuery2, function (err2, recordset) {
                    //     // if (err2) console.log(err);
                    //     request7 = new sql.Request();
                    //     request7.query(dqQuery3, function (err3, recordset) {
                    //         if (err3) console.log(err3);
                    //     // dqQuery3, function (err3, recordset) {
                    //         // if (err3) console.log(err);
                    //         request8 = new sql.Request();
                    //         request8.query(dqQuery4, function (err4, recordset) {
                    //             if (err4) console.log(err4);
                    //         // dqQuery4, function (err4, recordset) {
                    //         //     if (err4) console.log(err);
                    //             //console.log('Data saved saveSerialNumberMasterData');
                                
                    //         });
                            
                    //     });
                        
                    // });
                    
                });
        
            }
    
        });
    });






      
    });

    socket.on('restart_pack_archive_to_live', (packQRCode_temp)=> {
        sendToArchive_Archive_to_Live_running(packQRCode_temp);
    });

    socket.on('saveSerialNumberMasterDataLimber', (packName, packSerialNumber,serialNumber,serialNumber2)=> {

        var tempp_packk_ser_no = parseInt(packSerialNumber) +1;




        var currentModuleSerialNumber = tempp_packk_ser_no;//parseInt(lastModuleSerialNumber) + 1;

        packSerialNumber = currentModuleSerialNumber.toString();
        if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
        if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }


        var currentModuleSerialNumber2 = serialNumber;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber = currentModuleSerialNumber2.toString();
        if (serialNumber.length == 1) { serialNumber = '00000' + serialNumber.toString() }
        if (serialNumber.length == 2) { serialNumber = '0000' + serialNumber.toString() }
        if (serialNumber.length == 3) { serialNumber = '000' + serialNumber.toString() }
        if (serialNumber.length == 4) { serialNumber = '00' + serialNumber.toString() }
        if (serialNumber.length == 5) { serialNumber = '0' + serialNumber.toString() }


        var currentModuleSerialNumber3 = serialNumber2;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber2 = currentModuleSerialNumber3.toString();
        if (serialNumber2.length == 1) { serialNumber2 = '00000' + serialNumber2.toString() }
        if (serialNumber2.length == 2) { serialNumber2 = '0000' + serialNumber2.toString() }
        if (serialNumber2.length == 3) { serialNumber2 = '000' + serialNumber2.toString() }
        if (serialNumber2.length == 4) { serialNumber2 = '00' + serialNumber2.toString() }
        if (serialNumber2.length == 5) { serialNumber2 = '0' + serialNumber2.toString() }


        //var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}'`;
        var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}' and packName ='${packName}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dqQuery, function (err, recordset) {
                // if (err) console.log(err);
                var result = recordset.recordset;
        // dqQuery, function (err, recordset) {
        if (err) console.log(err);
        if(result.length>0){

            var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.production_count where battery_status= 'running' and line='4'`;
            request2 = new sql.Request();
            request2.query(dqQuery, function (err, recordset2) {
                // if (err) console.log(err);
                var result2 = recordset2.recordset;
            // dqQuery, function (err, result2, fields) {
                if (err) console.log(err);
                if(result2.length>0){

                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_found','4');

                }
                else{


                    // var dqQuery = `SELECT * FROM taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    // dqQuery, function (err, result3, fields) {
                    //     if (err) console.log(err);
                    //     if(result3.length>0){
                    //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                    //     }
                    //     else{
                    //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');

                    //     }
                    
                    // });
                    var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    var dqQuery22 = `SELECT * FROM taco_treceability.taco_treceability.production_count where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    request3 = new sql.Request();
                    request3.query(dqQuery, function (err, recordset2) {
                        // if (err) console.log(err);
                        var result3 = recordset2.recordset;
                    // dqQuery, function (err, result3, fields) {
                        if (err) console.log(err);
                        if(result3.length>0){
                            socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                        }
                        else{
                            request4 = new sql.Request();
                            request4.query(dqQuery22, function (err3, recordset2) {
                                // if (err) console.log(err);
                                var result4 = recordset2.recordset;
                            // dqQuery22, function (err3, result4, fields4) {
                                if (err3) console.log(err3);

                                if(result4.length>0){
                                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                                }
                                else{
                                    //console.log('already_registered_pack else production_count completed....................................')

                                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');
                                }
                            });

                        }
                    
                    });





                
                }
        });
        
        }
        else{

            packSerialNumber = parseInt(packSerialNumber) - 1;




            var currentModuleSerialNumber = packSerialNumber;//parseInt(lastModuleSerialNumber) + 1;
            
            packSerialNumber = currentModuleSerialNumber.toString();
            if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
            if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }
            
            
            var currentModuleSerialNumber2 = serialNumber;//parseInt(lastModuleSerialNumber) + 1;
            
            serialNumber = currentModuleSerialNumber2.toString();
            if (serialNumber.length == 1) { serialNumber = '10000' + serialNumber.toString() }
            if (serialNumber.length == 2) { serialNumber = '1000' + serialNumber.toString() }
            if (serialNumber.length == 3) { serialNumber = '100' + serialNumber.toString() }
            if (serialNumber.length == 4) { serialNumber = '10' + serialNumber.toString() }
            if (serialNumber.length == 5) { serialNumber = '1' + serialNumber.toString() }
            
            
            var currentModuleSerialNumber3 = serialNumber2;//parseInt(lastModuleSerialNumber) + 1;
            
            serialNumber2 = currentModuleSerialNumber3.toString();
            if (serialNumber2.length == 1) { serialNumber2 = '10000' + serialNumber2.toString() }
            if (serialNumber2.length == 2) { serialNumber2 = '1000' + serialNumber2.toString() }
            if (serialNumber2.length == 3) { serialNumber2 = '100' + serialNumber2.toString() }
            if (serialNumber2.length == 4) { serialNumber2 = '10' + serialNumber2.toString() }
            if (serialNumber2.length == 5) { serialNumber2 = '1' + serialNumber2.toString() }
            




            var dqQuery = `insert into taco_treceability.taco_treceability.createpack(packName,packEntryDate,packSerialNumber,line) values('${packName}','${SystemcurrentTime}','${packSerialNumber}','4')`;
            var dqQuery2 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('Front - 5p6s','${SystemcurrentTime}','${serialNumber}','4')`;
            var dqQuery3 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('Rear - 5p21s','${SystemcurrentTime}','${serialNumber2}','4')`;

        
            request5 = new sql.Request();
            request5.query(dqQuery, function (err, recordset2) {
                if (err) console.log(err);
                // var result4 = recordset2.recordset;
            // dqQuery, function (err, recordset) {
                // if (err) console.log(err);
                request6 = new sql.Request();
                request6.query(dqQuery2, function (err, recordset2) {
                    if (err) console.log(err);
                // dqQuery2, function (err, recordset) {
                    // if (err) console.log(err);
                    request7 = new sql.Request();
                    request7.query(dqQuery3, function (err, recordset2) {
                        if (err) console.log(err);
                    // dqQuery3, function (err, recordset) {
                        // if (err) console.log(err);
                        //console.log('Data saved saveSerialNumberMasterData');
                        
                    });
                    
                });
                
            });
        }

        });
    });

    });

    socket.on('saveSerialNumberMasterDataChallenger', (packName, packSerialNumber,serialNumber,serialNumber2)=> {

        var tempp_packk_ser_no = parseInt(packSerialNumber) +1;




        var currentModuleSerialNumber = tempp_packk_ser_no;//parseInt(lastModuleSerialNumber) + 1;

        packSerialNumber = currentModuleSerialNumber.toString();
        if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
        if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
        if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }


        var currentModuleSerialNumber2 = serialNumber;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber = currentModuleSerialNumber2.toString();
        if (serialNumber.length == 1) { serialNumber = '00000' + serialNumber.toString() }
        if (serialNumber.length == 2) { serialNumber = '0000' + serialNumber.toString() }
        if (serialNumber.length == 3) { serialNumber = '000' + serialNumber.toString() }
        if (serialNumber.length == 4) { serialNumber = '00' + serialNumber.toString() }
        if (serialNumber.length == 5) { serialNumber = '0' + serialNumber.toString() }


        var currentModuleSerialNumber3 = serialNumber2;//parseInt(lastModuleSerialNumber) + 1;

        serialNumber2 = currentModuleSerialNumber3.toString();
        if (serialNumber2.length == 1) { serialNumber2 = '00000' + serialNumber2.toString() }
        if (serialNumber2.length == 2) { serialNumber2 = '0000' + serialNumber2.toString() }
        if (serialNumber2.length == 3) { serialNumber2 = '000' + serialNumber2.toString() }
        if (serialNumber2.length == 4) { serialNumber2 = '00' + serialNumber2.toString() }
        if (serialNumber2.length == 5) { serialNumber2 = '0' + serialNumber2.toString() }


        //var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}'`;
        var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.createpack where packSerialNumber= '${packSerialNumber}' and packName ='${packName}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dqQuery, function (err, recordset) {
                // if (err) console.log(err);
                var result = recordset.recordset;
        // dqQuery, function (err, recordset) {
        if (err) console.log(err);
        if(result.length>0){

            var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.production_count where battery_status= 'running' and line='4'`;
            request2 = new sql.Request();
            request2.query(dqQuery, function (err, recordset2) {
                // if (err) console.log(err);
                var result2 = recordset2.recordset;
            // dqQuery, function (err, result2, fields) {
                if (err) console.log(err);
                if(result2.length>0){

                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_found','4');

                }
                else{


                    // var dqQuery = `SELECT * FROM taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    // dqQuery, function (err, result3, fields) {
                    //     if (err) console.log(err);
                    //     if(result3.length>0){
                    //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                    //     }
                    //     else{
                    //         socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');

                    //     }
                    
                    // });
                    var dqQuery = `SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    var dqQuery22 = `SELECT * FROM taco_treceability.taco_treceability.production_count where final_qr_code= '${result[0].packQRCode}' AND cell_qr_code NOT LIKE '03HC%'`;
                    request3 = new sql.Request();
                    request3.query(dqQuery, function (err, recordset2) {
                        // if (err) console.log(err);
                        var result3 = recordset2.recordset;
                    // dqQuery, function (err, result3, fields) {
                        if (err) console.log(err);
                        if(result3.length>0){
                            socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                        }
                        else{
                            request4 = new sql.Request();
                            request4.query(dqQuery22, function (err3, recordset2) {
                                // if (err) console.log(err);
                                var result4 = recordset2.recordset;
                            // dqQuery22, function (err3, result4, fields4) {
                                if (err3) console.log(err3);

                                if(result4.length>0){
                                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'running_not_found','4');
                                }
                                else{
                                    //console.log('already_registered_pack else production_count completed....................................')

                                    socket.emit('already_registered_pack',result[0].packQRCode,packSerialNumber,'Completed_pack','4');
                                }
                            });

                        }
                    
                    });





                
                }
        });
        
        }
        else{

            packSerialNumber = parseInt(packSerialNumber) - 1;




            var currentModuleSerialNumber = packSerialNumber;//parseInt(lastModuleSerialNumber) + 1;
            
            packSerialNumber = currentModuleSerialNumber.toString();
            if (packSerialNumber.length == 1) { packSerialNumber = '00000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 2) { packSerialNumber = '0000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 3) { packSerialNumber = '000' + packSerialNumber.toString() }
            if (packSerialNumber.length == 4) { packSerialNumber = '00' + packSerialNumber.toString() }
            if (packSerialNumber.length == 5) { packSerialNumber = '0' + packSerialNumber.toString() }
            
            
            var currentModuleSerialNumber2 = serialNumber;//parseInt(lastModuleSerialNumber) + 1;
            
            serialNumber = currentModuleSerialNumber2.toString();
            if (serialNumber.length == 1) { serialNumber = '10000' + serialNumber.toString() }
            if (serialNumber.length == 2) { serialNumber = '1000' + serialNumber.toString() }
            if (serialNumber.length == 3) { serialNumber = '100' + serialNumber.toString() }
            if (serialNumber.length == 4) { serialNumber = '10' + serialNumber.toString() }
            if (serialNumber.length == 5) { serialNumber = '1' + serialNumber.toString() }
            
            
            var currentModuleSerialNumber3 = serialNumber2;//parseInt(lastModuleSerialNumber) + 1;
            
            serialNumber2 = currentModuleSerialNumber3.toString();
            if (serialNumber2.length == 1) { serialNumber2 = '10000' + serialNumber2.toString() }
            if (serialNumber2.length == 2) { serialNumber2 = '1000' + serialNumber2.toString() }
            if (serialNumber2.length == 3) { serialNumber2 = '100' + serialNumber2.toString() }
            if (serialNumber2.length == 4) { serialNumber2 = '10' + serialNumber2.toString() }
            if (serialNumber2.length == 5) { serialNumber2 = '1' + serialNumber2.toString() }
            




            var dqQuery = `insert into taco_treceability.taco_treceability.createpack(packName,packEntryDate,packSerialNumber,line) values('${packName}','${SystemcurrentTime}','${packSerialNumber}','4')`;
            var dqQuery2 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('A - 5p25s','${SystemcurrentTime}','${serialNumber}','4')`;
            var dqQuery3 = `insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values('B - 5p15s','${SystemcurrentTime}','${serialNumber2}','4')`;

        
            request5 = new sql.Request();
            request5.query(dqQuery, function (err, recordset2) {
                if (err) console.log(err);
                // var result4 = recordset2.recordset;
            // dqQuery, function (err, recordset) {
                // if (err) console.log(err);
                request6 = new sql.Request();
                request6.query(dqQuery2, function (err, recordset2) {
                    if (err) console.log(err);
                // dqQuery2, function (err, recordset) {
                    // if (err) console.log(err);
                    request7 = new sql.Request();
                    request7.query(dqQuery3, function (err, recordset2) {
                        if (err) console.log(err);
                    // dqQuery3, function (err, recordset) {
                        // if (err) console.log(err);
                        //console.log('Data saved saveSerialNumberMasterData');
                        
                    });
                    
                });
                
            });
        }

        });
    });

    });


    socket.on('getPendingPrints', (data)=> {
        (async function main() {
            await getPendingPrints(socket);
        })();
    })

    socket.on('getBatchDetails', (battery_pack_name,final_qr_code)=> {
        // (async function main() {
        //     var productionBatches = await getProductionBatches(battery_pack_name,final_qr_code);
        //     var line4Batches = await getLineAllowedBatches();
        //     socket.emit('setBatchDetails',productionBatches,line4Batches);
        // })();
        getBatchDetails(battery_pack_name,final_qr_code);
    })

    socket.on('getrange_from_to', (a)=> {
        /*  var range_from,range_to;
        // console.log("rrrrrrrrr battery_pack_name,final_qr_code",battery_pack_name,final_qr_code);
          sql.connect(sqlConfig, function (err) {
              request = new sql.Request();
              request.query(`select TOP(1) range_from,range_to from taco_treceability.taco_treceability.production_count where battery_status='running' and line='6'`, function (err, recordset) {
                  if (err) console.log(err);
                  var result=recordset.recordset;
                  console.log("REsulttttt",result);
                 
                  for(var i=0;i<result;i++){
                      range_from=result[i].range_from;
                      range_to=result[i].range_to;
                  }
                  socket.emit('setrange_from_to',range_from,range_to);
  
              });
          }); */
          socket.emit('setrange_from_to',global_from_test_line6,global_to_test_line6);
  
      });


      socket.on('setRangeFromServer', (global_from_test,global_to_test)=> {
        global_from_test_line6=global_from_test;
        global_to_test_line6=global_to_test;

        console.log("llllliiiinnneeeee6:",global_from_test_line6,global_to_test_line6);
            //    socket.emit('setrange_from_to',global_from_test,global_to_test);

         
    });

    socket.on('getFinalRange_line4', (a)=> {
         var range_fromtemp,range_totemp;
      //  console.log("rrrrrrrrr battery_pack_name,final_qr_code");
          sql.connect(sqlConfig, function (err) {
              request = new sql.Request();
              request.query(`select TOP(1) range_from,range_to from taco_treceability.taco_treceability.production_count where battery_status='running' and line='4'`, function (err, recordset) {
                  if (err) console.log(err);
                  var result=recordset.recordset;
                //  console.log("REsulttttt",result);
                  if(result.length >0){
                   // socket.emit('setFinalRange_line6','2.970','2.990',result);
                    socket.emit('setFinalRange_line4',range_fromtemp,range_totemp,result);
                  }
                //  socket.emit('setFinalRange_line6',range_from,range_to);
                  for(var i=0;i<result;i++){
                    range_fromtemp=result[i].range_from;
                    range_totemp=result[i].range_to;
                   // 
                  }
                  //socket.emit('setFinalRange_line6',range_fromtemp,range_totemp,'2');
                 // socket.emit('setFinalRange_line6','2.970','2.990',result);
  
              });
          }); 
         
  
      });
    async function getBatchDetails(battery_pack_name,final_qr_code) {
        var productionBatches =[];
      //  var productionBatches = await getProductionBatches(battery_pack_name,final_qr_code);
        var line1Batches = await getLineAllowedBatches();
        socket.emit('setBatchDetails',productionBatches,line1Batches);
    }
    async function getDataNow() {
        var runningPackDATA = await getRunningPackDetails();
        var [runningModuleDATA,module_state] = await getRunningModuleDATA();
        var ModuleCompletedCellsDATA = await getRunningModuleCompletedCellsDATA();
        var runningCellDATA = await getRunningCellDATA();
        var remainingModules = await getRemainingModules();
        var remainingCells = await getRemainingCells();
        var rangedata = await getRangeData();
        //var whenModuleCompleted = await whenModuleCompleted();
        //console.log('step3',ree);
        // var packName=runningModuleDATA[0].battery_pack_name;
        // var finalQRCode=runningModuleDATA[0].final_qr_code;
        // var productionBatches = await getProductionBatches(packName,finalQRCode);
        // var line1Batches = await getLineAllowedBatches();

        // socket.emit('current_data', runningPackDATA, runningModuleDATA, runningCellDATA, remainingModules, remainingCells, ModuleCompletedCellsDATA, line1FirstStartFlag, productionBatches, line4Batches);
        socket.emit('current_data', runningPackDATA, runningModuleDATA, runningCellDATA, remainingModules, remainingCells, ModuleCompletedCellsDATA, line1FirstStartFlag,module_state,rangedata);
        return;
    }

    async function getPendingPrints(socket) {
        var runningPackDATA = await getRunningPackDetailsPendingPrints();
        socket.emit('setPendingPrints', runningPackDATA);
    }
    function getRangeData() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`select TOP(1) range_from,range_to from taco_treceability.taco_treceability.production_count where battery_status='running' and line='4'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result=recordset.recordset;
                  //  console.log("REsulttttt",result);
                    if(result.length >0){
                     // socket.emit('setFinalRange_line6','2.970','2.990',result);
                      //socket.emit('setFinalRange_line6',range_fromtemp,range_totemp,result);
                      resolve(result);
                    }
                    else{
                        resolve('na')
                    }
                  //  socket.emit('setFinalRange_line6',range_from,range_to);
                    for(var i=0;i<result;i++){
                      range_fromtemp=result[i].range_from;
                      range_totemp=result[i].range_to;
                     // 
                    }
                    //socket.emit('setFinalRange_line6',range_fromtemp,range_totemp,'2');
                   // socket.emit('setFinalRange_line6','2.970','2.990',result);
    
                });
            });
        })
    }
    function getProductionBatches(battery_pack_name,final_qr_code) {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`select selectedBatches from taco_treceability.taco_treceability.final_qrcode_details where battery_pack_name='${battery_pack_name}' and final_qrcode='${final_qr_code}'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                // `select selectedBatches from final_qrcode_details where battery_pack_name='${battery_pack_name}' and final_qrcode='${final_qr_code}'`, function (err, recordset) {
                    // if (err) console.log(err);
                    //console.log('step 2');
                    resolve(result);
                });
            });
        })
    }
    function getLineAllowedBatches() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT * FROM taco_treceability.taco_treceability.line1runningbatch where LineName='line4'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
            // `SELECT * FROM line1runningbatch`, function (err, recordset) {
                // if (err) console.log(err);
                //console.log('step 2');
                resolve(result);
            });
            });
        })
    }
    function getRunningPackDetailsPendingPrints() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND battery_status = 'running' and line='4'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
            // `SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND battery_status = 'running' and line='4';`, function (err, recordset) {
                // if (err) console.log(err);
                //console.log('step 2');
                resolve(result);
            });
            });
        })
    }
    function getRunningPackDetails() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND battery_status = 'running' and line='4'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                    var k1Array=[1,2,3,4,5,6,7,8,9,10,11,12,13];
                    var k2Array=[1,2,3,4,5,6,7,8,9,10,11,12,13];
                    var limberArray=[1,2,3,4,5,6,7,8];
                    var challengerArray=[1,2,3,4,5,6];
                    var novaArray = [1, 2, 3, 4, 5, 6,7,8,9,10,11];
                    var novalrArray = [1, 2, 3, 4, 5, 6];
                    var tamorArray = [1, 2, 3, 4, 5, 6, 7];
                    var finalArr=[...result];
                    var resArray=[];

                    if(result.length>0) {
                    if(result[0].battery_pack_name == 'Kanger 1 AIO') {
                        for(var i=0;i<k1Array.length;i++) {
                            for(var j=0;j<finalArr.length;j++) {
                                if(k1Array[i]==finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                        
                    } 
                    else if(result[0].battery_pack_name == 'Kanger 2') {
                        for(var i=0;i<k1Array.length;i++) {
                            for(var j=0;j<finalArr.length;j++) {
                                if(k1Array[i]==finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    } 
                    else if(result[0].battery_pack_name == 'Limber') {
                        for(var i=0;i<limberArray.length;i++) {
                            for(var j=0;j<finalArr.length;j++) {
                                if(limberArray[i]==finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    }
                    else if(result[0].battery_pack_name == 'Challenger LR' || result[0].battery_pack_name == 'Challenger MR') {
                        for(var i=0;i<challengerArray.length;i++) {
                            for(var j=0;j<finalArr.length;j++) {
                                if(challengerArray[i]==finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    }
                    else if (result[0].battery_pack_name == 'NOVA MROPS') {
                        for (var i = 0; i < novaArray.length; i++) {
                            for (var j = 0; j < finalArr.length; j++) {
                                if (novaArray[i] == finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    }
                    else if (result[0].battery_pack_name == 'NOVA LROPS') {
                        for (var i = 0; i < novalrArray.length; i++) {
                            for (var j = 0; j < finalArr.length; j++) {
                                if (novalrArray[i] == finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    }
                    else if (result[0].battery_pack_name == 'Tamor') {
                        for (var i = 0; i < tamorArray.length; i++) {
                            for (var j = 0; j < finalArr.length; j++) {
                                if (tamorArray[i] == finalArr[j].moduleNumber) {
                                    resArray.push(finalArr[j]);
                                    finalArr.splice(j, 1);
                                }
                            }
                        }
                    }
                }

            // `SELECT distinct module_barcode,module_name,module_status,moduleNumber,battery_pack_name,final_qr_code FROM taco_treceability.production_count WHERE module_status in ('incomplete','queue','running','complete') AND battery_status = 'running' and line='1';`, function (err, recordset) {
                // if (err) console.log(err);
                //console.log('step 2');
                    resolve(resArray);
                });
            });
        })
    }
    function getRunningModuleDATA() {
        var sqlQuery=`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE module_status='running' AND battery_status = 'running' and line='4' and cell_status NOT in ('invalid')`;
        var Oldquery=`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE module_status='running' AND battery_status = 'running' and line='4';`;
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(Oldquery, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
            // Oldquery, function (err, recordset) {
                // if (err) console.log(err);
              //  console.log('step 2222222222222',result);
                if(result.length > 0){
                    var ModuleRunning = 'ModuleRunning';
                    resolve([result,ModuleRunning]);
                }
                else{
                    request2 = new sql.Request();
                    request2.query(`SELECT * FROM taco_treceability.taco_treceability.station_status WHERE line='4' and ModulePrintStatus='NOT OK'`, function (err, recordset) {
                        if (err) console.log(err);
                        var result = recordset.recordset;
                    // `SELECT * FROM taco_treceability.station_status WHERE line='4' and ModulePrintStatus='NOT OK';`, function (err, recordset) {
                        // if (err) console.log(err);
                       // console.log('step 3');
                        if(result.length > 0){
                            //console.log('wwwwwwww',result.length)
                            resolve([result,'Module_completed']);
                        }
                        else{
                            
                        }
                    });
                }
            });

        });
        })
    }
    function getRunningModuleCompletedCellsDATA() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE module_status='running' AND cell_status = 'complete' AND battery_status = 'running' and line='4'`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
            // `SELECT * FROM taco_treceability.production_count WHERE module_status='running' AND cell_status = 'complete' AND battery_status = 'running' and line='4';`, function (err, recordset) {
                // if (err) console.log(err);
                // console.log('completed cells ',result);
                resolve(result);
            });
            });
        })
    }
    function getRunningCellDATA() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT module_barcode,module_name FROM taco_treceability.taco_treceability.production_count WHERE battery_status = 'running' and line='4' AND module_status in ('incomplete','queue','running','complete')`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
            // `SELECT module_barcode,module_name  FROM taco_treceability.production_count WHERE battery_status = 'running' and line='4' AND module_status in ('incomplete','queue','running','complete') ;`, function (err, recordset) {
                // if (err) console.log(err);
                //console.log('step 2');
                resolve(result);
                });
            });
        })
    }
    function getRemainingModules() {
        return new Promise((resolve, reject) => {
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(`SELECT distinct module_barcode,module_name  FROM taco_treceability.taco_treceability.production_count WHERE battery_status = 'running' and line='4' AND module_status in ('incomplete','queue')`, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                // `SELECT distinct module_barcode,module_name  FROM taco_treceability.production_count WHERE battery_status = 'running' and line='4' AND module_status in ('incomplete','queue');`, function (err, recordset) {
                    // if (err) console.log(err);
                    //console.log('step 2');
                    resolve(result);
                });
            });
        })
    }
    function getRemainingCells() {
        return new Promise((resolve, reject) => {
            var query=`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE battery_status='running' and line='4' AND cell_status in ('incomplete','invalid')`;
            var oldQuery=`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE battery_status='running' and line='4' AND cell_status = 'incomplete';`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(query, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                // query, function (err, recordset) {
                    if (err) console.log(err);
                    //console.log('step 2');
                    resolve(result);
                });
            });
        })
    }

    // console.log('message: ' + packname);



    ////Section 4.3 Check Running module status
    socket.on('checkModuleRunning', (packname) => {
        ///connect to database for details of modules 
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(`SELECT * FROM taco_treceability.taco_treceability.production_count WHERE battery_status='running' and line='4'`, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
        // `SELECT * FROM taco_treceability.production_count WHERE battery_status='running' and line='4';`, function (err, recordset) {
            // if (err) console.log(err);
            // console.log(result);
            if (result.length > 0) {
                socket.emit('modulestatus', result[0].battery_pack_name, 'running', result[0].final_qr_code);
            }
            else {
                socket.emit('modulestatus', 'done');
            }
        });
    });

        // console.log('message: ' + packname);
    });


///section set running batch
// socket.on('loadRunningBatchLine4', (batchname) => {
//     var sqlQry = `UPDATE taco_treceability.taco_treceability.line1runningBatch SET allowed_batch4 = '${batchname}' WHERE LineName = 'line4'`;
//     sql.connect(sqlConfig, function (err) {
//         request = new sql.Request();
//         request.query(sqlQry, function (err, recordset) {
//             if (err) console.log(err);
//             //var result = recordset.recordset;
        
//             // if (err) console.log(err);
//             //console.log(result.affectedRows + "first record(s) updated");
//             resolve();
//         });
//     });


// });

socket.on('saveUsedBatches', (batchname) => {
    console.log("saveUsedBatches:",batchname);
    var sqlQry1 = `SELECT * FROM taco_treceability.taco_treceability.line1runningBatch WHERE LineName = 'line4'`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(sqlQry1, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
            var usedBatches=[];
            if(result.length>0) {
                usedBatches=result[0].mixed_batches;
                console.log("usedBatches indrajit.....................:",usedBatches);
            }
            var dataSplit=[];
            if(usedBatches!='') {
                dataSplit=usedBatches.split(',');
            }
            var new_mixed_batch=dataSplit;
            console.log("dataSplit .....................:",dataSplit,new_mixed_batch);
            if(dataSplit.length<3) {
                for(var i=0;i<dataSplit.length;i++) {
                    console.log("ccccc:",dataSplit[i]);
if(dataSplit.includes(batchname))
{
    console.log("Already Present");
    
}             
else{
    console.log("Record addded..");
    if(i==0 && dataSplit.length==0) {
        new_mixed_batch+=batchname;
    } 
    else if(i==0 && dataSplit.length>0) {
        console.log("Record addded1111111111111111..",dataSplit[i]);
        new_mixed_batch+=","+batchname;

        console.log("ttttttt11111:",new_mixed_batch);
    }
    else {
        console.log("Record addded.222222222222222.",dataSplit[i]);
        new_mixed_batch+=","+batchname;
        console.log("ttttttt22222222:",new_mixed_batch);
    }
}    

                }
                if(dataSplit.length==0) {
                    console.log("Record addded333333333333333333333..");
                   new_mixed_batch=batchname;
                } else {
                   // new_mixed_batch+=','+batchname;
                }
var temparr=new_mixed_batch.toString().split(',');
let uniqueArr = [];
    
    // loop through array
    for(let i of temparr) {
        if(uniqueArr.indexOf(i) === -1) {
            uniqueArr.push(i);
        }
    }

                console.log("Record addded..new_mixed_batch",uniqueArr);
                var sqlQry2 = `UPDATE taco_treceability.taco_treceability.line1runningBatch SET mixed_batches = '${uniqueArr}' WHERE LineName = 'line4'`;
                request.query(sqlQry2, function (err, recordset) {
                    if (err) console.log(err);

                });
            }
        });
    });
});
socket.on('getUsedBatches', (batchname) => {
    var sqlQry1 = `SELECT * FROM taco_treceability.taco_treceability.line1runningBatch WHERE LineName = 'line4'`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(sqlQry1, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
            var usedBatches=[];
            var selectedBatches=[];
            if(result.length>0) {
                if(result[0].mixed_batches!='') {
                    usedBatches=result[0].mixed_batches;
                }
                if(result[0].selected_batches!='') {
                    selectedBatches=result[0].selected_batches;
                }
            }
            socket.emit('setUsedBatchesInPack',usedBatches,selectedBatches); 
        });
    });
});
    ///section 1.2
    socket.on('getModuleDetails', (packname) => {
        ///connect to database for details of modules 
        socket.emit('loadModules', packname);
        //  console.log('message: ' + packname);
    });


    //Section 1.1
    //////////600 cell entries for kanger generate QR and Barcode////////
    async function packRegister(packname, battery_idStr, selectedBatches,shift_incharge,shift_supervisor,range_from,range_to,PacklineNumber) {
console.log("PacklineNumber11111111111",PacklineNumber)
        line1FirstStartFlag=true;
        var splitSelectedBatches=selectedBatches.split(',');
        var iterration1 = 0;
        /////generate FINALQR CODE
        var FINALQRCODE;
        var CustomerQRCode;
        console.log("PacklineNumber222222222222",PacklineNumber)
        FINALQRCODE = await  generateFinalQRCode(packname,PacklineNumber);

        var details = await getCustomerQrCodeDetails(packname);
        var TMLPartNo,DrawingRefNo,supplierCode;
        if(details) {
            var splitDetails=details.split(',');
            TMLPartNo = splitDetails[0];//'00512380600101';
            DrawingRefNo = splitDetails[1];//'OE';
            supplierCode = splitDetails[2];//'T63666';
        } else {
            TMLPartNo = 'NA';
            DrawingRefNo = 'NA';
            supplierCode = 'NA';
        }


        
        var CustPackNumber = FINALQRCODE.substr(FINALQRCODE.length - 6);
        // var TMLPartNo = '00512380600101';
        // var DrawingRefNo = 'OE';
        // if(packname == 'Limber'){
        //     TMLPartNo ='00545680600113';
        //     DrawingRefNo = '0C';
        // }
        // else{
        //     TMLPartNo ='00512386600104';
        //     DrawingRefNo = 'NR';
        // }
        
        // var supplierCode = 'T63666';
        // var MMYY='MMYY';
        var CustSerNo = CustPackNumber;



var tempStr='T635800122000043';
// var TMLPartNo = splitDetails[0];//'00512380600101';
// var DrawingRefNo = splitDetails[1];//'OE';
// /*if(packname == 'Limber'){
//     TMLPartNo ='00545680600113';
//     DrawingRefNo = '0C';
// }
// else if(packname == 'Kanger 1 AIO'){
//     //TMLPartNo ='00512386600104';
//     TMLPartNo ='00512380600104';
//     DrawingRefNo = 'NR';
// } else if(packname == 'Kanger 1 Gen 3'){
//     TMLPartNo ='00512380600101';
//     DrawingRefNo = '0D';
// } else if(packname == 'Kanger 2'){
//     TMLPartNo ='00512380600103';
//     DrawingRefNo = '0A';
// }*/



// var supplierCode = splitDetails[2];//'T63666';
var MMYY='MMYY';
//var CustSerNo = CustPackNumber;
// var dateStr = new Date();
// var curMM = dateStr.getMonth()+1;
// var curYY = dateStr.getFullYear().toString().substring(2,);
// curMM = (curMM.toString().length<2)?"0"+curMM:curMM;
// MMYY=curMM+curYY;
var dateStr = newDateReturn();
var curMM = dateStr.getMonth()+1;
var curYY = dateStr.getFullYear().toString().substring(2,);
curMM = (curMM.toString().length<2)?"0"+curMM:curMM;
var globalMMYY=curMM+curYY;

if (CustSerNo.length == 1) { CustSerNo = '00000' + CustSerNo }
if (CustSerNo.length == 2) { CustSerNo = '0000' + CustSerNo }
if (CustSerNo.length == 3) { CustSerNo = '000' + CustSerNo }
if (CustSerNo.length == 4) { CustSerNo = '00' + CustSerNo }
if (CustSerNo.length == 5) { CustSerNo = '0' + CustSerNo }

CustomerQRCode = TMLPartNo + DrawingRefNo + supplierCode + globalMMYY + CustSerNo;

var Systemyear,SystemMonth,SystemDate,SystemcurrentTime;
var dateToInsertInDB;
var todayDateStr = moment().format("YYYY-MM-DD HH:mm:ss");
var previousDateStr = moment();
previousDateStr = previousDateStr.subtract(1, "days");
previousDateStr = previousDateStr.format("YYYY-MM-DD HH:mm:ss");

//console.log('todayDateStr:',todayDateStr);
//console.log('previousDateStr:',previousDateStr);

var hourStr=todayDateStr.split(' ')[1].split(':');
var hourVar=hourStr[0];
var minuteVar=hourStr[1];
//console.log('hourStr:',hourStr);
//console.log('hourVar:',hourVar);
//console.log('minuteVar:',minuteVar);

// console.log("FINALQRCODE",FINALQRCODE)
// var insert_create_pack_data = await insert_create_pack(packname, FINALQRCODE, PacklineNumber);
// console.log("insert_create_pack_data....",insert_create_pack_data)

if(current_shift==3) {
    if(parseInt(hourVar)>=0 && parseInt(hourVar)<6) { 
        SystemcurrentTime=previousDateStr;
        dateToInsertInDB=previousDateStr;
        var splitStr=previousDateStr.split(" ")[0].split("-");
        Systemyear=splitStr[0];
        SystemMonth=splitStr[1];
        SystemDate=splitStr[2];
    } else if(parseInt(hourVar)==6) {
        if(parseInt(minuteVar)<30) {
            SystemcurrentTime=previousDateStr;
            dateToInsertInDB=previousDateStr;
            var splitStr=previousDateStr.split(" ")[0].split("-");
            Systemyear=splitStr[0];
            SystemMonth=splitStr[1];
            SystemDate=splitStr[2];
        }
    } else {
        SystemcurrentTime=todayDateStr;
        dateToInsertInDB=todayDateStr;
        var splitStr=todayDateStr.split(" ")[0].split("-");
        Systemyear=splitStr[0];
        SystemMonth=splitStr[1];
        SystemDate=splitStr[2];
    }
} else {
    SystemcurrentTime=todayDateStr;
    dateToInsertInDB=todayDateStr;
    var splitStr=todayDateStr.split(" ")[0].split("-");
    Systemyear=splitStr[0];
    SystemMonth=splitStr[1];
    SystemDate=splitStr[2];
}

//console.log('SystemDateSystemDate::',SystemDate);
        // var dateStr = new Date();
        // var curMM = dateStr.getMonth()+1;
        // var curYY = dateStr.getFullYear().toString().substring(2,);
        // curMM = (curMM.toString().length<2)?"0"+curMM:curMM;
        // MMYY=curMM+curYY;
        
     //   CustomerQRCode = TMLPartNo + DrawingRefNo + supplierCode + globalMMYY + CustSerNo;

        // Kaustubh & shubham init call

        finalQRCodeDetailsDBEntry(packname, battery_idStr, FINALQRCODE,CustomerQRCode,selectedBatches,range_from,range_to);

        var packSerialNumberGen = FINALQRCODE.substr(FINALQRCODE.length - 6);
        // console.log('finalQR Code', FINALQRCODE, 'serialnumber', packSerialNumberGen);

        await runQueryInsert(packname, FINALQRCODE, SystemcurrentTime, packSerialNumberGen);
        function runQueryInsert(packname, FINALQRCODE, SystemcurrentTime, packSerialNumberGen) {
            return new Promise((resolve, reject) => {

                var sqlQry = `INSERT INTO taco_treceability.taco_treceability.createPack ( packName,packQRCode, packEntryDate,packSerialNumber,line) VALUES ('${packname}', '${FINALQRCODE}', '${SystemcurrentTime}', '${packSerialNumberGen}','4');`;

                sql.connect(sqlConfig, function (err) {
                    request = new sql.Request();
                    request.query(sqlQry, function (err, recordset) {
                        if (err) console.log(err);
                        var result = recordset.recordset;
                    
                        // if (err) console.log(err);
                        //  console.log("4th step 1 record inserted");
                        resolve();
                        //return;
                    });
                });
            })
        }
      //  packname === 'Kanger 1 AIO';
        var ProdAddress = '4';  // line code
        var packwiseallcellentry=[],module_code_arr=[],module_name_arr=[],countArr=[],module_barcodeArr=[];
        var Vendorcode,ProductType,BatteryType,moduleName,ExtensionCode,ProdPlantCode; // ProdLineCode - is plantcode
        var moduleGroupStr,moduleCellCountNum;
        sql.connect(sqlConfig2, function (err) {
            request = new sql.Request();
            request.query("SELECT * FROM taco_traceability_admin.dbo.battery_pack_details where pack_name='"+packname.replace(/\s+/g, '_')+"' order by module_sequence_number", function (err, recordset) {
                if (err) console.log(err);
                if(recordset){
                    var result1 = recordset.recordset;
                    for (var i in result1) {
                        var pack_name = result1[i].pack_name;
                        var module_name = result1[i].module_name;
                        var module_number = result1[i].module_number;
                        var module_sequence_number = result1[i].module_sequence_number;
                        var cell_count = result1[i].cell_count;

                        packwiseallcellentry.push(pack_name);
                        packwiseallcellentry.push(module_name);
                        packwiseallcellentry.push(module_number);
                        packwiseallcellentry.push(module_sequence_number);
                        packwiseallcellentry.push(cell_count);
                    }
                    setTimeout(function () {
                       
                        request.query("SELECT * FROM taco_traceability_admin.dbo.tml_module_code where module_type_name='"+packname+"'", async function (err, recordset) {
                            if (err) console.log(err);
                            if(recordset){
                                var result1 = recordset.recordset;
                                for (var i in result1) {
                                   var module_code_no = result1[i].module_code_no;
                                   var module_name = result1[i].module_name;

                                   module_code_arr.push(module_code_no);
                                   module_name_arr.push(module_name);
                                }

                                request.query("SELECT TOP(1) * FROM taco_traceability_admin.dbo.tml_nom where type='"+packname+"' ORDER BY sr_no DESC", function (err, recordset) {
                                    if (err) console.log(err);
                                    if(recordset){
                                        var result1 = recordset.recordset;
                                        for (var i in result1) {
                                           var nomenclature = result1[i].nomenclature;

                                         //01TMB01620002-----1
                                         //01TMB---60001-----
                                        
                                       
                                            Vendorcode = nomenclature.substring(0, 3);
                                            ProductType = nomenclature.substring(3, 4);
                                            BatteryType = nomenclature.substring(4, 5);
                                          //  moduleName = nomenclature.substring(5, 8);
                                            batchCode = nomenclature.substring(8, 9);
                                            ExtensionCode = nomenclature.substring(9, 12);
                                            ProdPlantCode = nomenclature.substring(12, 13);

                                            

                                        }

                                        request.query("SELECT Substring(module_name, 1, 1) as Project,COUNT(module_name) as count_module FROM [taco_traceability_admin].[dbo].[battery_pack_details]  where pack_name='"+packname.replace(/\s+/g, '_')+"' group by Substring(module_name, 1, 1)", async function (err, recordset) {
                                            if (err) console.log(err);
                                            if(recordset){
                                                var result1 = recordset.recordset;
                                                for (var i in result1) {
                                                  countArr.push(result1[i].count_module);
                                                }
                                            }
                                            });

                                        var watchdog = 0;

                                        var runningModule;
                                        var moduleIndex;
                                        var moduleNumber = 0;
                                        var MODULEBARCODE_final = '';
                                        var modulesCharArr=[];
(async ()=>{
   // var charCounter=0;
   // var tempChar,previousChar;
    // for(var i=0;i<packwiseallcellentry.length;i=i+5){
    //      tempChar=packwiseallcellentry[i+1].charAt(0);   //A
    //      previousChar=tempChar;
    //      if(packwiseallcellentry[i+1].includes(tempChar)){
            
    //         charCounter++;
    //      }
    //     // if(previousChar) {

    //     // } else {

    //     // }
    //     modulesCharArr.push(packwiseallcellentry[i+1].charAt(0));
    // }

    // for (moduleIndex = 0; moduleIndex < module_code_arr.length; moduleIndex++) {
                                    
        for(var i=0;i<packwiseallcellentry.length;i=i+5){

            moduleNumber=parseInt(packwiseallcellentry[i+3]);
            moduleGroupStr=packwiseallcellentry[i+2];
            moduleCellCountNum=packwiseallcellentry[i+4];
                var ModuleName1 = packwiseallcellentry[i+1];
                // runningModule = A6p6s;    //comment
                /// new module creation 
                
                for (var l = 0; l < parseInt(packwiseallcellentry[i+4]); l++) {
                    //  console.log('iiiiii',l);
                    var rowNum1 = l;
                    var rowName1 = '';
                    var total_cell_count_last=parseInt(packwiseallcellentry[i+4])-1;
                    if (rowNum1 == 0) { rowName1 = 'first'; }
                    else if (rowNum1 == total_cell_count_last) { rowName1 = 'last'; }
                    else { rowName1 = 'mid'; }
                    //startProdEntry(packname, rowName1, ModuleName1, '7', FINALQRCODE,l,runningModule,function(data) {

                    //});

                    var n_index=module_name_arr.indexOf(ModuleName1);
                    var totalModule = countArr[n_index];   //comment
                    if(i==0) {
                        totalModule = countArr[0];
                    }
                    var lastModuleSerialNumber = 0;

                    if (runningModule == 0) {
                        //console.log('runningModulewwwwwwwwwwwwwwwwww', runningModule);
                    }

                    //console.log('value of i',i)
                    if (rowName1 == 'first') {

                        var currentTime = moment().format("YYYY-MM-DD HH:mm:ss");

                        var Year = ''; // done
                        var Month = '';
                        var Date = '';
                        var FeatureCode = '0';
                        var serialNumber = '123456'; ///done

                        ///serial number
                        //console.log('ModuleSerialCode of module', ModuleName1, 'i', i)

                        var serailnumbertempResult;
                        var serialnumbermodulename = ModuleName1

                        var tempArray1 = [];
                        console.log(' 6th step initial array1',tempArray1);

                        ///wait for select to finish
                        tempArray1 = await runModuleSerialQuery173(ModuleName1);
                        console.log("tempArray1",tempArray1)




                        //generateOrbittalFinalQRcode();
                        //generateOrbittalModuleBarcode();

                        //console.log('tempArrayyyyyyyyyyyyyyyyyyyyyyyyy', tempArray1.length);
                        if (tempArray1.length == 0) {
                            tempArray1.push('000000');
                        }
                        lastModuleSerialNumber = tempArray1[tempArray1.length - 1];
                        //console.log('tgtgtgtgtgtgtg',lastModuleSerialNumber)
                        var currentModuleSerialNumber = parseInt(lastModuleSerialNumber) + 1;

                        serialNumber = currentModuleSerialNumber.toString();
                        ///// check positive - negative
                        // var positiveNum=[1,3,5,7,9,10,12];
                        // var negativeNum=[2,4,6,8,11,13];
                        var polarity=packwiseallcellentry[i+2];

                        if(polarity[polarity.length-2]=="+") {
                            if (serialNumber.length == 1) { serialNumber = '10000' + serialNumber.toString() }
                            if (serialNumber.length == 2) { serialNumber = '1000' + serialNumber.toString() }
                            if (serialNumber.length == 3) { serialNumber = '100' + serialNumber.toString() }
                            if (serialNumber.length == 4) { serialNumber = '10' + serialNumber.toString() }
                            if (serialNumber.length == 5) { serialNumber = '1' + serialNumber.toString() }

                        } else if(polarity[polarity.length-2]=="-") {
                            if (serialNumber.length == 1) { serialNumber = '20000' + serialNumber.toString() }
                            if (serialNumber.length == 2) { serialNumber = '2000' + serialNumber.toString() }
                            if (serialNumber.length == 3) { serialNumber = '200' + serialNumber.toString() }
                            if (serialNumber.length == 4) { serialNumber = '20' + serialNumber.toString() }
                            if (serialNumber.length == 5) { serialNumber = '2' + serialNumber.toString() }
                        }

                        
                       
                        // console.log('7th step serial number of packkkkkkkkkkkkkkkkkkkkkkkkkkk', serialNumber)



                        if (Systemyear == 2021) { Year = 'B' } if (Systemyear == 2022) { Year = 'C' } if (Systemyear == 2023) { Year = 'D' } if (Systemyear == 2024) { Year = 'E' } if (Systemyear == 2025) { Year = 'F' } if (Systemyear == 2026) { Year = 'G' }
                        if (SystemMonth == 1) { Month = '1'; } if (SystemMonth == 2) { Month = '2'; } if (SystemMonth == 3) { Month = '3'; } if (SystemMonth == 4) { Month = '4'; } if (SystemMonth == 5) { Month = '5'; } if (SystemMonth == 6) { Month = '6'; } if (SystemMonth == 7) { Month = '7'; } if (SystemMonth == 8) { Month = '8'; } if (SystemMonth == 9) { Month = '9'; } if (SystemMonth == 10) { Month = 'A'; } if (SystemMonth == 11) { Month = 'B'; } if (SystemMonth == 12) { Month = 'C'; }
                        if (SystemDate == 1) { Date = '1'; } if (SystemDate == 2) { Date = '2'; } if (SystemDate == 3) { Date = 3; } if (SystemDate == 4) { Date = '4'; } if (SystemDate == 5) { Date = '5'; } if (SystemDate == 6) { Date = '6'; } if (SystemDate == 7) { Date = '7'; } if (SystemDate == 8) { Date = '8'; } if (SystemDate == 9) { Date = '9'; } if (SystemDate == '10') { Date = 'A'; } if (SystemDate == 11) { Date = 'B'; } if (SystemDate == 12) { Date = 'C'; } if (SystemDate == 13) { Date = 'D'; } if (SystemDate == 14) { Date = 'E'; } if (SystemDate == 15) { Date = 'F'; } if (SystemDate == 16) { Date = 'G'; } if (SystemDate == 17) { Date = 'H'; } if (SystemDate == 18) { Date = 'J'; } if (SystemDate == 19) { Date = 'K'; } if (SystemDate == 20) { Date = 'L'; } if (SystemDate == 21) { Date = 'M'; } if (SystemDate == 22) { Date = 'N'; } if (SystemDate == 23) { Date = 'P'; } if (SystemDate == 24) { Date = 'R'; } if (SystemDate == 25) { Date = 'S'; } if (SystemDate == 26) { Date = 'T'; } if (SystemDate == 27) { Date = 'V'; } if (SystemDate == 28) { Date = 'W'; } if (SystemDate == 29) { Date = 'X'; } if (SystemDate == 30) { Date = 'Y'; } if (SystemDate == 31) { Date = '0'; }

                        var index_module=module_name_arr.indexOf(ModuleName1);
                        moduleName=module_code_arr[index_module];
                        MODULEBARCODE_final = Vendorcode + ProductType + BatteryType + moduleName + batchCode + ExtensionCode + ProdPlantCode + ProdAddress + Year + Month + Date + FeatureCode + serialNumber;

                        
                        //console.log('ModuleBarcode------', MODULEBARCODE_final);
                        module_barcodeArr.push(MODULEBARCODE_final);
                        var moduleSerialNumberGen = MODULEBARCODE_final.substr(MODULEBARCODE_final.length - 6);
                        var moduleIdStr = ModuleName1 + "-" + moduleSerialNumberGen;
                        //console.log('MODULEBARCODE_final ', MODULEBARCODE_final, 'serialnumber', moduleSerialNumberGen);
                        //console.log('running modulbbbbbbbbbbbbbbbbbbbbbbbe', runningModule)
                        addBatteryDetails(battery_idStr, packname, moduleIdStr, ModuleName1, MODULEBARCODE_final, 'incomplete', moduleCellCountNum, FINALQRCODE, moduleGroupStr);

                        ///////////// wait for insert to finish 
                        await runInsertQuery229(ModuleName1, MODULEBARCODE_final, SystemcurrentTime, moduleSerialNumberGen);
                        // function runInsertQuery229(ModuleName1, MODULEBARCODE_final, SystemcurrentTime, moduleSerialNumberGen) {
                        //     return new Promise((resolve, reject) => {
                        //         var sql1 = `INSERT INTO taco_treceability.taco_treceability.createModule ( moduleName,moduleCode, moduleEntryDate,moduleSerialNumber,line) VALUES ('${ModuleName1}', '${MODULEBARCODE_final}', '${SystemcurrentTime}', '${"0"+moduleSerialNumberGen.substring(1,)}','4');`;
                        //         sql.connect(sqlConfig, function (err) {
                        //             request = new sql.Request();
                        //             request.query(sql1, function (err, recordset) {
                        //                 if (err) console.log(err);
                        //                 var result = recordset.recordset;
                                    
                        //                 // if (err) console.log(err);
                        //                 // console.log("7th step 1 record inserted", runningModule);
                        //                 resolve();

                        //             });
                        //         });

                        //     })
                        // }


                        ///////////// insert ends


                        //console.log('running moduleeeeeeeeeeee',runningModule)
                        if (parseInt(runningModule) == 0) {
                            // console.log('first MODULEBARCODE_final',MODULEBARCODE_final)
                            /////wait for insert to finish
                            await runInsertQuery254(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to);
                            function runInsertQuery254(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                var sql2 = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'running', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','first','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                sql.connect(sqlConfig, function (err) {
                                    request = new sql.Request();
                                    request.query(sql2, function (err, recordset) {
                                        if (err) console.log(err);
                                        var result = recordset.recordset;
                                    
                                        // if (err) console.log(err);
                                        // console.log("8th step if 1 record inserted");
                                        // callback(null);

                                    });
                                });

                            }


                            //////insert ends

                        } else {
                            ///wait for insert to finish
                            // console.log('first MODULEBARCODE_final',MODULEBARCODE_final)
                            await runInsertQuery274(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to)

                            function runInsertQuery274(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                return new Promise((resolve, reject) => {
                                    var sql2 = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'queue', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','first','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sql2, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result = recordset.recordset;
                                        
                                            // if (err) console.log(err);
                                            // console.log("9th step else 1 record inserted");
                                            resolve();
                                            // callback(null);
                                        });
                                    });
                                })

                            }

                        }


                    }

                    else if (rowName1 == 'last') {
                        var currentTime = moment().format("YYYY-MM-DD HH:mm:ss");
                        if (parseInt(runningModule) == 0) {
                            // console.log('last MODULEBARCODE_final',MODULEBARCODE_final)
                            await runInsertQuery306(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to)

                            function runInsertQuery306(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                return new Promise((resolve, reject) => {
                                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'running', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','last','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sqlQry, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result = recordset.recordset;
                                        
                                            // if (err) console.log(err);
                                            //console.log("last barcode record inserted",MODULEBARCODE_final);
                                            resolve();
                                            // callback(null);
                                        });
                                    });
                                })
                            }


                        }
                        else {

                            await runInsertQuery325(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to)
                            //console.log('last MODULEBARCODE_final',MODULEBARCODE_final)
                            function runInsertQuery325(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                return new Promise((resolve, reject) => {
                                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'queue', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','last','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sqlQry, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result = recordset.recordset;
                                        
                                            // if (err) console.log(err);
                                            // console.log("last barcode record inserted",MODULEBARCODE_final);
                                            resolve();
                                            // callback(null);
                                        });
                                    });
                                })
                            }

                        }

                    }
                    else {
                        var currentTime = moment().format("YYYY-MM-DD HH:mm:ss");
                        if (parseInt(runningModule) == 0) {
                            //   console.log('mid MODULEBARCODE_final',MODULEBARCODE_final)
                            await runInsertQuery348(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to)
                            //,shift_incharge,shift_supervisor,range_from,range_to
                            function runInsertQuery348(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                return new Promise((resolve, reject) => {
                                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'running', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','mid','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sqlQry, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result = recordset.recordset;
                                        
                                            // if (err) console.log(err);
                                            // console.log("mid barcode record inserted",MODULEBARCODE_final);
                                            resolve();
                                            //callback(null);
                                        });
                                    });
                                })
                            }

                        }
                        else {

                            await runInsertQuery365(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to)
                            //  console.log('mid MODULEBARCODE_final',MODULEBARCODE_final)
                            function runInsertQuery365(packname, ModuleName1, MODULEBARCODE_final, SystemcurrentTime, current_shift, FINALQRCODE, totalModule, moduleNumber,CustomerQRCode,shift_incharge,shift_supervisor,range_from,range_to) {
                                return new Promise((resolve, reject) => {
                                    var sqlQry = `INSERT INTO taco_treceability.taco_treceability.production_count (battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code,CustomerQRCode, date_time_end, total_module, today_date, rownum, moduleNumber,shift_incharge,shift_supervisor,range_from,range_to) VALUES ('${battery_idStr}', '${packname}', '${getNanoSecTime()}', 'running', '${ModuleName1}', 'queue', '${moduleIdStr}','${MODULEBARCODE_final}','incomplete','${SystemcurrentTime}','${current_shift}','4','username','incomplete','${FINALQRCODE}','${CustomerQRCode}','${SystemcurrentTime}','${totalModule}','${SystemcurrentTime}','mid','${moduleNumber}','${shift_incharge}','${shift_supervisor}','${range_from}','${range_to}');`;
                                    sql.connect(sqlConfig, function (err) {
                                        request = new sql.Request();
                                        request.query(sqlQry, function (err, recordset) {
                                            if (err) console.log(err);
                                            var result = recordset.recordset;
                                        
                                            // if (err) console.log(err);
                                            //  console.log("mid barcode record inserted",MODULEBARCODE1);
                                            resolve();
                                            //callback(null);
                                        });
                                    });
                                })
                            }

                        }

                    }


                    // Last module - Last cell entry
                    // if(i==packwiseallcellentry.length-1 && l==parseInt(packwiseallcellentry[i+4])-1)  {
                       
                    // }

                }

                

        }

        var firstmoduleString=module_barcodeArr[0];
        await updateFirstModuleOfPack(firstmoduleString,FINALQRCODE);  // first module running

       
        setTimeout(() => {
            updateCellBarcodeInTestCell(FINALQRCODE);
        }, 5000);
    // }

    // var firstmoduleString=module_barcodeArr[0];
    // await updateFirstModuleOfPack(firstmoduleString,FINALQRCODE);
})();

// (async()=>{
    
//   //  update [taco_treceability].[taco_treceability].[production_count] SET module_status='running' where module_barcode='01TMB016200024D160101387'  and final_qr_code='DJ1828-D160029422'
//     var sql2 = `update taco_treceability.taco_treceability.production_count SET module_status='running' where module_barcode='${firstmoduleString}'  and final_qr_code='${FINALQRCODE}'`;
//                                 sql.connect(sqlConfig, function (err) {
//                                     request = new sql.Request();
//                                     request.query(sql2, function (err, recordset) {
//                                         if (err) console.log(err);
//                                         // var result = recordset.recordset;
                                    
//                                         // if (err) console.log(err);
//                                         // console.log("8th step if 1 record inserted");
//                                         // callback(null);

//                                     });
//                                 });

// })();

                                        
                                    }
                                    });


                                

                                
/////////////////////////////////DYNAMIC PACK CODE START///////////////////////////////////


   

    // if (moduleIndex == 3) {
    //     insertDataInTotalModuleCountTable(battery_idStr, FINALQRCODE);
    // }








/////////////////////////////////////DYNAMIC END /////////////////////////////////////////
                            }
                        }); 
                    }, 200);
                }
            });
        });


        // console.log('5th step')
       


        setTimeout(() => {
            updateCellBarcodeInTestCell(FINALQRCODE);
        }, 15000);


        let result = "Registration successful"; // Replace with actual result if needed
        return result; // Ensure you return something
   
    }
    function cacelPack(final_qr_code) {
        //console.log("cancellllllllllllllllll",final_qr_code);
        return new Promise((resolve, reject) => {
            var sql2 = `UPDATE taco_treceability.taco_treceability.production_count SET battery_status = 'pause'  WHERE final_qr_code = '${final_qr_code}'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(sql2, function (err, recordset) {
                    if (err) console.log(err);
                    //var result = recordset.recordset;
                
                //     if (err) console.log(err);
                    //console.log(result.affectedRows + "first record(s) updated");
                    resolve();
                });
            });
        });
    }
    async function cancelRunningPack(final_qr_code) {
        await cacelPack(final_qr_code);

        var dbQuery=`delete from taco_treceability.taco_treceability.ocv_scanned_cell where line='4'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
            
            //     if (err) console.log(err);
                
            });
        });

    }
    socket.on('get_current_shift', () => {
        socket.emit('set_current_shift', current_shift);
        });
    // socket.on('cancelAndGenerateQR', (packname, final_qr_code) => {
    //     sendToArchive(final_qr_code,'pause');
    //     cancelRunningPack(final_qr_code);
    //     clearAllStationStatusModules(final_qr_code);
    // });
    socket.on('getPackLowerAndUpperLimits', (packname) => {
        sql.connect(sqlConfig2, function (err) {
            request = new sql.Request();
            var sqlQry=`SELECT * from taco_traceability_admin.dbo.batchMix_limit where battery_pack_name='${packname}'`;
            //console.log('getPackLowerAndUpperLimits',sqlQry);
            request.query(sqlQry, function (err, recordset2) {
                if (err) console.log(err);
                var lowerLimit='',upperLimit='';
                if(recordset2) {
                    var result=recordset2.recordset;
                    for(var i in result) {
                        lowerLimit=result[i].l1;
                        upperLimit=result[i].l2;
                    }
                }
                socket.emit('setPackLowerAndUpperLimits', lowerLimit,upperLimit);
            });
        });
    });


    socket.on('cancelAndGenerateQR', (packname, final_qr_code) => {
        console.log("RRRRRRRRRRRRRRR DDDDDDDDDD 222222222222222222222");
     
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query("DELETE FROM taco_treceability.taco_treceability.ocv_machine_data where used_on_line='line_4'", function (err, recordset2) {
                if (err) console.log(err);
                sendToArchive(final_qr_code,'pause');
                cancelRunningPack(final_qr_code);
                clearAllStationStatusModules(final_qr_code);
            });
            // request.query("DELETE FROM taco_treceability.taco_treceability.ocv_machine_data_threedays where used_on_line='line_4'", function (err, recordset2) {
            //     if (err) console.log(err);
               
            // });
        });
    });

    function clearAllStationStatusModules(final_qr_code) {
        var dbQuery=`update taco_treceability.taco_treceability.station_status set ModulePrintStatus='OK' where FinalQRCode='${final_qr_code}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
                //var result = recordset.recordset;
            
            //     if (err) console.log(err);
            });
        });
    }
    function gettingPausedPack() {
        return new Promise((resolve, reject) => {
            var dbQuery=`SELECT DISTINCT battery_pack_name,final_qr_code FROM taco_treceability.taco_treceability.production_count WHERE line='4' and battery_status = 'pause'`;
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(dbQuery, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                // `SELECT DISTINCT battery_pack_name,final_qr_code FROM taco_treceability.production_count WHERE line='4' and battery_status = 'pause'`, function (err, recordset) {
                    // if (err) console.log(err);
                    resolve(result);
                });
            });
        });
    }
    async function getPausedPack() {
       var result_paused =  await gettingPausedPack();
       io.emit('totalPausedPacks',result_paused);
    }
    socket.on('getPausedPack', (msg) => {
        getPausedPack();
    });

    // socket.on('saveselectedBatches', (data) => {
    //     globalAllowedBatches=data.split(',');
    //     //getPausedPack();
    //     var dbQueryUpd = `UPDATE taco_treceability.taco_treceability.line1runningbatch set selected_batches='${data}', plantcode='${globalplant_code}' where LineName='line4'`;
    //     console.log('saveselectedBatches::',dbQueryUpd);
    //     sql.connect(sqlConfig, function (err) {
    //         request = new sql.Request();
    //         request.query(dbQueryUpd, function (err, recordset) {
    //             if (err) console.log(err);
    //         });
    //     });
    // });

    

    socket.on('saveselectedBatches', (data,pck_no,GlobalPackName,plantcode) => {
        globalAllowedBatches=data.split(',');
        //getPausedPack();
        var dbQueryUpd = `UPDATE taco_treceability.taco_treceability.line1runningbatch set selected_batches='${data}', plantcode='${plantcode}', mixed_batches='' where LineName='line4'`;
        console.log('saveselectedBatches::',dbQueryUpd);
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQueryUpd, function (err, recordset) {
                if (err) console.log(err);
            });
        });

        setTimeout(() => {
            var dbQueryinsert = `Insert into taco_treceability.taco_treceability.batchdata(LineName, selected_batches, packno, packname) values('4','${data}','${pck_no}','${GlobalPackName}')`;
            console.log('batch data validation::',dbQueryinsert);
            sql.connect(sqlConfig, function (err) {
                request = new sql.Request();
                request.query(dbQueryinsert, function (err, recordset) {
                    if (err) console.log(err);
                });
            });    
        }, 200);
        

    });

    socket.on('getUsedpacknumber', (linename) => {
        var sqlQry1 = `SELECT TOP(1)* FROM taco_treceability.taco_treceability.batchdata WHERE LineName = '${linename}' order by srno desc`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(sqlQry1, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
                var packnumber,packname;
                if(result.length>0) {
                    
                    packnumber=result[0].packno;
                    packname=result[0].packname;
                
                }
                socket.emit('setUsedpacknumber',packnumber,packname); 
            });
        });
    });

    socket.on('generateQR', (packname, selectedBatches,shift_incharge,shift_supervisor,range_from,range_to,PacklineNumber) => {
        
        console.log('packname,shift_incharge,shift_supervisor,range_from,range_to,PacklineNumber:',packname,shift_incharge,shift_supervisor,range_from,range_to,PacklineNumber);
        ///connect to database for details of modules 
        // Generated BatteryID;
        var ProductCode = '000000';
        var serialNumber = '0000000000'; ///done
        var battery_id = '';
        var LastSerialNumber;
        var newSerialNumber;
        var dd, mm, yyyy;
        var dateObj = new Date();
        dd = dateObj.getDate();
        mm = dateObj.getMonth() + 1;
        yyyy = dateObj.getFullYear();

        dd = (dd.toString().length < 2) ? "0" + dd : dd;
        mm = (mm.toString().length < 2) ? "0" + mm : mm;
        battery_id += dd + "" + mm + "" + yyyy;
        var dbQuery = `SELECT TOP 1 * FROM taco_treceability.taco_treceability.final_qrcode_details order by sr_no desc`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                // if (err) console.log(err);
                var result = recordset.recordset;
            
                if (err) //console.log('generateQR QR Code Error:',err);
                    if (packname == 'Kanger 1 AIO') { ProductCode = 'DJ1828'; } if (packname == 'Kanger 1 Gen 3') { ProductCode = 'DJ1828'; } if (packname == 'Kanger 2') { ProductCode = 'DJ2018'; } if (packname == 'Limber') { ProductCode = 'DJ1921'; }
                    if (packname == 'Challnger LR') { ProductCode = 'DJ1911'; }
                    if (packname == 'Challnger MR') { ProductCode = 'DJ1912'; }
                    if (packname == 'NOVA MROPS') { ProductCode = 'DJ2020'; }
                    if (packname == 'NOVA LROPS') { ProductCode = 'DJ2021'; }
                    if (packname == 'Tamor') { ProductCode = 'DJ2028'; }
                    if (packname == 'NOVA Prismatic LR') { ProductCode = 'DJ2025'; }
                    if (packname == 'CORAL SR') { ProductCode = 'DJ2022'; }
                    battery_id += ProductCode;
                if (result.length > 0) {
                    LastSerialNumber = result[0].battery_id.substring(14,);
                    newSerialNumber = parseInt(LastSerialNumber);

                    serialNumber = newSerialNumber.toString();
                    if (serialNumber.length == 1) { serialNumber = '000000000' + serialNumber }
                    if (serialNumber.length == 2) { serialNumber = '00000000' + serialNumber }
                    if (serialNumber.length == 3) { serialNumber = '0000000' + serialNumber }
                    if (serialNumber.length == 4) { serialNumber = '000000' + serialNumber }
                    if (serialNumber.length == 5) { serialNumber = '00000' + serialNumber }
                    if (serialNumber.length == 6) { serialNumber = '0000' + serialNumber }
                    if (serialNumber.length == 7) { serialNumber = '000' + serialNumber }
                    if (serialNumber.length == 8) { serialNumber = '00' + serialNumber }
                    if (serialNumber.length == 9) { serialNumber = '0' + serialNumber }


                } else {
                    serialNumber = '0000000001';
                }
                battery_id += serialNumber;

                //  packRegister(packname, battery_id, selectedBatches, shift_incharge,shift_supervisor,range_from,range_to);
          
                 packRegister(packname, battery_id, selectedBatches, shift_incharge, shift_supervisor, range_from, range_to,PacklineNumber)
    .then((packregister_comsplete) => {
        console.log("packRegister process completed", packregister_comsplete);
        
         
    })
    .catch((error) => {
        console.error("Error in packRegister:", error);
    });

            // Emit an event back to the client
             socket.emit("qrGenerated");
           
            });
        });




        //socket.emit('loadModules', packname);
        //console.log('message: ' + packname);
    });




});





//////////////Section 1.7 Generate PackSerial Number
function getPackSerialNumber(packname) {
    var resposneGet;
    return new Promise((resolve, reject) => {
        var dbQuery=`SELECT TOP 1 packSerialNumber FROM taco_treceability.createPack WHERE line='4' and packName = '${packname}' ORDER BY srno DESC`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
            // `SELECT packSerialNumber FROM taco_treceability.createPack WHERE line='4' and packName = '${packname}' ORDER BY srno DESC LIMIT 4`, function (err, recordset) {
                // if (err) console.log(err);

                if (result.length > 0) {
                    //   console.log('1st step result', result[0].packSerialNumber);
                    resposneGet = result[0].packSerialNumber;
                    resolve(resposneGet)
                } else { resposneGet = 0; resolve(resposneGet) }
                // console.log('2nd step result', result)


            });
        });
    });
}


function getCustomerQrCodeDetails(packname) {
    var resposneGet;
    return new Promise((resolve, reject) => {
        var dbQuery=`SELECT TOP 1 * FROM taco_traceability_admin.dbo.tml_customerqrcode_nom WHERE battery_pack_name = '${packname}' ORDER BY sr_no`;
        sql.connect(sqlConfig2, function (err) {
            request = new sql.Request();
            request.query(dbQuery, function (err, recordset) {
                if (err) console.log(err);
                var result = recordset.recordset;
            // `SELECT packSerialNumber FROM taco_treceability.createPack WHERE line='4' and packName = '${packname}' ORDER BY srno DESC LIMIT 4`, function (err, recordset) {
                // if (err) console.log(err);

                if (result.length > 0) {
                    //   console.log('1st step result', result[0].packSerialNumber);
                    resposneGet = result[0].part_no+","+result[0].version_no+","+result[0].company_code;
                    resolve(resposneGet)
                } else { resposneGet = 0; resolve(resposneGet) }
                // console.log('2nd step result', result)


            });
        });
    });
}

//////////////////////Section 1.5 Generrate gotionFinalQRCode/////////
// function generateFinalQRCode(packname, rowName, ModuleName, totalModule) {

//     return new Promise((resolve, reject) => {


//     })
// }

async function generateFinalQRCode(packname,PacklineNumber) {

    console.log("PacklineNumber",PacklineNumber)
    // var Vendorcode = '01T';
    // var ProductType = 'P';
    // var BatteryType	= 'C';
    // var moduleName = '017';
    // var ExtensionCode = '000';
    // var ProdLineCode = '1';
    // var ProdAddress = '4';  // line code
    var ProductCode = '000000';
    var Year = ''; // done
    var Month = '';
    var Date = '';
    var FeatureCode = '0';
    var serialNumber = '123456'; ///done
    if (packname == 'Kanger 1 AIO') { ProductCode = 'DJ1828'; } if (packname == 'Kanger 1 Gen 3') { ProductCode = 'DJ1828'; } 
    if (packname == 'Kanger 2') { ProductCode = 'DJ2018'; } if (packname == 'Limber') { ProductCode = 'DJ1921'; }

    if (packname == 'Challnger LR') { ProductCode = 'DJ1911'; }
    if (packname == 'Challnger MR') { ProductCode = 'DJ1912'; }
    if (packname == 'NOVA MROPS') { ProductCode = 'DJ2020'; }
    if (packname == 'NOVA LROPS') { ProductCode = 'DJ2021'; }
    if (packname == 'Tamor') { ProductCode = 'DJ2028'; }
    if (packname == 'NOVA Prismatic LR') { ProductCode = 'DJ2025'; }
    if (packname == 'CORAL SR') { ProductCode = 'DJ2022'; }
      if (packname == 'Ejeeto 21.3') { ProductCode = 'DJ1916'; }
                    if (packname == 'Ejeeto 18.4') { ProductCode = 'DJ1917'; }
                    if (packname == 'SM eBada Dost') { ProductCode = 'DJ1918'; }
                    if (packname == 'SM eDost') { ProductCode = 'DJ1919'; }
                    if (packname == 'Bajaj 5.9') { ProductCode = 'DJ1913'; }
                    if (packname == 'Bajaj 8.9') { ProductCode = 'DJ1914'; }
                    if (packname == 'Bajaj 11.8') { ProductCode = 'DJ1915'; }
                    if (packname == 'Bajaj 12.1') { ProductCode = 'DJ2030'; }
                    if (packname == 'Bajaj 6.1') { ProductCode = 'DJ2041'; }
                    if (packname == 'Bajaj 9.2') { ProductCode = 'DJ2042'; }
                    if (packname == 'Bajaj 12.2') { ProductCode = 'DJ2043'; }
                      if (packname == 'Bajaj 9.2 LL') { ProductCode = 'DJ2051'; }
                     if (packname == 'Bajaj 12.1 LL') { ProductCode = 'DJ2052'; }
                       if (packname == 'EBUS LR') { ProductCode = 'DJ2026'; }
                    if (packname == 'EBUS 283') { ProductCode = 'DJ2029'; }
                    if (packname == 'EBUS 424') { ProductCode = 'DJ2045'; }
                     if (packname == 'EBUS 184') { ProductCode = 'DJ2046';}
                    if (packname == 'Kratos1 450kwh') { ProductCode = 'DJ2023';}
                     if (packname == 'Kratos1 300kwh') { ProductCode = 'DJ2036'; }
                       if (packname == 'Cerus1|Cerus2 300kwh') { ProductCode = 'DJ2038'; }
 if (packname == 'Cerus1|Cerus2|Kratos HD 450kwh') { ProductCode = 'DJ2023'; }
  if (packname == 'EBUS 283') { ProductCode = 'DJ2029'; }
                    if (packname == 'EBUS 424') { ProductCode = 'DJ2045'; }
                     if (packname == 'UPP 39.9') { ProductCode = 'DJ2031'; }
                    if (packname == 'UPP 27.8') { ProductCode = 'DJ2032'; }
                      if (packname == 'TVS 9') { ProductCode = 'DJ1927'; }
                     if (packname == 'NOVA 40kwh') { ProductCode = 'DJ2048'; }
                     
                       

                   
    ///serial number
    var lastPackSerialNumber = PacklineNumber;
    //lastPackSerialNumber = resolve;
    console.log('3rd step result lastPackSerialNumber', lastPackSerialNumber);
    if (lastPackSerialNumber == undefined) { lastPackSerialNumber = 0; }
    var currentPackSerialNumber = parseInt(lastPackSerialNumber);

    serialNumber = currentPackSerialNumber.toString();
    if (serialNumber.length == 1) { serialNumber = '00000' + serialNumber }
    if (serialNumber.length == 2) { serialNumber = '0000' + serialNumber }
    if (serialNumber.length == 3) { serialNumber = '000' + serialNumber }
    if (serialNumber.length == 4) { serialNumber = '00' + serialNumber }
    if (serialNumber.length == 5) { serialNumber = '0' + serialNumber }
    // if (serialNumber.length == 6) { serialNumber = '0' + serialNumber }
    console.log('serial number of module', serialNumber)





    if (Systemyear == '2021') { Year = 'B' } if (Systemyear == '2022') { Year = 'C' } if (Systemyear == '2023') { Year = 'D' } if (Systemyear == '2024') { Year = 'E' } if (Systemyear == '2025') { Year = 'G' } if (Systemyear == '2026') { Year = 'H' }
    if (SystemMonth == 1) { Month = '1'; } if (SystemMonth == 2) { Month = '2'; } if (SystemMonth == 3) { Month = '3'; } if (SystemMonth == 4) { Month = '4'; } if (SystemMonth == 5) { Month = '5'; } if (SystemMonth == 6) { Month = '6'; } if (SystemMonth == 7) { Month = '7'; } if (SystemMonth == 8) { Month = '8'; } if (SystemMonth == 9) { Month = '9'; } if (SystemMonth == 10) { Month = 'A'; } if (SystemMonth == 11) { Month = 'B'; } if (SystemMonth == 12) { Month = 'C'; }
    if (SystemDate == 1) { Date = '1'; } if (SystemDate == 2) { Date = '2'; } if (SystemDate == 3) { Date = 3; } if (SystemDate == 4) { Date = '4'; } if (SystemDate == 5) { Date = '5'; } if (SystemDate == 6) { Date = '6'; } if (SystemDate == 7) { Date = '7'; } if (SystemDate == 8) { Date = '8'; } if (SystemDate == 9) { Date = '9'; } if (SystemDate == '10') { Date = 'A'; } if (SystemDate == 11) { Date = 'B'; } if (SystemDate == 12) { Date = 'C'; } if (SystemDate == 13) { Date = 'D'; } if (SystemDate == 14) { Date = 'E'; } if (SystemDate == 15) { Date = 'F'; } if (SystemDate == 16) { Date = 'G'; } if (SystemDate == 17) { Date = 'H'; } if (SystemDate == 18) { Date = 'J'; } if (SystemDate == 19) { Date = 'K'; } if (SystemDate == 20) { Date = 'L'; } if (SystemDate == 21) { Date = 'M'; } if (SystemDate == 22) { Date = 'N'; } if (SystemDate == 23) { Date = 'P'; } if (SystemDate == 24) { Date = 'R'; } if (SystemDate == 25) { Date = 'S'; } if (SystemDate == 26) { Date = 'T'; } if (SystemDate == 27) { Date = 'V'; } if (SystemDate == 28) { Date = 'W'; } if (SystemDate == 29) { Date = 'X'; } if (SystemDate == 30) { Date = 'Y'; } if (SystemDate == 31) { Date = '0'; }
    var addstr = ProductCode + '-' + Year + Month + Date + serialNumber;
    console.log('3rd and half step added a string', addstr)
    return addstr;
    //return Vendorcode+ProductType+BatteryType+moduleName+ExtensionCode+ProdLineCode+ProdAddress+Year+Month+Date+FeatureCode+serialNumber;



}


function newDateReturn() {
    return new Date();
}





/////////////Section 1.4 calculating shift
var todayG;
var date;
var full_date, yesterday, current_time, current_shift;
var Systemyear;
var SystemMonth;
var SystemDate;
var SystemcurrentTime;
var globalMMYY;
///get year month date
var globalModuleResetFlag=false;

function Rollermachine_details() {
    ///get year month date
    SystemcurrentTime = moment().format("YYYY-MM-DD HH:mm:ss");
    Systemyear = parseInt(new Date().getFullYear());
    SystemMonth = parseInt(new Date().getMonth() + 1);
    SystemDate = parseInt(new Date().getDate());
    todayG = new Date().getFullYear() + '-' + ("0" + (new Date().getMonth() + 1)).slice(-2) + '-' + ("0" + new Date().getDate()).slice(-2);
    date = new Date();
    full_date = date.getFullYear() + ("0" + (date.getMonth() + 1)).slice(-2) + ("0" + date.getDate()).slice(-2) + ("0" + date.getHours() + 1).slice(-2) + ("0" + date.getMinutes()).slice(-2) + ("0" + date.getSeconds()).slice(-2);

    yesterday = new Date().getFullYear() + '-' + ("0" + (new Date().getMonth() + 1)).slice(-2) + '-' + ("0" + (new Date().getDate() - 1)).slice(-2);
    current_time = ("0" + date.getHours() + 1).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2) + ":" + ("0" + date.getSeconds()).slice(-2);
    //console.log("current_shift:", current_shift);
    var currentD = new Date();
    var startHappyHourD = new Date();
    var endHappyHourD = new Date();
    var shift1t1 = startHappyHourD.setHours(06, 00, 00);
    var shift1t2 = endHappyHourD.setHours(13, 59, 59);
    var shift2t1 = startHappyHourD.setHours(14,00, 00);
    var shift2t2 = endHappyHourD.setHours(21, 59, 59);
    var startHappyHoursshift = new Date();
    var endHappyHoursshift = new Date();
    var shift3start = startHappyHoursshift.setHours(23, 37, 00);
    var shift3end = endHappyHoursshift.setHours(23, 59, 59);
    var shift4start = startHappyHoursshift.setHours(00, 00, 01);
    var shift4end = endHappyHoursshift.setHours(06, 54, 00);

    var resetModulet1 = startHappyHourD.setHours(06, 00, 00);
    var resetModulet2 = endHappyHourD.setHours(06, 00, 30);
    var resetModulet3 = endHappyHourD.setHours(06, 00, 40);
    //console.log('currentD',currentD)
    
    //console.log('resetModulet2',resetModulet2)
    //console.log('globalModuleResetFlag value:',globalModuleResetFlag);

    if (currentD >= shift1t1 && currentD <= shift1t2) {
        current_shift = 1;
        currentShift = 1;
    
       if (currentD > resetModulet2 && currentD <= resetModulet3) {
        globalModuleResetFlag=false;
        //console.log('globalModuleResetFlag reset')
       }

    } else if (currentD >= shift2t1 && currentD <= shift2t2) {
        current_shift = 2;
        currentShift = 2;
    } else {
        current_shift = 3;
        currentShift = 3;
    }

    if (currentD >= resetModulet1 && currentD <= resetModulet2) {
        //console.log('In currentD',currentD)
        //console.log('In resetModulet1',resetModulet1)
        //console.log('In resetModulet2',resetModulet2)
        if(globalModuleResetFlag==false) {
            globalModuleResetFlag=true;

            //console.log('Module reset executed!!!!')
            sql.connect(sqlConfig, function (err) {
            var sqlQry = `SELECT pack_name,module_name FROM taco_traceability_admin.dbo.battery_pack_details group by pack_name,module_name`;

            var insertQuery=`insert into taco_treceability.taco_treceability.createmodule(moduleName,moduleEntryDate,moduleSerialNumber,line) values`;
            sql.connect(sqlConfig2, function (err) {
                request = new sql.Request();
                request.query(sqlQry, function (err, recordset) {
                    if (err) console.log(err);
                    var result = recordset.recordset;
                
                    for(var j=0;j<result.length;j++) {
                        if(j==0) {
                            insertQuery+=`('${result[j].module_name}','${SystemcurrentTime}','000000','4')`;
                        } else {
                            insertQuery+=`,('${result[j].module_name}','${SystemcurrentTime}','000000','4')`;
                        }
                    }
                    
                    //console.log('insertQuery::',insertQuery);
                    
                        request = new sql.Request();
                            request.query(insertQuery, function (err, recordset) {
                            if (err) console.log(err);
                            //console.log('Module reset insertQuery executed!!!!')
                        });
                    
                });
            });

        });

        }
    }


    // Date time
    var date = new Date(),
        year = date.getFullYear(),
        month = (date.getMonth() + 1).toString(),
        formatedMonth = (month.length === 1) ? ("0" + month) : month,
        day = date.getDate().toString(),
        formatedDay = (day.length === 1) ? ("0" + day) : day,
        hour = date.getHours().toString(),
        formatedHour = (hour.length === 1) ? ("0" + hour) : hour,
        minute = date.getMinutes().toString(),
        formatedMinute = (minute.length === 1) ? ("0" + minute) : minute,
        second = date.getSeconds().toString(),
        formatedSecond = (second.length === 1) ? ("0" + second) : second;
    var str = formatedDay + "/" + formatedMonth + "/" + year + " " + formatedHour + ':' + formatedMinute + ':' + formatedSecond;
    newdate = year + "-" + formatedMonth + "-" + formatedDay + " ";
    //yyyy-mm-dd 10:00:00
    time1 = hour + ":" + minute + ":" + second;
    //    console.log("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@", newdate);

    var dateStr = new Date();
        var curMM = dateStr.getMonth()+1;
        var curYY = dateStr.getFullYear().toString().substring(2,);
        curMM = (curMM.toString().length<2)?"0"+curMM:curMM;
        globalMMYY=curMM+curYY;

    /******** one day minus for shift 3 start code*********/
    var date = new Date(),
        year = date.getFullYear(),
        month = (date.getMonth() + 1).toString(),
        formatedMonth = (month.length === 1) ? ("0" + month) : month,
        day = date.getDate().toString(),
        formatedDay = (day.length === 1) ? ("0" + day) : day,
        hour = date.getHours().toString(),
        formatedHour = (hour.length === 1) ? ("0" + hour) : hour,
        minute = date.getMinutes().toString(),
        formatedMinute = (minute.length === 1) ? ("0" + minute) : minute,
        second = date.getSeconds().toString(),
        formatedSecond = (second.length === 1) ? ("0" + second) : second;
    var str = formatedDay + "/" + formatedMonth + "/" + year + " " + formatedHour + ':' + formatedMinute + ':' + formatedSecond;
    var newdate = year + "-" + formatedMonth + "-" + formatedDay + " " + formatedHour + "-" + formatedMinute + "-" + formatedSecond;

    time1 = hour + ":" + minute + ":" + second;


    globtime = year + "-" + formatedMonth + "-" + formatedDay;
    var myCurrentDate = new Date();

    var myPastDate = new Date(myCurrentDate);
    myPastDate.setDate(myPastDate.getDate() - 1);
    var year1 = myPastDate.getFullYear(),
        month1 = (myPastDate.getMonth() + 1).toString(),
        formatedMonth1 = (month1.length === 1) ? ("0" + month1) : month1,
        day1 = myPastDate.getDate().toString(),
        formatedDay1 = (day1.length === 1) ? ("0" + day1) : day1;
    globtimeminus = year1 + "-" + formatedMonth1 + "-" + formatedDay1;
    //   console.log("date minus", globtime)

    /******** one day minus for shift 3 start end*********/
   // console.log('current_shift:::::::->', current_shift);
}

setInterval(Rollermachine_details, 1000);

setTimeout(() => {
    //console.log('getNanoSecTime:',getNanoSecTime());
    //throw "Error";
}, 2000);


function getNanoSecTime() {
    var testSerial = Math.floor(100000 + Math.random() * 500000);
    var testSerial2 = Math.floor(500000 + Math.random() * 800000);
    var testSerial3 = Math.floor(800000 + Math.random() * 900000);
    var hrTime = process.hrtime();
    return SystemcurrentTime+"|"+hrTime[0]*1000000000+hrTime[1]+"|"+testSerial+"|"+testSerial2+"|"+testSerial3;
}



// Kaustubh Code - FinalQRCode section
function finalQRCodeDetailsDBEntry(battery_pack_name,battery_id,final_qrcode,CustomerQRCode,selectedBatches,range_from,range_to) {
    var dbQuery = `INSERT INTO taco_treceability.taco_treceability.final_qrcode_details (battery_pack_name, battery_id,status, final_qrcode, other_modules,CustomerQRCode,selectedBatches) VALUES ('${battery_pack_name}', '${battery_id}', 'Generated', '${final_qrcode}', '','${CustomerQRCode}','${selectedBatches}')`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('Final QR Code Error:',err);
            var result = recordset.recordset;
        
            //console.log('Final QR Code Entry Successful');

            var sqlInsert;
            var new_battery_pack_name=battery_pack_name.replace(/\s+/g, '_');
            var selectBOMData=`SELECT * FROM taco_traceability_admin.dbo.bom_details where battery_pack_name='${new_battery_pack_name}'`;
            sql.connect(sqlConfig2, function (err) {
                request = new sql.Request();
            request.query(selectBOMData, function (err, recordset) {
                // if (err) console.log(err);
                if (err) console.log('Final QR Code Error:',err);
                var result = recordset.recordset;

                sqlInsert=`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode) 
                values `;
                for(var i in result) {
                    if(i==0) {
                        sqlInsert+=`('${battery_id}','${battery_pack_name}','${result[i].module_id}','${result[i].module_name}','${result[i].module_cell_count}','','incomplete','other','${final_qrcode}')`;
                    } else {
                        sqlInsert+=`,('${battery_id}','${battery_pack_name}','${result[i].module_id}','${result[i].module_name}','${result[i].module_cell_count}','','incomplete','other','${final_qrcode}')`;
                    }
                }
            /*if(battery_pack_name == "Kanger 1 AIO") {
                sqlInsert=`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode) 
                values 
                ('${battery_id}','${battery_pack_name}','2050000041','2050000041','600','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006052','5040006052','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006053','5040006053','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006037','5040006037','2','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006036','5040006036','2','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006075','5040006075','7','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006077','5040006077','7','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040007497','5040007497','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040007498','5040007498','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040008575','5040008575','1','','incomplete','other','${final_qrcode}');`
            } else if(battery_pack_name == "Kanger 1 Gen 3") {
                sqlInsert=`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode) 
                values 
                ('${battery_id}','${battery_pack_name}','2050000041','2050000041','600','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006052','5040006052','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006053','5040006053','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006037','5040006037','2','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006036','5040006036','2','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006075','5040006075','7','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040006077','5040006077','7','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040022468','5040022468','1','','incomplete','other','${final_qrcode}');`
            } else if(battery_pack_name == "Limber") {
                sqlInsert=`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode) 
                values 
                ('${battery_id}','${battery_pack_name}','2050000041','2050000041','540','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040008575','5040008575','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040007497','5040007497','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040014429','5040014429','2','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040014570','5040014570','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040014569','5040014569','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040014574','5040014574','4','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040014573','5040014573','4','','incomplete','other','${final_qrcode}');`
            } else if(battery_pack_name == "Kanger 2") {
                sqlInsert=`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode) 
                values 
                ('${battery_id}','${battery_pack_name}','2050000041','2050000041','832','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040022468','5040022468','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020579','5040020579','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020688','5040020688','1','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020689','5040020689','6','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020690','5040020690','6','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020698','5040020698','6','','incomplete','other','${final_qrcode}'),
                ('${battery_id}','${battery_pack_name}','5040020691','5040020691','6','','incomplete','other','${final_qrcode}');`
            }*/

            if(result.length>0) {
                sql.connect(sqlConfig, function (err) {
                    
                request2 = new sql.Request();
                request2.query(sqlInsert, function (err, recordset) {
                    // if (err) console.log(err);
                    if (err) console.log('Final QR Code battery_details Error:',err);
                    var result = recordset.recordset;
                // sqlInsert, function (err, recordset) {
                    //console.log('Final QR Code battery_details Entry Successful');
                    
                    // Insert into PDI
                    insertPDITableEntry(battery_id,final_qrcode);

                    // Insert into TestCell
                    addTestCellEntry(final_qrcode,battery_pack_name,range_from,range_to);

                    // Insert into airleakage
                    addAirLeakageEntry(battery_id,battery_pack_name,final_qrcode);
                });
            });
            } else {
                // If no BOM details present
                insertPDITableEntry(battery_id,final_qrcode);

                // Insert into TestCell
                addTestCellEntry(final_qrcode,battery_pack_name,range_from,range_to);

                // Insert into airleakage
                addAirLeakageEntry(battery_id,battery_pack_name,final_qrcode);
            }

        });

    });
            
        });
    });
}

function addAirLeakageEntry(battery_id,battery_pack_name,final_qrcode) {
    var dbQuery =`insert into taco_treceability.taco_treceability.air_leakage_testing(battery_id,battery_pack_name,final_qrcode,body_reading_unit,coolant_reading_unit) values('${battery_id}','${battery_pack_name}','${final_qrcode}','Pa','bar')`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('AirLeakageEntry Error:',err);
            var result = recordset.recordset;
        
            // if (err) console.log('AirLeakageEntry Error:',err);
            //console.log('AirLeakageEntry Entry Successful');
        });
    });
}

// function addBatteryDetails(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type) {
function addBatteryDetails(battery_id, battery_pack_name, module_id, module_name, module_barcode_string, module_status, module_cell_count,final_qrcode, module_number) {
    //add battery details entries
    var newModuleName=module_name.split('-')[1]+"-"+module_name.split('-')[2];
    
    //console.log('newModuleName:::::::::::::::::', newModuleName);
    var module_group_str,module_group_str2;
    module_group_str=module_number;

    /*
    if(battery_pack_name=="Limber")  {
        switch(parseInt(module_number)) {
            case 1: module_group_str='M1'; break;
            case 2: module_group_str='M2'; break;
            case 3: module_group_str='M3'; break;
            case 4: module_group_str='M4'; break;
            case 5: module_group_str='M5'; break;
            case 6: module_group_str='M6'; break;
            case 7: module_group_str='M7'; break;
            case 8: module_group_str='M8'; break;
        }
    
        switch(parseInt(module_number)) {
            case 1: module_group_str2='M1(+)'; break;
            case 2: module_group_str2='M2(-)'; break;
            case 3: module_group_str2='M3(+)'; break;
            case 4: module_group_str2='M4(-)'; break;
            case 5: module_group_str2='M5(+)'; break;
            case 6: module_group_str2='M6(-)'; break;
            case 7: module_group_str2='M7(+)'; break;
            case 8: module_group_str2='M8(-)'; break;
        }
    } else if(battery_pack_name=="Kanger 2") {
        switch(parseInt(module_number)) {
            case 1: module_group_str2='A1'; break;
            case 2: module_group_str2='B2'; break;
            case 3: module_group_str2='B3'; break;
            case 4: module_group_str2='B4'; break;
            case 5: module_group_str2='B5'; break;
            case 6: module_group_str2='B6'; break;
            case 7: module_group_str2='B7'; break;
            case 8: module_group_str2='C8'; break;
            case 9: module_group_str2='C9'; break;
            case 10: module_group_str2='C10'; break;
            case 11: module_group_str2='C11'; break;
            case 12: module_group_str2='C12'; break;
            case 13: module_group_str2='C13'; break;
        }
    } else {
        switch(parseInt(module_number)) {
            case 1: module_group_str2='A1(+)'; break;
            case 2: module_group_str2='A2(-)'; break;
            case 3: module_group_str2='A3(+)'; break;
            case 4: module_group_str2='A4(-)'; break;
            case 5: module_group_str2='A5(+)'; break;
            case 6: module_group_str2='A6(-)'; break;
            case 7: module_group_str2='A7(+)'; break;
            case 8: module_group_str2='B8(-)'; break;
            case 9: module_group_str2='B13(+)'; break;
            case 10: module_group_str2='C9(+)'; break;
            case 11: module_group_str2='C10(-)'; break;
            case 12: module_group_str2='C11(+)'; break;
            case 13: module_group_str2='C12(-)'; break;
        }
    }
    */

    var dbQuery =`insert into taco_treceability.taco_treceability.battery_details(battery_id, battery_pack_name, module_id, module_name, module_cell_count, module_barcode_string, module_status, module_type,final_qrcode,module_number) values ('${battery_id}','${battery_pack_name}','${module_id}','${module_name}','${module_cell_count}','${module_barcode_string}','${module_status}','main','${final_qrcode}','${module_group_str}')`;
    // var dbQuery = `INSERT INTO final_qrcode_details (battery_pack_name, battery_id,status, final_qrcode, other_modules) VALUES ('${battery_pack_name}', '${battery_id}', 'Generated', '${final_qrcode}', '')`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('Final QR Code Error:',err);
            var result = recordset.recordset;
        
            //console.log('BatteryDetails Entry Successful');

            // update module barcode in testcell table
            
            var dbQuery2 =`update taco_treceability.taco_treceability.test_cell_table set module_barcode='${module_barcode_string}' where final_qrcode='${final_qrcode}' and module_group='${module_group_str}'`;
            // var dbQuery = `INSERT INTO final_qrcode_details (battery_pack_name, battery_id,status, final_qrcode, other_modules) VALUES ('${battery_pack_name}', '${battery_id}', 'Generated', '${final_qrcode}', '')`;
            request2 = new sql.Request();
            request2.query(dbQuery2, function (err, recordset) {
                // if (err) console.log(err);
                if (err) console.log('testcell testcellFinal QR Code Error:',err);
                //var result = recordset.recordset;
            // dbQuery2, function (err, recordset) {
                
                //console.log('testcell Entry Successful');
            });
        });
    });
}


function updateCellBarcodeInTestCell(final_qrcode) {
    var dbQry=`SELECT module_barcode,final_qr_code,moduleNumber,battery_pack_name FROM taco_treceability.production_count where final_qr_code='${final_qrcode}' group by module_barcode,final_qr_code,moduleNumber,battery_pack_name`;
    
    var resultData=[];
    var module_group_str;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQry, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('Final QR Code Error:',err);
            var result = recordset.recordset;
            for(var i in result) {
                resultData.push({
                    "module_barcode": result[i].module_barcode,
                    "final_qr_code": result[i].final_qr_code,
                    "moduleNumber": result[i].moduleNumber,
                    "battery_pack_name": result[i].battery_pack_name
                })
            }

            if(resultData.length>0) {
                async.eachSeries(resultData, function (element, callback) { 
                    if(element.battery_pack_name=="Limber")  {
                        switch(parseInt(element.moduleNumber)) {
                            case 1: module_group_str='M1'; break;
                            case 2: module_group_str='M2'; break;
                            case 3: module_group_str='M3'; break;
                            case 4: module_group_str='M4'; break;
                            case 5: module_group_str='M5'; break;
                            case 6: module_group_str='M6'; break;
                            case 7: module_group_str='M7'; break;
                            case 8: module_group_str='M8'; break;
                        }
                    } else if(element.battery_pack_name=="Kanger 2") {
                        switch(parseInt(element.moduleNumber)) {
                            case 1: module_group_str='A1'; break;
                            case 2: module_group_str='B2'; break;
                            case 3: module_group_str='B3'; break;
                            case 4: module_group_str='B4'; break;
                            case 5: module_group_str='B5'; break;
                            case 6: module_group_str='B6'; break;
                            case 7: module_group_str='B7'; break;
                            case 8: module_group_str='C8'; break;
                            case 9: module_group_str='C9'; break;
                            case 10: module_group_str='C10'; break;
                            case 11: module_group_str='C11'; break;
                            case 12: module_group_str='C12'; break;
                            case 13: module_group_str='C13'; break;
                        }
                    } else if(element.battery_pack_name=="Challenger LR" || element.battery_pack_name=="Challenger MR") {
                        switch(parseInt(element.moduleNumber)) {
                            case 1: module_group_str='A1'; break;
                            case 2: module_group_str='B1'; break;
                            case 3: module_group_str='B2'; break;
                            case 4: module_group_str='B3'; break;
                            case 5: module_group_str='B4'; break;
                            case 6: module_group_str='B5'; break;
                        }
                    } 
                    else if (element.battery_pack_name == "NOVA MROPS") {
                        switch (parseInt(element.moduleNumber)) {
                            case 1: module_group_str = 'A1'; break;
                            case 2: module_group_str = 'A2'; break;
                            case 3: module_group_str = 'A3'; break;
                            case 4: module_group_str = 'A4'; break;
                            case 5: module_group_str = 'A5'; break;
                            case 6: module_group_str = 'B6'; break;
                            case 7: module_group_str = 'B7'; break;
                            case 8: module_group_str = 'B8'; break;
                            case 9: module_group_str = 'B9'; break;
                            case 10: module_group_str = 'B10'; break;
                            case 11: module_group_str = 'B11'; break;
                        }
                    } 
                    else if (element.battery_pack_name == "NOVA LROPS") {
                        switch (parseInt(element.moduleNumber)) {
                            case 1: module_group_str = 'M1'; break;
                            case 2: module_group_str = 'M2'; break;
                            case 3: module_group_str = 'M3'; break;
                            case 4: module_group_str = 'M4'; break;
                            case 5: module_group_str = 'M5'; break;
                            case 6: module_group_str = 'M6'; break;
                        }
                    } 
                    else if (element.battery_pack_name == "Tamor") {
                        switch (parseInt(element.moduleNumber)) {
                            case 1: module_group_str = 'A1'; break;
                            case 2: module_group_str = 'B2'; break;
                            case 3: module_group_str = 'B3'; break;
                            case 4: module_group_str = 'C4'; break;
                            case 5: module_group_str = 'C5'; break;
                            case 6: module_group_str = 'C6'; break;
                            case 7: module_group_str = 'C7'; break;
                        }
                    } 
                    else {
                        switch(parseInt(element.moduleNumber)) {
                            case 1: module_group_str='A1'; break;
                            case 2: module_group_str='A2'; break;
                            case 3: module_group_str='A3'; break;
                            case 4: module_group_str='A4'; break;
                            case 5: module_group_str='A5'; break;
                            case 6: module_group_str='A6'; break;
                            case 7: module_group_str='A7'; break;
                            case 8: module_group_str='B8'; break;
                            case 9: module_group_str='B13'; break;
                            case 10: module_group_str='C9'; break;
                            case 11: module_group_str='C10'; break;
                            case 12: module_group_str='C11'; break;
                            case 13: module_group_str='C12'; break;
                        }
                    }

                    var dbQuery2 =`update taco_treceability.taco_treceability.test_cell_table set module_barcode='${element.module_barcode}' where final_qrcode='${final_qrcode}' and module_group='${module_group_str}'`;
                    //var cell_barcode_arr=[],cell_barcode_arr1=[],moduleID,moduleName,moduleStatus,totalModule,moduleNumber;
                    request.query(dbQuery2, function (err, recordset) {
                        if (err) console.log(err);
                        callback();
                    });

                }, function (err) {
                    //console.log("test_cell_table updated"); 
                });
            }
        });
    });
}


function addTestCellEntry(final_qrcode,packname,range_from,range_to) {

 var arr1=[];
    sql.connect(sqlConfig2, function (err) {  //sql connection ch object kay ahe admin sathi
        request = new sql.Request();
        var dbSQL="SELECT * FROM taco_traceability_admin.dbo.battery_pack_voltage_n_ir_details where pack_name='"+packname.replace(/\s+/g, '_')+"' order by sequence_number";
        //console.log('dbSQL:',dbSQL);
        request.query(dbSQL, function (err, recordset) {
            if (err) console.log(err);
            if(recordset){
                var result1 = recordset.recordset;
                for (var i in result1) {
                    var point1 = result1[i].point1;
                    var point2 = result1[i].point2;
                    var bms_no = result1[i].bms_no;
                    var actual_no = result1[i].actual_no;
                    var module_group = result1[i].module_group;
                  
                    arr1.push(point1);
                    arr1.push(point2);
                    arr1.push(bms_no);
                    arr1.push(actual_no);
                    arr1.push(module_group);
                }
                setTimeout(function () {
                  for(var m=0;m<arr1.length;m=m+5){
                    insertaddTestCellEntry(arr1[m],arr1[m+1],"","",'NULL',arr1[m+2],"",final_qrcode,arr1[m+3],"","","",arr1[m+4],range_from,range_to);
                  }
                }, 200);
            }
        });
    });
}
function insertaddTestCellEntry(point_1, point_2, voltage, IR, status, bms_no, battery_id, final_qrcode, actual_no, remark_by, checked_by, made_by, module_group,min_voltage,max_voltage){
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(`INSERT INTO taco_treceability.taco_treceability.test_cell_table(point_1, point_2, voltage, IR, status, bms_no, battery_id, final_qrcode, actual_no, remark_by, checked_by, made_by, module_group,min_voltage,max_voltage) VALUES ('${point_1}', '${point_2}', '', '', '${status}', '${bms_no}', '${battery_id}', '${final_qrcode}', '${actual_no}', '${remark_by}', '${checked_by}', '${made_by}', '${module_group}','${min_voltage}','${max_voltage}')`, function (err, recordset) {
            if (err) console.log('addTestCellEntry Error:',err);
        });
    });
}
/*function addTestCellEntry(final_qrcode,packname,range_from,range_to) {
    //voltage ir testing entries

    var testCellKanger2=`INSERT INTO taco_treceability.taco_treceability.test_cell_table(point_1, point_2, voltage, IR, status, bms_no, battery_id, final_qrcode, actual_no, remark_by, checked_by, made_by, module_group,min_voltage,max_voltage) VALUES 
('NA','NA','','',NULL,'NA','','${final_qrcode}','1','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','2','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','3','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','4','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','5','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','6','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','7','','','','A1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','8','','','','A1','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','9','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','10','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','11','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','12','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','13','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','14','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','15','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','16','','','','B2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','17','','','','B2','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','18','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','19','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','20','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','21','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','22','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','23','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','24','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','25','','','','B3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','26','','','','B3','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','27','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','28','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','29','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','30','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','31','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','32','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','33','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','34','','','','B4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','35','','','','B4','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','36','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','37','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','38','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','39','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','40','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','41','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','42','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','43','','','','B5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','44','','','','B5','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','45','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','46','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','47','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','48','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','49','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','50','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','51','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','52','','','','B6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','53','','','','B6','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','54','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','55','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','56','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','57','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','58','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','59','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','60','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','61','','','','B7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','62','','','','B7','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','63','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','64','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','65','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','66','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','67','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','68','','','','C8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','69','','','','C8','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','70','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','71','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','72','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','73','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','74','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','75','','','','C9','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','76','','','','C9','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','77','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','78','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','79','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','80','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','81','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','82','','','','C10','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','83','','','','C10','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','84','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','85','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','86','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','87','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','88','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','89','','','','C11','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','90','','','','C11','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','91','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','92','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','93','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','94','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','95','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','96','','','','C12','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','97','','','','C12','${range_from}','${range_to}'),

('NA','NA','','',NULL,'NA','','${final_qrcode}','98','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','99','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','100','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','101','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','102','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','103','','','','C13','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','104','','','','C13','${range_from}','${range_to}')`;

    var testCellKanger=`INSERT INTO taco_treceability.taco_treceability.test_cell_table(point_1, point_2, voltage, IR, status, bms_no, battery_id, final_qrcode, actual_no, remark_by, checked_by, made_by, module_group,min_voltage,max_voltage) VALUES 
    ('B-100-1','B-99-6','','',NULL,'64','','${final_qrcode}','100','','','','A1','${range_from}','${range_to}'),
    ('B-99-7','B-98-6','','',NULL,'63','','${final_qrcode}','99','','','','A1','${range_from}','${range_to}'),
    ('B-98-7','B-97-6','','',NULL,'62','','${final_qrcode}','98','','','','A1','${range_from}','${range_to}'),
    ('B-97-7','B-96-6','','',NULL,'61','','${final_qrcode}','97','','','','A1','${range_from}','${range_to}'),
    ('B-96-7','B-95-6','','',NULL,'60','','${final_qrcode}','96','','','','A1','${range_from}','${range_to}'),
    ('B-95-7','B-95-18','','',NULL,'59','','${final_qrcode}','95','','','','A1','${range_from}','${range_to}'),
    ('B-94-1','B-93-6','','',NULL,'76','','${final_qrcode}','94','','','','A2','${range_from}','${range_to}'),
    ('B-93-7','B-92-6','','',NULL,'75','','${final_qrcode}','93','','','','A2','${range_from}','${range_to}'),
    ('B-92-7','B-91-6','','',NULL,'74','','${final_qrcode}','92','','','','A2','${range_from}','${range_to}'),
    ('B-91-7','B-90-6','','',NULL,'73','','${final_qrcode}','91','','','','A2','${range_from}','${range_to}'),
    ('B-90-7','B-89-6','','',NULL,'72','','${final_qrcode}','90','','','','A2','${range_from}','${range_to}'),
    ('B-89-7','B-89-18','','',NULL,'71','','${final_qrcode}','89','','','','A2','${range_from}','${range_to}'),
    ('B-88-1','B-87-6','','',NULL,'70','','${final_qrcode}','88','','','','A3','${range_from}','${range_to}'),
    ('B-87-7','B-86-6','','',NULL,'69','','${final_qrcode}','87','','','','A3','${range_from}','${range_to}'),
    ('B-86-7','B-85-6','','',NULL,'68','','${final_qrcode}','86','','','','A3','${range_from}','${range_to}'),
    ('B-85-7','B-84-6','','',NULL,'67','','${final_qrcode}','85','','','','A3','${range_from}','${range_to}'),
    ('B-84-7','B-83-6','','',NULL,'66','','${final_qrcode}','84','','','','A3','${range_from}','${range_to}'),
    ('B-83-7','B-83-18','','',NULL,'65','','${final_qrcode}','83','','','','A3','${range_from}','${range_to}'),
    ('B-82-1','B-81-6','','',NULL,'88','','${final_qrcode}','82','','','','A4','${range_from}','${range_to}'),
    ('B-81-7','B-80-6','','',NULL,'87','','${final_qrcode}','81','','','','A4','${range_from}','${range_to}'),
    ('B-80-7','B-79-6','','',NULL,'86','','${final_qrcode}','80','','','','A4','${range_from}','${range_to}'),
    ('B-79-7','B-78-6','','',NULL,'85','','${final_qrcode}','79','','','','A4','${range_from}','${range_to}'),
    ('B-78-7','B-77-6','','',NULL,'84','','${final_qrcode}','78','','','','A4','${range_from}','${range_to}'),
    ('B-77-7','B-77-18','','',NULL,'83','','${final_qrcode}','77','','','','A4','${range_from}','${range_to}'),
    ('B-76-1','B-75-6','','',NULL,'82','','${final_qrcode}','76','','','','A5','${range_from}','${range_to}'),
    ('B-75-7','B-74-6','','',NULL,'81','','${final_qrcode}','75','','','','A5','${range_from}','${range_to}'),
    ('B-74-7','B-73-6','','',NULL,'80','','${final_qrcode}','74','','','','A5','${range_from}','${range_to}'),
    ('B-73-7','B-72-6','','',NULL,'79','','${final_qrcode}','73','','','','A5','${range_from}','${range_to}'),
    ('B-72-7','B-71-6','','',NULL,'78','','${final_qrcode}','72','','','','A5','${range_from}','${range_to}'),
    ('B-71-7','B-71-18','','',NULL,'77','','${final_qrcode}','71','','','','A5','${range_from}','${range_to}'),
    ('B-70-1','B-69-6','','',NULL,'100','','${final_qrcode}','70','','','','A6','${range_from}','${range_to}'),
    ('B-69-7','B-68-6','','',NULL,'99','','${final_qrcode}','69','','','','A6','${range_from}','${range_to}'),
    ('B-68-7','B-67-6','','',NULL,'98','','${final_qrcode}','68','','','','A6','${range_from}','${range_to}'),
    ('B-67-7','B-66-6','','',NULL,'97','','${final_qrcode}','67','','','','A6','${range_from}','${range_to}'),
    ('B-66-7','B-65-6','','',NULL,'96','','${final_qrcode}','66','','','','A6','${range_from}','${range_to}'),
    ('B-65-7','B-65-18','','',NULL,'95','','${final_qrcode}','65','','','','A6','${range_from}','${range_to}'),
    ('B-64-1','B-63-6','','',NULL,'94','','${final_qrcode}','64','','','','A7','${range_from}','${range_to}'),
    ('B-63-7','B-62-6','','',NULL,'93','','${final_qrcode}','63','','','','A7','${range_from}','${range_to}'),
    ('B-62-7','B-61-6','','',NULL,'92','','${final_qrcode}','62','','','','A7','${range_from}','${range_to}'),
    ('B-61-7','B-60-6','','',NULL,'91','','${final_qrcode}','61','','','','A7','${range_from}','${range_to}'),
    ('B-60-7','B-59-6','','',NULL,'90','','${final_qrcode}','60','','','','A7','${range_from}','${range_to}'),
    ('B-59-7','B-59-18','','',NULL,'89','','${final_qrcode}','59','','','','A7','${range_from}','${range_to}'),
    ('B-58-1','B-57-6','','',NULL,'10','','${final_qrcode}','58','','','','B8','${range_from}','${range_to}'),
    ('B-57-7','B-56-6','','',NULL,'9','','${final_qrcode}','57','','','','B8','${range_from}','${range_to}'),
    ('B-56-7','B-55-6','','',NULL,'8','','${final_qrcode}','56','','','','B8','${range_from}','${range_to}'),
    ('B-55-7','B-54-6','','',NULL,'7','','${final_qrcode}','55','','','','B8','${range_from}','${range_to}'),
    ('B-54-7','B-53-6','','',NULL,'6','','${final_qrcode}','54','','','','B8','${range_from}','${range_to}'),
    ('B-53-7','B-52-6','','',NULL,'5','','${final_qrcode}','53','','','','B8','${range_from}','${range_to}'),
    ('B-52-7','B-51-6','','',NULL,'4','','${final_qrcode}','52','','','','B8','${range_from}','${range_to}'),
    ('B-51-7','B-50-6','','',NULL,'3','','${final_qrcode}','51','','','','B8','${range_from}','${range_to}'),
    ('B-50-7','B-50-18','','',NULL,'2','','${final_qrcode}','50','','','','B8','${range_from}','${range_to}'),
    ('B-9-1','B-8-6','','',NULL,'55','','${final_qrcode}','9','','','','B13','${range_from}','${range_to}'),
    ('B-8-7','B-7-6','','',NULL,'54','','${final_qrcode}','8','','','','B13','${range_from}','${range_to}'),
    ('B-7-7','B-6-6','','',NULL,'53','','${final_qrcode}','7','','','','B13','${range_from}','${range_to}'),
    ('B-6-7','B-5-6','','',NULL,'52','','${final_qrcode}','6','','','','B13','${range_from}','${range_to}'),
    ('B-5-7','B-4-6','','',NULL,'51','','${final_qrcode}','5','','','','B13','${range_from}','${range_to}'),
    ('B-4-7','B-3-6','','',NULL,'50','','${final_qrcode}','4','','','','B13','${range_from}','${range_to}'),
    ('B-3-7','B-2-6','','',NULL,'49','','${final_qrcode}','3','','','','B13','${range_from}','${range_to}'),
    ('B-2-7','B-1-6','','',NULL,'48','','${final_qrcode}','2','','','','B13','${range_from}','${range_to}'),
    ('B-1-7','B-1-18','','',NULL,'47','','${final_qrcode}','1','','','','B13','${range_from}','${range_to}'),
    ('B-49-1','B-48-6','','',NULL,'1','','${final_qrcode}','49','','','','C9','${range_from}','${range_to}'),
    ('B-48-7','B-47-6','','',NULL,'22','','${final_qrcode}','48','','','','C9','${range_from}','${range_to}'),
    ('B-47-7','B-46-6','','',NULL,'21','','${final_qrcode}','47','','','','C9','${range_from}','${range_to}'),
    ('B-46-7','B-45-6','','',NULL,'20','','${final_qrcode}','46','','','','C9','${range_from}','${range_to}'),
    ('B-45-7','B-44-6','','',NULL,'19','','${final_qrcode}','45','','','','C9','${range_from}','${range_to}'),
    ('B-44-7','B-43-6','','',NULL,'18','','${final_qrcode}','44','','','','C9','${range_from}','${range_to}'),
    ('B-43-7','B-42-6','','',NULL,'17','','${final_qrcode}','43','','','','C9','${range_from}','${range_to}'),
    ('B-42-7','B-41-6','','',NULL,'16','','${final_qrcode}','42','','','','C9','${range_from}','${range_to}'),
    ('B-41-7','B-40-6','','',NULL,'15','','${final_qrcode}','41','','','','C9','${range_from}','${range_to}'),
    ('B-40-7','B-40-18','','',NULL,'14','','${final_qrcode}','40','','','','C9','${range_from}','${range_to}'),
    ('B-39-1','B-38-6','','',NULL,'13','','${final_qrcode}','39','','','','C10','${range_from}','${range_to}'),
    ('B-38-7','B-37-6','','',NULL,'12','','${final_qrcode}','38','','','','C10','${range_from}','${range_to}'),
    ('B-37-7','B-36-6','','',NULL,'11','','${final_qrcode}','37','','','','C10','${range_from}','${range_to}'),
    ('B-36-7','B-35-6','','',NULL,'34','','${final_qrcode}','36','','','','C10','${range_from}','${range_to}'),
    ('B-35-7','B-34-6','','',NULL,'33','','${final_qrcode}','35','','','','C10','${range_from}','${range_to}'),
    ('B-34-7','B-33-6','','',NULL,'32','','${final_qrcode}','34','','','','C10','${range_from}','${range_to}'),
    ('B-33-7','B-32-6','','',NULL,'31','','${final_qrcode}','33','','','','C10','${range_from}','${range_to}'),
    ('B-32-7','B-31-6','','',NULL,'30','','${final_qrcode}','32','','','','C10','${range_from}','${range_to}'),
    ('B-31-7','B-30-6','','',NULL,'29','','${final_qrcode}','31','','','','C10','${range_from}','${range_to}'),
    ('B-30-7','B-30-18','','',NULL,'28','','${final_qrcode}','30','','','','C10','${range_from}','${range_to}'),
    ('B-29-1','B-28-6','','',NULL,'27','','${final_qrcode}','29','','','','C11','${range_from}','${range_to}'),
    ('B-28-7','B-27-6','','',NULL,'26','','${final_qrcode}','28','','','','C11','${range_from}','${range_to}'),
    ('B-27-7','B-26-6','','',NULL,'25','','${final_qrcode}','27','','','','C11','${range_from}','${range_to}'),
    ('B-26-7','B-25-6','','',NULL,'24','','${final_qrcode}','26','','','','C11','${range_from}','${range_to}'),
    ('B-25-7','B-24-6','','',NULL,'23','','${final_qrcode}','25','','','','C11','${range_from}','${range_to}'),
    ('B-24-7','B-23-6','','',NULL,'46','','${final_qrcode}','24','','','','C11','${range_from}','${range_to}'),
    ('B-23-7','B-22-6','','',NULL,'45','','${final_qrcode}','23','','','','C11','${range_from}','${range_to}'),
    ('B-22-7','B-21-6','','',NULL,'44','','${final_qrcode}','22','','','','C11','${range_from}','${range_to}'),
    ('B-21-7','B-20-6','','',NULL,'43','','${final_qrcode}','21','','','','C11','${range_from}','${range_to}'),
    ('B-20-7','B-20-18','','',NULL,'42','','${final_qrcode}','20','','','','C11','${range_from}','${range_to}'),
    ('B-19-1','B-18-6','','',NULL,'41','','${final_qrcode}','19','','','','C12','${range_from}','${range_to}'),
    ('B-18-7','B-17-6','','',NULL,'40','','${final_qrcode}','18','','','','C12','${range_from}','${range_to}'),
    ('B-17-7','B-16-6','','',NULL,'39','','${final_qrcode}','17','','','','C12','${range_from}','${range_to}'),
    ('B-16-7','B-15-6','','',NULL,'38','','${final_qrcode}','16','','','','C12','${range_from}','${range_to}'),
    ('B-15-7','B-14-6','','',NULL,'37','','${final_qrcode}','15','','','','C12','${range_from}','${range_to}'),
    ('B-14-7','B-13-6','','',NULL,'36','','${final_qrcode}','14','','','','C12','${range_from}','${range_to}'),
    ('B-13-7','B-12-6','','',NULL,'35','','${final_qrcode}','13','','','','C12','${range_from}','${range_to}'),
    ('B-12-7','B-11-6','','',NULL,'58','','${final_qrcode}','12','','','','C12','${range_from}','${range_to}'),
    ('B-11-7','B-10-6','','',NULL,'57','','${final_qrcode}','11','','','','C12','${range_from}','${range_to}'),
    ('B-10-7','B-10-18','','',NULL,'56','','${final_qrcode}','10','','','','C12','${range_from}','${range_to}')`;

    var testCellLimber=`INSERT INTO taco_treceability.taco_treceability.test_cell_table(point_1, point_2, voltage, IR, status, bms_no, battery_id, final_qrcode, actual_no, remark_by, checked_by, made_by, module_group,min_voltage,max_voltage) VALUES 
('NA','NA','','',NULL,'NA','','${final_qrcode}','1','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','2','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','3','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','4','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','5','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','6','','','','M1','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','7','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','8','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','9','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','10','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','11','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','12','','','','M2','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','13','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','14','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','15','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','16','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','17','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','18','','','','M3','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','19','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','20','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','21','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','22','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','23','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','24','','','','M4','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','25','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','26','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','27','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','28','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','29','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','30','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','31','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','32','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','33','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','34','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','35','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','36','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','37','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','38','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','39','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','40','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','41','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','42','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','43','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','44','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','45','','','','M5','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','46','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','47','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','48','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','49','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','50','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','51','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','52','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','53','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','54','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','55','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','56','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','57','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','58','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','59','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','60','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','61','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','62','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','63','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','64','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','65','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','66','','','','M6','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','67','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','68','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','69','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','70','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','71','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','72','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','73','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','74','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','75','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','76','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','77','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','78','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','79','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','80','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','81','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','82','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','83','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','84','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','85','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','86','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','87','','','','M7','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','88','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','89','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','90','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','91','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','92','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','93','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','94','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','95','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','96','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','97','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','98','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','99','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','100','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','101','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','102','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','103','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','104','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','105','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','106','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','107','','','','M8','${range_from}','${range_to}'),
('NA','NA','','',NULL,'NA','','${final_qrcode}','108','','','','M8','${range_from}','${range_to}')`;

var addTestCell;

if(packname.substring(0,8)=="Kanger 2"){
    addTestCell=testCellKanger2;
}else if(packname.substring(0,6)=="Kanger"){
    addTestCell=testCellKanger;
} else if(packname.substring(0,6)=="Limber"){
    addTestCell=testCellLimber;
}

    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(addTestCell, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('addTestCellEntry Error:',err);
            var result = recordset.recordset;
        // addTestCell, function (err, recordset) {
        //     if (err) console.log('addTestCellEntry Error:',err);
            //console.log('addTestCell Entry Successful');
        });
    });
}*/

// Shubham Code - Total Module 
function insertPDITableEntry(battery_id,final_qrcode) {
    var dbQuery =`insert into taco_treceability.taco_treceability.pdi_details(battery_id, final_qr_code, reading, test_reading_report_status, charging_discharging_station, part_fitting_report_status, welding_status, confirmation_to_generate_PDI_form, report_description) values('${battery_id}', '${final_qrcode}', 'Not Taken', 'NOT OK', 'Yes', 'OK', 'OK', 'Confirm', 'NA')`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('PDI Table Error:',err);
            var result = recordset.recordset;
        
            //console.log('PDI Table Entry Successful');
        });
    });
}
function totolcountDetailsDBEntry(module_name,battery_pack_name, battery_id) {
    var dbQuery = `insert into taco_treceability.taco_treceability.total_module_count (module_name,battery_pack_name,line,shift,date,battery_id,module_id) values ('${module_name}','${battery_pack_name}', '${line}', ${shift}', '${date}', '${battery_id}', '${module_id}')`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            // if (err) console.log(err);
            if (err) console.log('Total Count Code Error:', err);
            var result = recordset.recordset;
        
        //     if (err) console.log('Total Count Code Error:', err);
            //console.log('Total Count Code Entry Successful');
        });
    });
}

///////////////////////////////// START FUNCTION ////////////////////////////////////////

function insertDataInTotalModuleCountTable(selected_battery_id,FINALQRCODE){
    //var selected_battery_id = "04012022DJ18280000000002";
    //console.log("selected_battery_id", selected_battery_id);
    var battery_pack_name, line;
    var dbQuery="SELECT TOP 1 * FROM taco_treceability.taco_treceability.production_count WHERE line='4' and battery_id='" + selected_battery_id + "' ORDER BY sr_no";
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // "SELECT * FROM taco_treceability.production_count WHERE line='1' and battery_id='" + selected_battery_id + "' ORDER BY sr_no LIMIT 1", function (err, recordset) {
            // if (err) console.log(err);
            for (var i in result) {
                battery_pack_name = result[i].battery_pack_name;
                line = result[i].line;
            }
            setTimeout(function () {
                //console.log("battery_pack_name", battery_pack_name);
                get_batteryPackModule_details(selected_battery_id, battery_pack_name, line,FINALQRCODE);
            }, 100);
        });
    });
}
function get_batteryPackModule_details(selected_battery_id, battery_pack_name, line,FINALQRCODE) {
    var battery_pack_details = [];
    var dbQuery="SELECT * FROM taco_treceability.taco_treceability.master_data_details WHERE battery_pack_name='" + battery_pack_name + "'";
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // "SELECT * FROM taco_treceability.master_data_details WHERE battery_pack_name='" + battery_pack_name + "'", function (err, recordset) {
        //     if (err) console.log(err);
            for (var i in result) {
                var module_type = result[i].module_type;
                var no_of_module = result[i].no_of_module;
                var no_of_cell_per_module = result[i].no_of_cell_per_module;
                battery_pack_details.push(module_type);
                battery_pack_details.push(no_of_module);
                battery_pack_details.push(no_of_cell_per_module);
            }
            setTimeout(function () {
                //console.log("battery_pack_name", battery_pack_name);
                get_batteryPackAllModule_details(selected_battery_id, battery_pack_name, battery_pack_details, line,FINALQRCODE);
            }, 100);
        });
    });
}
function get_batteryPackAllModule_details(selected_battery_id, battery_pack_name, battery_pack_details, line, FINALQRCODE) {
    //   console.log("selected_battery_id, battery_pack_name,battery_pack_details", selected_battery_id, battery_pack_name, battery_pack_details);
    for (var i = 0; i < battery_pack_details.length; i = i + 3) {
        get_batteryPackModuleEntery_details(selected_battery_id, battery_pack_name, battery_pack_details[i], battery_pack_details[i + 1], battery_pack_details[i + 2], line, FINALQRCODE);
    }
}
function get_batteryPackModuleEntery_details(selected_battery_id, battery_pack_name, type_name, total_type, total_cell, line, FINALQRCODE) {
    // console.log("selected_battery_id, battery_pack_name,type_name,total_type,total_cell", selected_battery_id, battery_pack_name, type_name, total_type, total_cell);
    var module_id_arr = [];
    var dbQuery="SELECT DISTINCT(module_barcode) as module_id FROM taco_treceability.taco_treceability.production_count where module_name='" + type_name + "' and line='4'";
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // "SELECT DISTINCT(module_barcode) as module_id FROM taco_treceability.production_count where module_name='" + type_name + "' and line='1'", function (err, recordset) {
        //     if (err) console.log(err);
            for (var i in result) {
                var module_id = result[i].module_id;
                module_id_arr.push(module_id);
            }
            setTimeout(function () {
                insert_BatteryPack_Details_In_TotalCount(selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id_arr, line, FINALQRCODE);
            }, 100);
        });
    });
}
function insert_BatteryPack_Details_In_TotalCount(selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id_arr, line, FINALQRCODE) {
    //console.log("selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id_arr", selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id_arr);
    for (var i = 0; i < module_id_arr.length; i++) {
        insert_BatteryPack_Details_In_TotalCount1(selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id_arr[i], line, FINALQRCODE);
    }
}
function insert_BatteryPack_Details_In_TotalCount1(selected_battery_id, battery_pack_name, type_name, total_type, total_cell, module_id, line, FINALQRCODE) {
    var dbQuery="SELECT * FROM taco_treceability.taco_treceability.total_module_count where module_name='"+type_name+"' AND battery_pack_name='"+battery_pack_name+"' AND line='"+line+"' AND total_cell_count='"+total_cell+"' AND battery_id='"+selected_battery_id+"' AND module_id='"+module_id+"'";
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dbQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // "SELECT * FROM taco_treceability.total_module_count where module_name='"+type_name+"' AND battery_pack_name='"+battery_pack_name+"' AND line='"+line+"' AND total_cell_count='"+total_cell+"' AND battery_id='"+selected_battery_id+"' AND module_id='"+module_id+"'", function (err, recordset) {
        //     if (err) console.log(err);
            if (result == "") {
                var dateObj=new Date();
                var dd=dateObj.getDate();
                var mm=dateObj.getMonth()+1;
                var yyyy=dateObj.getFullYear();
                dd=(dd.toString().length<2)?"0"+dd:dd;
                mm=(mm.toString().length<2)?"0"+mm:mm;
                var dateStr=dd+"-"+mm+"-"+yyyy;
                request2 = new sql.Request();
                request2.query("INSERT INTO taco_treceability.taco_treceability.total_module_count(module_name,battery_pack_name,line,cell_count,total_cell_count,shift,date,battery_id,module_id,final_qrcode) values ('" + type_name + "','" + battery_pack_name + "','" + line + "','0','" + total_cell + "','"+current_shift+"','"+dateStr+"','" + selected_battery_id + "','" + module_id + "','"+FINALQRCODE+"')", function (err, recordset) {
                    if (err) console.log(err);
                    var result2 = recordset.recordset;
                // "INSERT INTO total_module_count(module_name,battery_pack_name,line,cell_count,total_cell_count,shift,date,battery_id,module_id,final_qrcode) values ('" + type_name + "','" + battery_pack_name + "','" + line + "','0','" + total_cell + "','"+current_shift+"','"+dateStr+"','" + selected_battery_id + "','" + module_id + "','"+FINALQRCODE+"')", (err, rows, fields) => {
                //     if (err) console.log(err);
                });
            }
        });
    });
}
///////////////////////////////// END FUNCTION /////////////////////////////////////////

// Update count in total module counts
function updateCountInTotalModules(result_srno){
    //console.log('result_srno',result_srno);
    var moduleId;
    var testselectQuery=`select * from taco_treceability.taco_treceability.production_count WHERE sr_no = ${result_srno}`;
    //console.log('updateCountInTotalModules selectQuery:',testselectQuery);
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(testselectQuery, function (err, recordset) {
            // if (err) console.log(err);
            // var result = recordset.recordset;
        // testselectQuery, function (err, recordset) {
            var result = recordset.recordset;
            if (err) console.log('updateCountInTotalModules Error:',err);
            else if (result.length>0) {
                moduleId=result[0].module_barcode;
                var select2 = `SELECT * from taco_treceability.taco_treceability.total_module_count where module_id='${moduleId}'`;
                request2 = new sql.Request();
                request2.query(select2, function (err2, recordset) {
                    // if (err) console.log(err);
                    if (err2) console.log('updateCountInTotalModules2 Error:',err2);
                    var res2 = recordset.recordset;
                // select2, (err2, res2, fields) => {
                    var cell_count;
                    if (res2 == "") {
                        for(var j in res2) {
                            cell_count = parseInt(res2[j].cell_count);
                        }
                        var newCellCount=cell_count+1;
                        request3 = new sql.Request();
                        request3.query(`update taco_treceability.taco_treceability.total_module_count set cell_count='${newCellCount}' where module_id='${moduleId}'`, function (err3, recordset) {
                            // if (err) console.log(err);
                            if (err3) console.log('updateCountInTotalModules Update Error:',err3);
                            //var res3 = recordset.recordset;
                        // `update total_module_count set cell_count='${newCellCount}' where module_id='${moduleId}'`, (err3, rows, fields) => {
                            //console.log('update updateCountInTotalModules complete');
                        });
                    }
                });
            }

        });
    });
}

function updateCountInTotalModulesNew(moduleId){

    // return new Promise((resolve, reject) => {
        //console.log('updateCountInTotalModulesNew moduleId:',moduleId);
        
        var select2 = `SELECT * from taco_treceability.taco_treceability.total_module_count where module_id='${moduleId}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(`SELECT * from taco_treceability.taco_treceability.total_module_count where module_id='${moduleId}'`, function (err, recordset) {
                // if (err) console.log(err);
                if (err) console.log('updateCountInTotalModules2 Error:',err);
                var res2 = recordset.recordset;
            // con2.query(`SELECT * from total_module_count where module_id='${moduleId}'`, (err, res2, fields) => {  
                var cell_count;
                if (res2.length>0) {
                    for(var j in res2) {
                        cell_count = parseInt(res2[j].cell_count);
                    }
                    var newCellCount=cell_count+1;
                    request2 = new sql.Request();
                    request2.query(`update taco_treceability.taco_treceability.total_module_count set cell_count='${newCellCount}' where module_id='${moduleId}'`, function (err3, recordset) {
                        // if (err) console.log(err);
                        if (err3) console.log('updateCountInTotalModules Update Error:',err3);
                        //var res3 = recordset.recordset;
                    // con2.query(`update total_module_count set cell_count='${newCellCount}' where module_id='${moduleId}'`, (err3, rows, fields) => {
                        
                        //console.log('update updateCountInTotalModules complete');
                        // resolve();
                    });
                }
            });
        });
    // });
}

function updateFinalQRCodeBatteryStatus(final_qrcode) {

}
//  var tqr='DJ1921-C670006158';//DJ1828-C3H0015204
//var tqr='DJ1828-C5P0019414';
//var tstat = "pending";
//sendToArchive(tqr,tstat);
/*
function sendToArchive(final_qr_code,batt_status){
    var dqQuery=`SELECT * FROM taco_treceability.production_count WHERE final_qr_code='${final_qr_code}'`;
    var globalCurrentStore=[];
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            // if (err) throw (err);
            if (err) console.log(err);
            var result = recordset.recordset;
            console.log('result::', result);
        // dqQuery, function (err, recordset) {
            // if (err) throw (err);
            //console.log('step 2');
            for(var i in result) {
                globalCurrentStore.push(result[i]);
            }
            //console.log('globalCurrentStore', globalCurrentStore);

            var insertQuery = 'INSERT INTO taco_treceability.production_count_data_archive(battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code, CustomerQRCode, date_time_end, total_module, rownum, moduleNumber, shift_incharge, shift_supervisor, range_from, range_to) VALUES'
            for(var i=0;i<globalCurrentStore.length;i++) {
                if(i==0) {
                    insertQuery += ` ('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','${batt_status}','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}')`;
                } else {
                    insertQuery += `,('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','${batt_status}','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}')`;
                }
            }
        // console.log(insertQuery);
        // fs.writeFile("insert.txt", insertQuery, (err) => {

        // });
            // execute
            //request2 = new sql.Request();
            request.query(insertQuery, function (err, recordset) {
                // if (err) throw (err);
                if (err) console.log(err);
                //var result2 = recordset.recordset;
            // insertQuery, function (err, result2, fields2) {
            //     if (err) throw (err);
                
                if(!err) {
                    //console.log('successfull insert query');
                    // data_compress logic vrushali start
                    // request.query('SELECT final_qr_code,battery_pack_name,CustomerQRCode,battery_id,battery_status,date_time_start,shift,line,username,final_qr_code_status,date_time_end,rownum,shift_incharge,shift_supervisor,range_from,range_to FROM production_count_data_archive group by final_qr_code ORDER BY sr_no ASC', function (err, recordset) {
                    //     if (err) throw (err);
                    //     var results = recordset.recordset;
                        // async.eachSeries(results, function (data, callback) { 
                            //var data1=JSON.stringify(data);
                            //var data2=JSON.parse(data1);
                            
                            // var results1;
                            var finalQRCode;
                            var batteryPackName;
                            var customerQRCOd;
                            var battery_id;
                            var battery_status;
                            var date_time_start;
                            var shift;
                            var line;
                            var username;
                            var final_qr_code_status;
                            var date_time_end;
                            var rownum;
                            var shift_incharge;
                            var shift_supervisor;
                            var range_from;
                            var range_to;
                            var module_barcode_arr=[];
                            var module_barcode;
                           
                            request.query(`SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where final_qr_code='${final_qr_code}'`, function (err, recordset) {
                                if (err) console.log(err);
                               
                                var results1 = recordset.recordset;
                                for (var i in results1) {
                                    module_barcode = results1[i].module_barcode;
                                    finalQRCode=results1[0].final_qr_code;
                                    batteryPackName=results1[0].battery_pack_name;
                                    customerQRCOde=results1[0].CustomerQRCode;
                                    battery_id=results1[0].battery_id;
                                    battery_status=results1[0].battery_status;
                                    date_time_start=results1[0].date_time_start;
                                    shift=results1[0].shift;
                                    line=results1[0].line;
                                    username=results1[0].username;
                                    final_qr_code_status=results1[0].final_qr_code_status;
                                    date_time_end=results1[0].date_time_end;
                                    rownum=results1[0].rownum;
                                    shift_incharge=results1[0].shift_incharge;
                                    shift_supervisor=results1[0].shift_supervisor;
                                    range_from=results1[0].range_from;
                                    range_to=results1[0].range_to;

                                     if(!module_barcode_arr.includes(module_barcode)) {
                                        module_barcode_arr.push(module_barcode);
                                     }
                                }
                               // console.log("module_barcode_arrrrrrrrrrrrrrrrrrrrrrr",module_barcode_arr,finalQRCode);
                                async.eachSeries(module_barcode_arr, function (dataM, callback) { 
                                    var cell_barcode_arr=[],cell_barcode_arr1=[],moduleID,moduleName,moduleStatus,totalModule,moduleNumber;
                                    request.query(`SELECT DISTINCT(cell_qr_code),module_id,module_name,cell_status,module_status,total_module,moduleNumber FROM taco_treceability.taco_treceability.production_count_data_archive where module_barcode='${dataM}'`, function (err, recordset) {
                                        if (err) console.log(err);
                                        var results1 = recordset.recordset;
                                        for (var i in results1) {
                                             var cell_qr_code = results1[i].cell_qr_code;
                                             var cellQRCodestatus = results1[i].cell_status;
                                              moduleID=results1[i].module_id;
                                              moduleName=results1[i].module_name;
                
                                              moduleStatus=results1[i].module_status;
                                              totalModule=results1[i].total_module;
                                              moduleNumber=results1[i].moduleNumber;
                                              
                
                                             cell_barcode_arr.push(cell_qr_code);
                                             cell_barcode_arr1.push(cellQRCodestatus);
                                        }
                                        var cell_barcode_string=cell_barcode_arr.toString();
                                        var cell_barcode_status_string=cell_barcode_arr1.toString();
                                       // console.log("final QRCODEE:::::::::::::",finalQRCode);
                                       // console.log("modeule string",dataM);
                                       // console.log("cellQRCODEEEEEEEEEE",cell_barcode_arr.toString(),"************",cell_barcode_arr.length);
                                       request.query("INSERT INTO taco_treceability.taco_treceability.production_count_archive_compress(battery_pack_name,cell_qr_code,module_name,module_id,module_barcode,final_qr_code,CustomerQRCode,cell_status,battery_id,battery_status,date_time_start,shift,line,username,final_qr_code_status,date_time_end,rownum,shift_incharge,shift_supervisor,range_from,range_to,module_status,total_module,moduleNumber) values ('" + batteryPackName + "','" + cell_barcode_string + "','" + moduleName + "','" + moduleID+ "','" + dataM + "','" + finalQRCode + "','" + customerQRCOde + "','"+cell_barcode_status_string+"','"+battery_id+"','"+battery_status+"','"+date_time_start+"','"+shift+"','"+line+"','"+username+"','"+final_qr_code_status+"','"+date_time_end+"','"+rownum+"','"+shift_incharge+"','"+shift_supervisor+"','"+range_from+"','"+range_to+"','"+moduleStatus+"','"+totalModule+"','"+moduleNumber+"')", (err, recordset) => {
                                        if (err) console.log(err);
                                            callback();
                                        });
                                       
                                    });
                
                                }, function (err) {
                                    //callback();
                                    console.log("inner loop completeddddddddddddddddddd"); 
                                });
                                
                            });
                          
                        // }, function (err, results) {
                        //     console.log("out loop completeddddddddddddddddddd"); 
                        // });
                
                    // })


                    // data_compress logic vrushali end
                    setTimeout(() => {
                        truncateTable(final_qr_code);
                    }, 1000);
                }
                
                
            });
            
        });
    });
}
*/
function sendToArchive(final_qr_code,batt_status){
    var dqQuery=`SELECT * FROM taco_treceability.production_count WHERE final_qr_code='${final_qr_code}'`;
    var globalCurrentStore=[];
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            // if (err) throw (err);
            if (err) console.log(err);
            var result = recordset.recordset;
            //console.log('result::', result);
        // dqQuery, function (err, recordset) {
            // if (err) throw (err);
            //console.log('step 2');
            for(var i in result) {
                globalCurrentStore.push(result[i]);
            }
            //console.log('globalCurrentStore', globalCurrentStore);

            var insertQuery = 'INSERT INTO taco_treceability.production_count_data_archive(battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code, CustomerQRCode, date_time_end, total_module, rownum, moduleNumber, shift_incharge, shift_supervisor, range_from, range_to,cell_voltage,cell_ir,ocv_machine_location,ocv_scanned_time,ocv_kvalue,ocv_class,ocv_capacity) VALUES'
            for(var i=0;i<globalCurrentStore.length;i++) {
                if(i==0) {
                    insertQuery += ` ('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','${batt_status}','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}','${globalCurrentStore[i].cell_voltage}','${globalCurrentStore[i].cell_ir}','${globalCurrentStore[i].ocv_machine_location}','${globalCurrentStore[i].ocv_scanned_time}','${globalCurrentStore[i].ocv_kvalue}','${globalCurrentStore[i].ocv_class}','${globalCurrentStore[i].ocv_capacity}')`;
                } else {
                    insertQuery += `,('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','${batt_status}','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}','${globalCurrentStore[i].cell_voltage}','${globalCurrentStore[i].cell_ir}','${globalCurrentStore[i].ocv_machine_location}','${globalCurrentStore[i].ocv_scanned_time}','${globalCurrentStore[i].ocv_kvalue}','${globalCurrentStore[i].ocv_class}','${globalCurrentStore[i].ocv_capacity}')`;
                }
            }
        // console.log(insertQuery);
        // fs.writeFile("insert.txt", insertQuery, (err) => {

        // });
            // execute
            //request2 = new sql.Request();
            request.query(insertQuery, function (err, recordset) {
                // if (err) throw (err);
                if (err) console.log(err);
                //var result2 = recordset.recordset;
            // insertQuery, function (err, result2, fields2) {
            //     if (err) throw (err);
                
                if(!err) {
                    //console.log('successfull insert query');
                    // data_compress logic vrushali start
                    // request.query('SELECT final_qr_code,battery_pack_name,CustomerQRCode,battery_id,battery_status,date_time_start,shift,line,username,final_qr_code_status,date_time_end,rownum,shift_incharge,shift_supervisor,range_from,range_to FROM production_count_data_archive group by final_qr_code ORDER BY sr_no ASC', function (err, recordset) {
                    //     if (err) throw (err);
                    //     var results = recordset.recordset;
                        // async.eachSeries(results, function (data, callback) { 
                            //var data1=JSON.stringify(data);
                            //var data2=JSON.parse(data1);
                            
                            // var results1;
                            var finalQRCode;
                            var batteryPackName;
                            var customerQRCOde;
                            var battery_id;
                            var battery_status;
                            var date_time_start;
                            var shift;
                            var line;
                            var username;
                            var final_qr_code_status;
                            var date_time_end;
                            var rownum;
                            var shift_incharge;
                            var shift_supervisor;
                            var range_from;
                            var range_to;
                            var module_barcode_arr=[];
                            var module_barcode;
                           
                            request.query(`SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where final_qr_code='${final_qr_code}'`, function (err, recordset) {
                                if (err) console.log(err);
                               
                                var results1 = recordset.recordset;
                                for (var i in results1) {
                                    module_barcode = results1[i].module_barcode;
                                    finalQRCode=results1[0].final_qr_code;
                                    batteryPackName=results1[0].battery_pack_name;
                                    customerQRCOde=results1[0].CustomerQRCode;
                                    battery_id=results1[0].battery_id;
                                    battery_status=results1[0].battery_status;
                                    date_time_start=results1[0].date_time_start;
                                    shift=results1[0].shift;
                                    line=results1[0].line;
                                    username=results1[0].username;
                                    final_qr_code_status=results1[0].final_qr_code_status;
                                    date_time_end=results1[0].date_time_end;
                                    rownum=results1[0].rownum;
                                    shift_incharge=results1[0].shift_incharge;
                                    shift_supervisor=results1[0].shift_supervisor;
                                    range_from=results1[0].range_from;
                                    range_to=results1[0].range_to;

                                     if(!module_barcode_arr.includes(module_barcode)) {
                                        module_barcode_arr.push(module_barcode);
                                     }
                                }
                               // console.log("module_barcode_arrrrrrrrrrrrrrrrrrrrrrr",module_barcode_arr,finalQRCode);
                               var cell_barcode_batch_used_string = [];
                                async.eachSeries(module_barcode_arr, function (dataM, callback) { 
                                    var cell_barcode_arr=[],cell_barcode_arr1=[],moduleID,moduleName,moduleStatus,totalModule,moduleNumber;
                                    var cell_volt_arr=[],cell_ir_arr=[],cell_time_arr=[],cell_scanlocation_arr=[],cell_kvalue_arr=[],cell_class_arr=[],cell_capacity_arr=[];
                                    var cell_barcode_batch_used_arr = [];
                                    request.query(`SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive where module_barcode='${dataM}'`, function (err, recordset) {
                                        if (err) console.log(err);
                                        var results1 = recordset.recordset;
                                        for (var i in results1) {
                                           // var cell_qr_code1 = (results1[i].cell_qr_code).split(',');
                                             var cell_qr_code = results1[i].cell_qr_code;
                                             var cellQRCodestatus = results1[i].cell_status;

                                             var ocv_voltage = results1[i].cell_voltage;
                                             var ocv_ir = results1[i].cell_ir;
                                             var ocv_scantime = results1[i].ocv_scanned_time;
                                             var ocv_scanlocation = results1[i].ocv_machine_location;
                                             var ocv_kvalue = results1[i].ocv_kvalue;
                                             var ocv_class = results1[i].ocv_class;
                                             var ocv_capacity = results1[i].ocv_capacity;

                                              moduleID=results1[i].module_id;
                                              moduleName=results1[i].module_name;
                
                                              moduleStatus=results1[i].module_status;
                                              totalModule=results1[i].total_module;
                                              moduleNumber=results1[i].moduleNumber;
                                              
                
                                             cell_barcode_arr.push(cell_qr_code);
                                             cell_barcode_arr1.push(cellQRCodestatus);
                                             cell_volt_arr.push(ocv_voltage);
                                             cell_ir_arr.push(ocv_ir);
                                             cell_time_arr.push(ocv_scantime);
                                             cell_scanlocation_arr.push(ocv_scanlocation);
                                             cell_kvalue_arr.push(ocv_kvalue);
                                             cell_class_arr.push(ocv_class);
                                             cell_capacity_arr.push(ocv_capacity);

                                            // for(var m=0;m<cell_qr_code1.length;m++){
                                             //  cell_barcode_batch_used_arr.push(cell_qr_code.substr(14, 3));
                                             var temp_plantcode=cell_qr_code.substring(12,14);
                                    //var batch_string;
                                                    console.log("new Plantcode:",temp_plantcode);
                                 
                                                    if(temp_plantcode=='BJ' || temp_plantcode=="CJ"){
                                                        cell_barcode_batch_used_arr.push(cell_qr_code.substr(14, 3));
                                                              
                                                    }
                                                    else if(temp_plantcode=='BV'){
                                                        cell_barcode_batch_used_arr.push(cell_qr_code.substr(8, 3));
                                                    }
                                                    else{
                                                        cell_barcode_batch_used_arr.push(cell_qr_code.substr(14, 3));
                                                    }
                                            //}
                                        }
                                        var cell_barcode_string=cell_barcode_arr.toString();
                                        var cell_barcode_status_string=cell_barcode_arr1.toString();

                                        var cell_volt_arr_string=cell_volt_arr.toString();
                                        var cell_ir_arr_string=cell_ir_arr.toString();
                                        var cell_time_arr_string=cell_time_arr.toString();
                                        var cell_scanlocation_arr_string=cell_scanlocation_arr.toString();
                                        var cell_kvalue_arr_string=cell_kvalue_arr.toString();
                                        var cell_class_arr_string=cell_class_arr.toString();
                                        var cell_capacity_arr_string=cell_capacity_arr.toString();

                                        var cell_barcode_batch_used_arr_unique = cell_barcode_batch_used_arr.filter((item, i, ar) => ar.indexOf(item) === i);
                                        cell_barcode_batch_used_string = (cell_barcode_batch_used_string.concat(cell_barcode_batch_used_arr_unique)).filter((item, i, ar) => ar.indexOf(item) === i);
                                       
                                       // console.log("final QRCODEE:::::::::::::",finalQRCode);
                                       // console.log("modeule string",dataM);
                                       // console.log("cellQRCODEEEEEEEEEE",cell_barcode_arr.toString(),"************",cell_barcode_arr.length);
                                    /*   request.query("INSERT INTO taco_treceability.taco_treceability.production_count_archive_compress(battery_pack_name,cell_qr_code,module_name,module_id,module_barcode,final_qr_code,CustomerQRCode,cell_status,battery_id,battery_status,date_time_start,shift,line,username,final_qr_code_status,date_time_end,rownum,shift_incharge,shift_supervisor,range_from,range_to,module_status,total_module,moduleNumber,cell_voltage,cell_ir,ocv_machine_location,ocv_scanned_time,usedBatches,ocv_kvalue,ocv_class,ocv_capacity) values ('" + batteryPackName + "','" + cell_barcode_string + "','" + moduleName + "','" + moduleID+ "','" + dataM + "','" + finalQRCode + "','" + customerQRCOde + "','"+cell_barcode_status_string+"','"+battery_id+"','"+battery_status+"','"+date_time_start+"','"+shift+"','"+line+"','"+username+"','"+final_qr_code_status+"','"+date_time_end+"','"+rownum+"','"+shift_incharge+"','"+shift_supervisor+"','"+range_from+"','"+range_to+"','"+moduleStatus+"','"+totalModule+"','"+moduleNumber+"','"+cell_volt_arr_string+"','"+cell_ir_arr_string+"','"+cell_scanlocation_arr_string+"','"+cell_time_arr_string+"','"+cell_barcode_batch_used_string.toString()+"','"+cell_kvalue_arr_string+"','"+cell_class_arr_string+"','"+cell_capacity_arr_string+"')", (err, recordset) => {
                                        if (err) console.log(err);
                                           // callback();
                                           request.query("UPDATE taco_treceability.taco_treceability.final_qrcode_details SET usedBatches='" + cell_barcode_batch_used_string.toString() + "' WHERE final_qrcode='" + finalQRCode + "'", (err, recordset) => {
                                            if (err) console.log(err);
                                            callback();
                                        });
                                        }); */


                                          //////////////////////////////////////////////SCRIPTCODE QC//////////////////////////////////////////
request.query("INSERT INTO taco_treceability.production_count_archive_compress (battery_pack_name, cell_qr_code, module_name, module_id, module_barcode, final_qr_code, CustomerQRCode, cell_status, battery_id, battery_status, date_time_start, shift, line, username, final_qr_code_status, date_time_end, rownum, shift_incharge, shift_supervisor, range_from, range_to, module_status, total_module, moduleNumber, cell_voltage, cell_ir, ocv_machine_location, ocv_scanned_time, usedBatches) " +
"VALUES ('" + batteryPackName + "','" + cell_barcode_string + "','" + moduleName + "','" + moduleID + "','" + dataM + "','" + finalQRCode + "','" + customerQRCOde + "','" + cell_barcode_status_string + "','" + battery_id + "','" + battery_status + "','" + date_time_start + "','" + shift + "','4','" + username + "','" + final_qr_code_status + "','" + date_time_end + "','" + rownum + "','" + shift_incharge + "','" + shift_supervisor + "','" + range_from + "','" + range_to + "','" + moduleStatus + "','" + totalModule + "','" + moduleNumber + "','" + cell_volt_arr_string + "','" + cell_ir_arr_string + "','" + cell_scanlocation_arr_string + "','" + cell_time_arr_string + "','" + cell_barcode_batch_used_string.toString() + "')",
(err, recordset) => {
    if (err) {
        console.log(err);
        return;
    }
console.log("excuting.......1")
    // Insert into master_compress_data
    request.query("INSERT INTO taco_treceability.master_compress_data (line, battery_pack_name, final_qr_code, moduleNumber, module_barcode, today_date) " +
    "VALUES ('4','" + batteryPackName + "','" + finalQRCode + "','" + moduleNumber + "','" + dataM + "', CONVERT(date, GETDATE()))",
    (err, recordset) => {
        if (err) {
            console.log(err);
            return;
        }
console.log("excuting.......2")
        // Update final_qrcode_details table
        request.query("UPDATE taco_treceability.final_qrcode_details SET usedBatches='" + cell_barcode_batch_used_string.toString() + "' WHERE final_qrcode='" + finalQRCode + "'",
        (err, recordset) => {
            if (err) console.log(err);
            callback();
            console.log("updating.......3")
        });
    });
});

//////////////////////////////////////////////SCRIPTCODE QC END//////////////////////////////////////////

                                       
                                    });
                
                                }, function (err) {
                                    //callback();
                                    //console.log("inner loop completeddddddddddddddddddd"); 
                                });
                                
                            });
                          
                        // }, function (err, results) {
                        //     console.log("out loop completeddddddddddddddddddd"); 
                        // });
                
                    // })


                    // data_compress logic vrushali end
                    setTimeout(() => {
                        truncateTable(final_qr_code);
                    }, 1000);
                }
                
                
            });
            
        });
    });
}

function truncateTable(final_qr_code) {
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(`delete from taco_treceability.taco_treceability.production_count where final_qr_code='${final_qr_code}'`, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // `delete from production_count where final_qr_code='${final_qr_code}'`, function (err, recordset) {
        //     if (err) console.log(err);
            if(!err) {
                //console.log('truncated Table');
                refreshInMemoryData();
            }
        });
    });
}

function refreshInMemoryData(){
    globalCellQRCodeStore.length=0;
    // var dqQuery=`SELECT cell_qr_code FROM production_count_data_archive WHERE Month(date_time_start)=Month(now()) and Year(date_time_start)=Year(now())`;
    // var dqQuery=`SELECT cell_qr_code FROM production_count_data_archive WHERE getdate(date_time_start) >= CONVERT (DATE, GETDATE ()-1);`;
    var dqQuery=`SELECT cell_qr_code FROM taco_treceability.taco_treceability.production_count_data_archive WHERE line='4' and date_time_start BETWEEN CONVERT (DATE, GETDATE ()-1) AND CONVERT (DATE, GETDATE ())`;

    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            if (err) console.log(err);
            //var result;
            var result = recordset.recordset;
            
            
    // dqQuery, function (err, recordset) {
        // if (err) console.log(err);
        //console.log('step 2');
        for(var i in result) {
          // globalCellQRCodeStore.push(result[i].cell_qr_code);
        }
        
        //console.log('globalCellQRCodeStore', globalCellQRCodeStore);
    });
    var dqQuery2=`SELECT cell_qr_code FROM taco_treceability.taco_treceability.production_count WHERE cell_qr_code like '03HC%' AND Month(date_time_start)=Month(getdate()) and Year(date_time_start)=Year(getdate())`;
    
    request2 = new sql.Request();
    request2.query(dqQuery2, function (err, recordset) {
        if (err) console.log(err);
        var result2;
        if(recordset) {
            result2 = recordset.recordset; 
        }
        
        // dqQuery2, function (err, result2, fields) {
            // if (err) console.log(err);
            //console.log('step 2');
            for(var i in result2) {
                globalCellQRCodeStore.push(result2[i].cell_qr_code);
            }
            //console.log('globalCellQRCodeStore', globalCellQRCodeStore);
        });
    // globalCellQRCodeStore_line2.length=0;
    // var dqQuery_line2=`SELECT cell_qr_code FROM production_count_data_archive WHERE Month(date_time_start)=Month(now()) and Year(date_time_start)=Year(now())`;
    // con_line2.query(dqQuery_line2, function (err, result_line2, fields) {
    //     if (err) console.log(err);
    //     //console.log('step 2');
    //     for(var i in result_line2) {
    //         globalCellQRCodeStore_line2.push(result_line2[i].cell_qr_code);
    //     }
       
    // });
    });
}

/*
function sendToArchive_Archive_to_Live_running(final_qr_code){
    var dqQuery=`SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive WHERE final_qr_code='${final_qr_code}'`;
    var globalCurrentStore=[];
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // dqQuery, function (err, recordset) {
            // if (err) console.log(err);
            //console.log('step 2');
            for(var i in result) {
                globalCurrentStore.push(result[i]);
            }
            //console.log('globalCurrentStore', globalCurrentStore);

            var insertQuery = 'INSERT INTO taco_treceability.taco_treceability.production_count(battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code, CustomerQRCode, date_time_end, total_module, rownum, moduleNumber, shift_incharge, shift_supervisor, range_from, range_to) VALUES'
            for(var i=0;i<globalCurrentStore.length;i++) {
                if(i==0) {
                    insertQuery += ` ('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','running','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}')`;
                } else {
                    insertQuery += `,('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','running','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}')`;
                }
            }

            // execute
            request2 = new sql.Request();
            request2.query(insertQuery, function (err, recordset) {
                if (err) console.log(err);
                var result2 = recordset.recordset;
            // insertQuery, function (err, result2, fields2) {
            //     if (err) console.log(err);
                if(!err) {
                    //console.log('successfull insert query');
                    setTimeout(() => {
                        truncateTable_Archive_to_Live_running(final_qr_code);
                    }, 1000);
                }
            });
            
        });
    });
}
*/
function sendToArchive_Archive_to_Live_running(final_qr_code){
    var dqQuery=`SELECT * FROM taco_treceability.taco_treceability.production_count_data_archive WHERE final_qr_code='${final_qr_code}'`;
    var globalCurrentStore=[];
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // dqQuery, function (err, recordset) {
            // if (err) console.log(err);
            //console.log('step 2');
            for(var i in result) {
                globalCurrentStore.push(result[i]);
            }
            //console.log('globalCurrentStore', globalCurrentStore);

            var insertQuery = 'INSERT INTO taco_treceability.taco_treceability.production_count(battery_id, battery_pack_name, cell_qr_code, battery_status, module_name, module_status, module_id, module_barcode, cell_status, date_time_start, shift, line, username, final_qr_code_status, final_qr_code, CustomerQRCode, date_time_end, total_module, rownum, moduleNumber, shift_incharge, shift_supervisor, range_from, range_to, cell_voltage, cell_ir,ocv_machine_location,ocv_scanned_time,ocv_kvalue,ocv_class,ocv_capacity) VALUES'
            for(var i=0;i<globalCurrentStore.length;i++) {
                if(i==0) {
                    insertQuery += ` ('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','running','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}','${globalCurrentStore[i].cell_voltage}','${globalCurrentStore[i].cell_ir}','${globalCurrentStore[i].ocv_machine_location}','${globalCurrentStore[i].ocv_scanned_time}','${globalCurrentStore[i].ocv_kvalue}','${globalCurrentStore[i].ocv_class}','${globalCurrentStore[i].ocv_capacity}')`;
                } else {
                    insertQuery += `,('${globalCurrentStore[i].battery_id}','${globalCurrentStore[i].battery_pack_name}','${globalCurrentStore[i].cell_qr_code}','running','${globalCurrentStore[i].module_name}','${globalCurrentStore[i].module_status}','${globalCurrentStore[i].module_id}','${globalCurrentStore[i].module_barcode}','${globalCurrentStore[i].cell_status}','${globalCurrentStore[i].date_time_start}','${globalCurrentStore[i].shift}','${globalCurrentStore[i].line}','${globalCurrentStore[i].username}','${globalCurrentStore[i].final_qr_code_status}','${globalCurrentStore[i].final_qr_code}','${globalCurrentStore[i].CustomerQRCode}','${globalCurrentStore[i].date_time_end}','${globalCurrentStore[i].total_module}','${globalCurrentStore[i].rownum}','${globalCurrentStore[i].moduleNumber}','${globalCurrentStore[i].shift_incharge}','${globalCurrentStore[i].shift_supervisor}','${globalCurrentStore[i].range_from}','${globalCurrentStore[i].range_to}','${globalCurrentStore[i].cell_voltage}','${globalCurrentStore[i].cell_ir}','${globalCurrentStore[i].ocv_machine_location}','${globalCurrentStore[i].ocv_scanned_time}','${globalCurrentStore[i].ocv_kvalue}','${globalCurrentStore[i].ocv_class}','${globalCurrentStore[i].ocv_capacity}')`;
                }
            }

            // execute
            request2 = new sql.Request();
            request2.query(insertQuery, function (err, recordset) {
                if (err) console.log(err);
                //var result2 = recordset.recordset;
            // insertQuery, function (err, result2, fields2) {
            //     if (err) console.log(err);
                if(!err) {
                    //console.log('successfull insert query');
                    setTimeout(() => {
                        truncateTable_Archive_to_Live_running(final_qr_code);
                    }, 1000);
                }
            });
            
        });
    });
}

function truncateTable_Archive_to_Live_running(final_qr_code) {
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(`delete from taco_treceability.taco_treceability.production_count_data_archive where final_qr_code='${final_qr_code}'`, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
        // `delete from production_count_data_archive where final_qr_code='${final_qr_code}'`, function (err, recordset) {
        //     if (err) console.log(err);
            if(!err) {
                //console.log('truncated Table');

                refreshInMemoryData_Archive_to_Live_running();
            }
        });
    });
}

// function getVoltageIrVal(barcode) {
//     return new Promise((resolve, reject) => {
//         sql.connect(sqlConfig, function (err) {
//             request = new sql.Request();
//             request.query(`SELECT TOP 1 * FROM taco_treceability.taco_treceability.ocv_machine_data WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
//                 // if (err) console.log(err);
//                 // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
//                     if (err2) console.log(err2);
//                     var result = recordset.recordset;
//                     var voltage_ir_str='NOT_FOUND';
//                     if(result.length>0) {
//                         voltage_ir_str=result[0].voltage+","+result[0].ir+","+result[0].updated_time+","+result[0].machine_location;
//                     }
                    
//                     request.query(`UPDATE taco_treceability.taco_treceability.ocv_machine_data set used_on_line='line_4' WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
//                         // if (err) console.log(err);
//                         // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
//                             if (err2) console.log(err2);
//                         //console.log('Update completed');
//                         resolve(voltage_ir_str);
//                     });
//                 //console.log('step 2');
//                 // resolve(voltage_ir_str);
//             });
//         });
//     })        
// }

function getVoltageIrVal(barcode) {
    return new Promise((resolve, reject) => {
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(`SELECT TOP 1 * FROM taco_treceability.taco_treceability.ocv_machine_data WHERE cell_qrcode = '${barcode}' order by sr_no desc`, function (err2, recordset) {
                // if (err) console.log(err);
                // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                    if (err2) console.log(err2);
                    var result = recordset.recordset;
                    var voltage_ir_str='NOT_FOUND';
                    if(result.length>0) {
                        voltage_ir_str=result[0].voltage+","+result[0].ir+","+result[0].updated_time+","+result[0].machine_location+","+result[0].kvalue+","+result[0].cell_class+","+result[0].cell_capacity;
                        request.query(`UPDATE taco_treceability.taco_treceability.ocv_machine_data set used_on_line='line_4' WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
                            // if (err) console.log(err);
                            // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                                if (err2) console.log(err2);
                            console.log('Update completed');
                            resolve(voltage_ir_str);
                        });
                        // request.query(`UPDATE taco_treceability.taco_treceability.ocv_machine_data_threedays set used_on_line='line_4' WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
                        //     // if (err) console.log(err);
                        //     // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                        //         if (err2) console.log(err2);
                           
                        // });
                    }
                    else{
                       
                        // threedays old table
                        request.query(`SELECT TOP 1 * FROM taco_treceability.taco_treceability.ocv_machine_data_threedays WHERE cell_qrcode = '${barcode}' order by sr_no desc`, function (err2, recordset) {
                            // if (err) console.log(err);
                            // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                                if (err2) console.log(err2);
                                var result = recordset.recordset;
                                 voltage_ir_str='NOT_FOUND';
                                if(result.length>0) {
                                    voltage_ir_str=result[0].voltage+","+result[0].ir+","+result[0].updated_time+","+result[0].machine_location+","+result[0].kvalue+","+result[0].cell_class+","+result[0].cell_capacity;
                                    request.query(`UPDATE taco_treceability.taco_treceability.ocv_machine_data_threedays set used_on_line='line_4' WHERE cell_qrcode = '${barcode}'`, function (err2, recordset) {
                                        // if (err) console.log(err);
                                        // `SELECT * FROM taco_treceability.production_count WHERE cell_status = 'incomplete' and line='1' ORDER BY sr_no ASC LIMIT 1;`, function (err, recordset) {
                                            if (err2) console.log(err2);
                                        console.log('Update completed');
                                        resolve(voltage_ir_str);
                                    });
                                }
                                else{
                                    resolve(voltage_ir_str);
                                    
                                }
                                
                        });

                    }
                    
                    
                    
                //console.log('step 2');
                // resolve(voltage_ir_str);
            });
        });
    })        
}


function getBatchval(barcode) {
    return new Promise(async(resolve, reject) => {
        //var batch_string=barcode.substring(14,17);
        var temp_plantcode=barcode.substring(12,14);
        var batch_string;
                        console.log("new Plantcode:",temp_plantcode);
     
                        if(temp_plantcode=='BJ' || temp_plantcode=="CJ"){
                           batch_string=barcode.substring(14,17);
                                  
                        }
                        else if(temp_plantcode=='BV'){
                           batch_string=barcode.substring(8,11);
                        }
                        else{
                           batch_string=barcode.substring(14,17);
                        }
      
        var data2;
        var mix_batch_temp; 
        var mix_bat_temp_arr = [];    
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(`SELECT * FROM taco_treceability.taco_treceability.line1runningbatch WHERE LineName = 'line4'`, function (err2, recordset) {
              
                    if (err2) console.log(err2);
                    var result = recordset.recordset;
                   
                    if(result.length>0) {
                        data2=result[0].selected_batches;
                        globalplant_code = result[0].plantcode;
                        mix_batch_temp =  result[0].mixed_batches;
                        mix_bat_temp_arr = mix_batch_temp.split(',');
                    }
                    globalAllowedBatches=data2.split(',');
                    console.log("globalplant_code111111111:",globalplant_code,current_cell_plant_code);
                    if(globalAllowedBatches.includes(batch_string)==true){
                        var current_cell_plant_code=barcode.substring(12,14);
                        console.log("globalplant_code;:",globalplant_code);
                        if(current_cell_plant_code == globalplant_code){
                            console.log("globalplant_code2222222222:",globalplant_code);
                            console.log('mix_bat_temp_arr',mix_bat_temp_arr)
                            console.log('mix_bat_temp_arr.length',mix_bat_temp_arr.length)
                            if(parseInt(mix_bat_temp_arr.length) < 3){
                                resolve("Valid Batch");
                            }
                            else if(parseInt(mix_bat_temp_arr.length) == 3){
                                if(mix_bat_temp_arr.includes(batch_string)==true){
                                    resolve("Valid Batch");
                                }
                                else{
                                    resolve("Mix Batch code");
                                    console.log('Invalid mix_bat_temp_arr',mix_bat_temp_arr,batch_string)
                                }
                            }
                            else{
                                resolve("Mix Batch code");
                            }
                            
                        }
                        else{
                            console.log("globalplant_code3333333333:",globalplant_code);
                            resolve("Invalid PCode");
                        }
                      
                       }
                       else{
                            resolve("Invalid Batch");
                       } 

           
            });
        });

        
    });
  
}

function refreshInMemoryData_Archive_to_Live_running(){
    globalCellQRCodeStore.length=0;
    // var dqQuery=`SELECT cell_qr_code FROM production_count_data_archive WHERE Month(date_time_start)=Month(now()) and Year(date_time_start)=Year(now())`;
    // var dqQuery=`SELECT cell_qr_code FROM production_count_data_archive WHERE date(date_time_start) >= date(getutcdate() - interval 1 day)`;
    var dqQuery=`SELECT cell_qr_code FROM taco_treceability.taco_treceability.production_count_data_archive WHERE line='4' and date_time_start BETWEEN CONVERT (DATE, GETDATE ()-1) AND CONVERT (DATE, GETDATE ())`;
    sql.connect(sqlConfig, function (err) {
        request = new sql.Request();
        request.query(dqQuery, function (err, recordset) {
            if (err) console.log(err);
            var result = recordset.recordset;
    // dqQuery, function (err, recordset) {
    //     if (err) console.log(err);
        //console.log('step 2');
        for(var i in result) {
            globalCellQRCodeStore.push(result[i].cell_qr_code);
        }
        
        //console.log('globalCellQRCodeStore', globalCellQRCodeStore);
    });
    var dqQuery2=`SELECT cell_qr_code FROM taco_treceability.taco_treceability.production_count WHERE cell_qr_code like '03HC%' AND Month(date_time_start)=Month(getdate()) and Year(date_time_start)=Year(getdate())`;
        request2 = new sql.Request();
        request2.query(dqQuery2, function (err, recordset) {
            if (err) console.log(err);
            var result2 = recordset.recordset;
        // dqQuery2, function (err, result2, fields) {
        //     if (err) console.log(err);
            //console.log('step 2');
            for(var i in result2) {
                globalCellQRCodeStore.push(result2[i].cell_qr_code);
            }
            //console.log('globalCellQRCodeStore', globalCellQRCodeStore);
        });
   // globalCellQRCodeStore_line2.length=0;
    // var dqQuery_line2=`SELECT cell_qr_code FROM production_count_data_archive WHERE Month(date_time_start)=Month(now()) and Year(date_time_start)=Year(now())`;
    // con_line2.query(dqQuery_line2, function (err, result_line2, fields) {
    //     if (err) console.log(err);
    //     //console.log('step 2');
    //     for(var i in result) {
    //         globalCellQRCodeStore_line2.push(result_line2[i].cell_qr_code);
    //     }
       
    // });
    });
}

// function runModuleSerialQuery173(ModuleName1) {
//     return new Promise((resolve, reject) => {
//         var resultArr = [];
//         sql.connect(sqlConfig, function (err) {
//             request = new sql.Request();
//             request.query(`SELECT TOP 1 moduleSerialNumber FROM taco_treceability.taco_treceability.createModule WHERE line='4' and moduleName = '${ModuleName1}' ORDER BY srno DESC`, function (err, recordset) {
//                 if (err) console.log(err);
//                 var result = recordset.recordset;
//             // `SELECT moduleSerialNumber FROM taco_treceability.createModule WHERE line='1' and moduleName = '${ModuleName1}' ORDER BY srno DESC LIMIT 1`, function (err, recordset) {
//                 // if (err) console.log(err);
//                 for (i in result) {
//                     // tempArray.push(result[i].moduleName);
//                     //  tempArray.push(result[i].moduleCode);
//                     resultArr.push(result[i].moduleSerialNumber.substring(1,));
//                 }
//                 resolve(resultArr);
//             });
//         });
//     })
// }

function runModuleSerialQuery173(ModuleName1) {
    return new Promise((resolve, reject) => {
        console.log("11111")
        const resultArr = [];
        // Generate a random number between 500 and 1500
        const randomNumber = Math.floor(Math.random() * (1500 - 500 + 1)) + 500;
        console.log("222",randomNumber)
        // Pad it with leading zeros to make it 6 digits
        const paddedSerial = String(randomNumber).padStart(6, '0');
        console.log("333",paddedSerial)
        // Push to the result array
        resultArr.push(paddedSerial);
        // Resolve the promise
        resolve(resultArr);
    });
}


function runInsertQuery229(ModuleName1, MODULEBARCODE1, SystemcurrentTime, moduleSerialNumberGen) {
    return new Promise((resolve, reject) => {
        var sql1 = `INSERT INTO taco_treceability.taco_treceability.createModule ( moduleName,moduleCode, moduleEntryDate,moduleSerialNumber,line) VALUES ('${ModuleName1}', '${MODULEBARCODE1}', '${SystemcurrentTime}', '${"0"+moduleSerialNumberGen.substring(1,)}','4');`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(sql1, function (err, recordset) {
                if (err) console.log(err);

                var result = recordset.recordset;
            
                // if (err) console.log(err);
                // console.log("7th step 1 record inserted", runningModule);
                resolve();

            });
        });

    })
}

function updateFirstModuleOfPack(firstmoduleString, FINALQRCODE) {
    return new Promise((resolve, reject) => {
        var sql2 = `update taco_treceability.taco_treceability.production_count SET module_status='running' where module_barcode='${firstmoduleString}'  and final_qr_code='${FINALQRCODE}'`;
        sql.connect(sqlConfig, function (err) {
            request = new sql.Request();
            request.query(sql2, function (err, recordset) {
                if (err) console.log(err);
                // var result = recordset.recordset;
            
                // if (err) console.log(err);
                // console.log("8th step if 1 record inserted");
                // callback(null);
                resolve();

            });
        });

    })
}


// XNG new script


// const insert_create_pack = async (packName, FINALQRCODE, PacklineNumber) => {
//     try {


//         await dbConn2.close(); // Close the connection after use


//         const pool_mis = await sql.connect({
//             user: "user_mis",
//             password: "admin",
//             server: "10.9.4.28\\MSSQLSERVER",
//             database: "taco_treceability",
//             options: {
//                 encrypt: true,
//                 trustServerCertificate: true,
//             },
//         });

       

//          // Format the date manually
//         const now = new Date();
//         const formattedDate = now.toISOString().slice(0, 23).replace("T", " "); // "YYYY-MM-DD HH:MM:SS.mmm"

//         console.log("data for inserting....",FINALQRCODE,packName,PacklineNumber)

//         const query = `INSERT INTO [taco_treceability].[taco_treceability].[createpack] 
//                        ([packName], [packQRCode], [packEntryDate], [packSerialNumber], [line])
//                        VALUES (@packName, @packQRCode,  @FormattedDate, @packSerialNumber, 4);`;
        
//         const result = await pool_mis.request()
//             .input("packName", sql.VarChar, packName)
//             .input("packQRCode", sql.VarChar, FINALQRCODE)
//             .input("FormattedDate", sql.VarChar, formattedDate)
//             .input("packSerialNumber", sql.VarChar, PacklineNumber)
//             .query(query);

//         return result.rowsAffected[0] > 0 ? "Inserted" : "Insertion failed";
//     } catch (error) {
//         console.error(" Error inserting data:", error.message);
//         throw error;
//     }
// };

// XNG new script
