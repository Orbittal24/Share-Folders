# trigger_on_change.py
import time
import pyodbc
import requests

SQL_CONN_STR = (
    'DRIVER={ODBC Driver 17 for SQL Server};'
    'SERVER=TGTCNWS904;'
    'DATABASE=taco_treceability_ir;'
    'UID=user_mis;'
    'PWD=admin'
)

API_ENDPOINT = 'https://mismainapp.tataautocomp.com:3241/trigger_nomenclature_fetch'

last_seen = {}

def poll_and_trigger():
    # ✅ Reuse HTTP connection
    session = requests.Session()

    while True:
        try:
            conn = pyodbc.connect(SQL_CONN_STR)
            cursor = conn.cursor()

            cursor.execute("""
                SELECT srno, station_id, controller_ip, pack_id, gun,
                       process_id, line_id, Received_Data, Date_Time
                FROM taco_treceability.ir_controller_configuration
                WHERE Received_Data IS NOT NULL
            """)

            rows = cursor.fetchall()

            for row in rows:
                srno, station_id, controller_ip, pack_id, gun, process_id, line_id, Received_Data, date_time = row

                if last_seen.get(srno) == date_time:
                    continue

                last_seen[srno] = date_time

                payload = {
                    "station_id": station_id,
                    "controller_ip": controller_ip,
                    "pack_id": pack_id,
                    "gun": gun,
                    "process_id": process_id,
                    "line_id": line_id,
                    "Received_Data": Received_Data
                }

                print("payload", payload)

                try:
                    response = session.post(
                        API_ENDPOINT,
                        json=payload,
                        timeout=5   # ✅ prevent hanging sockets
                    )

                    if response.status_code == 200:
                        print(f"[OK] API triggered for srno {srno}")
                    else:
                        print(f"[ERROR] API failed for srno {srno}, Status: {response.status_code}")

                except requests.exceptions.RequestException as api_err:
                    print(f"[ERROR] API error for srno {srno}: {api_err}")

                time.sleep(0.2)  # ✅ throttle API calls

            cursor.close()
            conn.close()

            time.sleep(2)  # poll interval

        except Exception as e:
            print("[ERROR] Error polling table:", e)
            time.sleep(5)

if __name__ == "__main__":
    poll_and_trigger()
