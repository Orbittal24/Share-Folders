‚úÖ STEP 1: Create Extended Event Session (Run Once)
CREATE EVENT SESSION Capture_Delete_Queries
ON SERVER
ADD EVENT sqlserver.sql_statement_completed
(
    ACTION
    (
        sqlserver.sql_text,
        sqlserver.client_hostname,
        sqlserver.username,
        sqlserver.database_name,
        sqlserver.session_id
    )
    WHERE
        UPPER(LTRIM(sqlserver.sql_text)) LIKE 'DELETE %'
)
ADD TARGET package0.event_file
(
    SET filename = 'C:\SQLLogsQueries\DeleteQueries.xel',
        max_file_size = 50,        -- MB
        max_rollover_files = 10
);
GO

üìå What this does

Captures every DELETE statement

Case-insensitive (DELETE, delete, Delete, etc.)

From all applications & services

Across all databases

Low performance impact

‚ñ∂Ô∏è STEP 2: Start the Event Session
ALTER EVENT SESSION Capture_Delete_Queries
ON SERVER
STATE = START;
GO


üìç From this moment onward ‚Üí all DELETE queries are logged automatically

üëÄ STEP 3: View Captured DELETE Queries Anytime
SELECT
    event_data.value('(event/@timestamp)[1]', 'datetime2') AS event_time,
    event_data.value('(event/action[@name="database_name"]/value)[1]', 'sysname') AS database_name,
    event_data.value('(event/action[@name="username"]/value)[1]', 'sysname') AS username,
    event_data.value('(event/action[@name="client_hostname"]/value)[1]', 'nvarchar(256)') AS client_host,
    event_data.value('(event/action[@name="sql_text"]/value)[1]', 'nvarchar(max)') AS delete_query,
    event_data.value('(event/data[@name="row_count"]/value)[1]', 'int') AS rows_deleted
FROM
(
    SELECT CAST(event_data AS XML) AS event_data
    FROM sys.fn_xe_file_target_read_file(
        'C:\SQLLogsQueries\DeleteQueries*.xel',
        NULL, NULL, NULL
    )
) t
ORDER BY event_time DESC;

‚èπÔ∏è STEP 4: Stop the Event Session (If Required)
ALTER EVENT SESSION Capture_Delete_Queries
ON SERVER
STATE = STOP;
GO
