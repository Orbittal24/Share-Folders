const { Console } = require("console");

module.exports = {
    includeCode: function (io, sql, sqlConfig) {

        // üî• Prevent duplicate loading
        if (global.__includeCodeLoaded__) {
            console.log("‚ùå includeCode already loaded, skipping...");
            return;
        }
        global.__includeCodeLoaded__ = true;
        console.log("üî• includeCode LOADED FIRST TIME ONLY");

        var path = require("path");
        var net = require('net');
        const multer = require("multer");
        var bodyParser = require('body-parser');
        var WebSocketServer = require('websocket').server;
        var http = require("http");
        var sockets = [];
        var events = require('events');
        var em = new events.EventEmitter();
        var express = require("express"),
            app = require("express")(),
            util = require("util"),
            fs = require("fs");
        var moment = require('moment');

        app.use(bodyParser.json());

        function getConn(connName) {
            var option = { host: '127.0.0.1', port: 3306 };

            var client = net.createConnection(option, function () {
                console.log('Connection name : ' + connName);
                console.log('Connection local address : ' + client.localAddress + ":" + client.localPort);
                console.log('Connection remote address : ' + client.remoteAddress + ":" + client.remotePort);
            });

            client.setTimeout(1000);
            client.setEncoding('utf8');

            client.on('data', function (data) { console.log('Server return data : ' + data); });
            client.on('end', function () { console.log('Client socket disconnect. '); });
            client.on('timeout', function () { console.log('Client connection timeout. '); });
            client.on('error', function (err) { console.error(JSON.stringify(err)); });

            return client;
        }

        var HOST = '127.0.0.1';
        var PORT = 3306;
        global.MYVAR = "connected!";
        global.MYVAR2 = "connected!";
        var server = net.createServer();

        app.use(express.static(__dirname));
        app.use(bodyParser.json({ limit: '16mb' }));
        app.use(bodyParser.urlencoded({ extended: false, limit: '16mb' }));

        io.sockets.removeAllListeners("connection"); // Prevent multiple connection events
        io.sockets.on("connection", function (socket) {
            
            socket.removeAllListeners('callread');
            socket.on('callread', function (msg) {
                MYVAR = msg;
                for (var i = 0; i < sockets.length; i++) {
                    if (sockets[i]) {
                        sockets[i].write(MYVAR, 'utf-8');
                    }
                }
            });

            ///////////////////////// OK DATA ///////////////////////////
            socket.removeAllListeners('date_selected_searchdata_count_OK');
            socket.on('date_selected_searchdata_count_OK', (date) => {
                console.log("Received date from client IRRRR search count:", date);

                const final_qrcode_arr_eip_count = [];

                sql.connect(sqlConfig, function (err) {
                    if (err) {
                        console.log("SQL Connection Error:", err);
                        return;
                    }

                    const request = new sql.Request();
                    const query = `
                        SELECT DISTINCT pack_no 
                        FROM taco_treceability.torque_details_EIP 
                        WHERE CONVERT(varchar(200), date_dd) < '${date}' 
                          AND pack_no != 'not_linked'
                    `;

                    request.query(query, async function (err, result) {
                        if (err) {
                            console.log("SQL Query Error:", err);
                            return;
                        }

                        result.recordset.forEach(row => final_qrcode_arr_eip_count.push(row.pack_no));

                        try {
                            const collectedFinalQRCodes_count = [];

                            for (const packNo of final_qrcode_arr_eip_count) {
                                const safePackNo = packNo.replace(/'/g, "''");

                                const innerQuery = `
                                    SELECT DISTINCT FinalQRCode 
                                    FROM taco_treceability.station_status 
                                    WHERE FinalQRCode LIKE '%${safePackNo}%' 
                                      AND FinalQRCodePrint_status = 'OK'
                                `;

                                const innerRequest = new sql.Request();
                                const result = await innerRequest.query(innerQuery);
                                if (result.recordset.length > 0) {
                                    collectedFinalQRCodes_count.push(...result.recordset.map(r => r.FinalQRCode));
                                }
                            }

                            console.log("Final QRCodes from station_status ok:", collectedFinalQRCodes_count);

                            let totalCount = 0;
                            for (const finalQRCode of collectedFinalQRCodes_count) {
                                const safeQRCode = finalQRCode.replace(/'/g, "''");
                                const additionalQuery = `
                                    SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, process_status, pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, 
                                           smoke_sensor_linked_pack_no 
                                    FROM taco_treceability.torque_details_EIP 
                                    WHERE pack_no LIKE '%${safeQRCode}%'
                                `;
                                const additionalRequest = new sql.Request();
                                const additionalResult = await additionalRequest.query(additionalQuery);
                                totalCount += additionalResult.recordset.length;
                            }

                            console.log('TOTAL Count_EIP_data:', totalCount);
                            socket.emit('total_eip_data_count_fe', totalCount);

                        } catch (err) {
                            console.error("Error during FinalQRCode fetching:", err);
                        }
                    });
                });
            });

            socket.removeAllListeners('date_selected_OK');
            socket.on('date_selected_OK', (date) => {
                console.log("Received date from client IRRRR shift:", date);

                const final_qrcode_arr_eip = [];

                sql.connect(sqlConfig, function (err) {
                    if (err) {
                        console.log("SQL Connection Error:", err);
                        return;
                    }

                    const request = new sql.Request();
                    const query = `
                        SELECT DISTINCT pack_no 
                        FROM taco_treceability.torque_details_EIP 
                        WHERE CONVERT(varchar(200), date_dd) < '${date}' 
                          AND pack_no != 'not_linked'
                    `;

                    request.query(query, async function (err, result) {
                        if (err) {
                            console.log("SQL Query Error:", err);
                            return;
                        }

                        result.recordset.forEach(row => final_qrcode_arr_eip.push(row.pack_no));

                        try {
                            const collectedFinalQRCodes = [];

                            for (const packNo of final_qrcode_arr_eip) {
                                const safePackNo = packNo.replace(/'/g, "''");

                                const innerQuery = `
                                    SELECT DISTINCT FinalQRCode 
                                    FROM taco_treceability.station_status 
                                    WHERE FinalQRCode LIKE '%${safePackNo}%' 
                                      AND FinalQRCodePrint_status = 'OK'
                                `;

                                const innerRequest = new sql.Request();
                                const result = await innerRequest.query(innerQuery);

                                if (result.recordset.length > 0) {
                                    collectedFinalQRCodes.push(...result.recordset.map(r => r.FinalQRCode));
                                }
                            }

                            for (const finalQRCode of collectedFinalQRCodes) {
                                const safeQRCode = finalQRCode.replace(/'/g, "''");

                                const additionalQuery = `
                                    SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, process_status, 
                                           pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no 
                                    FROM taco_treceability.torque_details_EIP 
                                    WHERE pack_no LIKE '%${safeQRCode}%'
                                `;
                                const additionalRequest = new sql.Request();
                                const additionalResult = await additionalRequest.query(additionalQuery);

                                if (additionalResult.recordset.length > 0) {
                                    for (const record of additionalResult.recordset) {
                                        const insertQuery = `
                                            INSERT INTO taco_treceability.torque_details_EIP_import2
                                            (pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, 
                                             process_status, pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, 
                                             smoke_sensor_linked_pack_no)
                                            VALUES
                                            ('${record.pack_name}', '${record.module_name}', '${record.torque}', '${record.angle}', 
                                             '${record.torque_status}', '${record.date_dd}', '${record.shift}', '${record.module_barcode}', 
                                             '${record.process_status}', '${record.pack_no}', '${record.rework_status}', '${record.bypass_operator}', 
                                             '${record.bypass_reason}', '${record.process_name}', '${record.station_name}', '${record.smoke_sensor_linked_pack_no}')
                                        `;
                                        const insertRequest = new sql.Request();
                                        await insertRequest.query(insertQuery);
                                    }
                                    console.log('Data inserted into torque_details_EIP_import2 for QRCode:', finalQRCode);
                                } else {
                                    console.log('No data found for QRCode:', finalQRCode);
                                }
                            }

                            const deleteQuery = `
                                DELETE FROM taco_treceability.torque_details_EIP 
                                WHERE pack_no IN (${collectedFinalQRCodes.map(qr => `'${qr.replace(/'/g, "''")}'`).join(', ')})
                            `;
                            const deleteRequest = new sql.Request();
                            await deleteRequest.query(deleteQuery);

                            console.log("Data deleted from torque_details_EIP");

                            socket.emit("data_inserted_and_deleted", { message: "Data has been inserted into torque_details_EIP_import2 and deleted from taco_treceability.torque_details_EIP" });

                        } catch (err) {
                            console.error("Error during FinalQRCode fetching and insertion:", err);
                        }
                    });
                });
            });

            ///////////////////////// NOT OK DATA ///////////////////////////
            socket.removeAllListeners('date_selected_searchdata_count_notok_shifting');
            socket.on('date_selected_searchdata_count_notok_shifting', (date) => {
                console.log("Received date from client IRRRR search count:", date);

                const final_qrcode_arr_eip_count_notok = [];

                sql.connect(sqlConfig, function (err) {
                    if (err) {
                        console.log("SQL Connection Error:", err);
                        return;
                    }

                    const request = new sql.Request();
                    const query = `
                        SELECT DISTINCT pack_no 
                        FROM taco_treceability.torque_details_EIP 
                        WHERE CONVERT(varchar(200), date_dd) < '${date}' 
                          AND pack_no != 'not_linked'
                    `;

                    request.query(query, async function (err, result) {
                        if (err) {
                            console.log("SQL Query Error:", err);
                            return;
                        }

                        result.recordset.forEach(row => final_qrcode_arr_eip_count_notok.push(row.pack_no));

                        try {
                            const collectedFinalQRCodes_count = [];

                            for (const packNo of final_qrcode_arr_eip_count_notok) {
                                const safePackNo = packNo.replace(/'/g, "''");

                                const innerQuery = `
                                    SELECT DISTINCT FinalQRCode 
                                    FROM taco_treceability.station_status 
                                    WHERE FinalQRCode LIKE '%${safePackNo}%' 
                                      AND FinalQRCodePrint_status = 'NOT OK'
                                `;

                                const innerRequest = new sql.Request();
                                const result = await innerRequest.query(innerQuery);

                                if (result.recordset.length > 0) {
                                    collectedFinalQRCodes_count.push(...result.recordset.map(r => r.FinalQRCode));
                                }
                            }

                            console.log("Final QRCodes from station_status not ok:", collectedFinalQRCodes_count);

                            let totalCount = 0;
                            for (const finalQRCode of collectedFinalQRCodes_count) {
                                const safeQRCode = finalQRCode.replace(/'/g, "''");
                                const additionalQuery = `
                                    SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, process_status, pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, 
                                           smoke_sensor_linked_pack_no 
                                    FROM taco_treceability.torque_details_EIP 
                                    WHERE pack_no LIKE '%${safeQRCode}%'
                                `;
                                const additionalRequest = new sql.Request();
                                const additionalResult = await additionalRequest.query(additionalQuery);
                                totalCount += additionalResult.recordset.length;
                            }

                            console.log('TOTAL Count_EIP_data:', totalCount);
                            socket.emit('total_eip_data_count_fe_notok', totalCount);

                        } catch (err) {
                            console.error("Error during FinalQRCode fetching:", err);
                        }
                    });
                });
            });

            socket.removeAllListeners('date_selected_notok_shifting');
            socket.on('date_selected_notok_shifting', (date) => {
                console.log("Received date from client IRRRR:", date);

                const final_qrcode_arr_eip_notok = [];

                sql.connect(sqlConfig, function (err) {
                    if (err) {
                        console.log("SQL Connection Error:", err);
                        return;
                    }

                    const request = new sql.Request();
                    const query = `
                        SELECT DISTINCT pack_no 
                        FROM taco_treceability.torque_details_EIP 
                        WHERE CONVERT(varchar(200), date_dd) < '${date}' 
                          AND pack_no != 'not_linked'
                    `;

                    request.query(query, async function (err, result) {
                        if (err) {
                            console.log("SQL Query Error:", err);
                            return;
                        }

                        result.recordset.forEach(row => final_qrcode_arr_eip_notok.push(row.pack_no));

                        try {
                            const collectedFinalQRCodes = [];

                            for (const packNo of final_qrcode_arr_eip_notok) {
                                const safePackNo = packNo.replace(/'/g, "''");

                                const innerQuery = `
                                    SELECT DISTINCT FinalQRCode 
                                    FROM taco_treceability.station_status 
                                    WHERE FinalQRCode LIKE '%${safePackNo}%' 
                                      AND FinalQRCodePrint_status = 'NOT OK'
                                `;

                                const innerRequest = new sql.Request();
                                const result = await innerRequest.query(innerQuery);

                                if (result.recordset.length > 0) {
                                    collectedFinalQRCodes.push(...result.recordset.map(r => r.FinalQRCode));
                                }
                            }

                            for (const finalQRCode of collectedFinalQRCodes) {
                                const safeQRCode = finalQRCode.replace(/'/g, "''");

                                const additionalQuery = `
                                    SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, process_status, 
                                           pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no 
                                    FROM taco_treceability.torque_details_EIP 
                                    WHERE pack_no LIKE '%${safeQRCode}%'
                                `;
                                const additionalRequest = new sql.Request();
                                const additionalResult = await additionalRequest.query(additionalQuery);

                                if (additionalResult.recordset.length > 0) {
                                    for (const record of additionalResult.recordset) {
                                        const insertQuery = `
                                            INSERT INTO taco_treceability.torque_details_EIP_import2
                                            (pack_name, module_name, torque, angle, torque_status, date_dd, shift, module_barcode, 
                                             process_status, pack_no, rework_status, bypass_operator, bypass_reason, process_name, station_name, 
                                             smoke_sensor_linked_pack_no)
                                            VALUES
                                            ('${record.pack_name}', '${record.module_name}', '${record.torque}', '${record.angle}', 
                                             '${record.torque_status}', '${record.date_dd}', '${record.shift}', '${record.module_barcode}', 
                                             '${record.process_status}', '${record.pack_no}', '${record.rework_status}', '${record.bypass_operator}', 
                                             '${record.bypass_reason}', '${record.process_name}', '${record.station_name}', '${record.smoke_sensor_linked_pack_no}')
                                        `;
                                        const insertRequest = new sql.Request();
                                        await insertRequest.query(insertQuery);
                                    }
                                    console.log('Data inserted into torque_details_EIP_import2 for QRCode:', finalQRCode);
                                } else {
                                    console.log('No data found for QRCode:', finalQRCode);
                                }
                            }

                            const deleteQuery = `
                                DELETE FROM taco_treceability.torque_details_EIP 
                                WHERE pack_no IN (${collectedFinalQRCodes.map(qr => `'${qr.replace(/'/g, "''")}'`).join(', ')})
                            `;
                            const deleteRequest = new sql.Request();
                            await deleteRequest.query(deleteQuery);

                            console.log("Data deleted from torque_details_EIP");

                            socket.emit("data_inserted_and_deleted_notok", { message: "Data has been inserted into torque_details_EIP_import2 and deleted from taco_treceability.torque_details_EIP" });

                        } catch (err) {
                            console.error("Error during FinalQRCode fetching and insertion:", err);
                        }
                    });
                });
            });

        });

        console.log('IRTesing code imported');
    }
};
