function update_defetclist_pack_assembly(defect_name, qrcode_str, packname) {

    console.log("rework_yogita:", defect_name, qrcode_str);

    sql.connect(sqlConfig, function (err) {
        if (err) return console.log(err);

        let request = new sql.Request();

        // 1️⃣ FETCH existing final_qrcode
        request.query(
            `SELECT final_qrcode 
             FROM taco_treceability.taco_treceability.rework_defect_list 
             WHERE defect_name='${defect_name}'`,
            function (err, recordset) {

                if (err) return console.log(err);

                let result = recordset.recordset;
                if (result.length === 0) return;

                let final_qrcode = result[0].final_qrcode;
                let new_qrstr = "";

                // 2️⃣ CASE 1: final_qrcode is NULL or empty → set new STRING
                if (!final_qrcode || final_qrcode === 'null' || final_qrcode === '') {

                    new_qrstr = qrcode_str;

                    // UPDATE query
                    let updateReq = new sql.Request();
                    updateReq.query(
                        `UPDATE taco_treceability.taco_treceability.rework_defect_list
                         SET final_qrcode='${new_qrstr}'
                         WHERE defect_name='${defect_name}'`,
                        function (err) {
                            if (err) console.log(err);
                        }
                    );

                } else {

                    // 3️⃣ CASE 2: Append only if NOT already included
                    if (!final_qrcode.includes(qrcode_str)) {

                        new_qrstr = final_qrcode + "," + qrcode_str;

                        let updateReq = new sql.Request();
                        updateReq.query(
                            `UPDATE taco_treceability.taco_treceability.rework_defect_list
                             SET final_qrcode='${new_qrstr}'
                             WHERE defect_name='${defect_name}'`,
                            function (err) {
                                if (err) console.log(err);
                            }
                        );
                    } else {
                        // If already included, keep original
                        new_qrstr = final_qrcode;
                    }
                }

                // 4️⃣ INSERT QUERY (run for BOTH cases)
                let insertReq = new sql.Request();
                insertReq.query(
                    `INSERT INTO taco_treceability.mis_rejection_data
                     (battery_pack_name, rework_status, final_qrcode, station, rework_remark)
                     VALUES ('${packname}', 'rejected', '${new_qrstr}', 'alt_station', '${defect_name}')`,
                    function (err) {
                        if (err) console.log(err);
                        else console.log("Insert success");
                    }
                );

            }
        );
    });
}
