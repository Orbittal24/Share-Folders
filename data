const net = require("net");
const fs = require("fs");
const { exec } = require("child_process");

const CLIENT_PORT = 7090; // Must match server port

// Create TCP server to receive PRN data
const server = net.createServer((socket) => {
  console.log("ðŸ“¥ Connection received from server.");

  let prnData = "";

  socket.on("data", (chunk) => {
    prnData += chunk.toString();
  });

  socket.on("end", () => {
    console.log("âœ… Data received. Sending to USB printer...");

    // Save PRN data to a temporary file
    const filePath = "printjob.prn";
    fs.writeFileSync(filePath, prnData, "utf8");

    // Send the file to printer (USB001 or LPT1)
    // Change "USB001" to your printerâ€™s port name or use the printer name directly
    exec(`print /D:USB001 ${filePath}`, (err, stdout, stderr) => {
      if (err) {
        console.error("âŒ Print command error:", err.message);
        return;
      }
      console.log("âœ… Print command executed.");
      console.log(stdout);
    });
  });
});

server.listen(CLIENT_PORT, () => {
  console.log(`ðŸš€ Client listening on port ${CLIENT_PORT} for print jobs...`);
});
