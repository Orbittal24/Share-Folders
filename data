const net = require("net");

const CLIENT_PORT = 7090; // Must match server port
const PRINTER_IP = "10.9.4.76";
const PRINTER_PORT = 9100; // RAW printing port

// Create TCP server to receive PRN data
const server = net.createServer((socket) => {
  console.log("📥 Connection received from server.");

  let prnData = "";

  socket.on("data", (chunk) => {
    prnData += chunk.toString();
  });

  socket.on("end", () => {
    console.log("✅ Data received. Forwarding to printer...");

    // Connect to printer directly
    const printer = new net.Socket();
    printer.connect(PRINTER_PORT, PRINTER_IP, () => {
      console.log(`🖨️ Connected to printer at ${PRINTER_IP}:${PRINTER_PORT}`);
      printer.write(prnData, "utf8", () => {
        console.log("✅ Print data sent successfully!");
        printer.end();
      });
    });

    printer.on("error", (err) => {
      console.error("❌ Printer connection error:", err.message);
    });

    printer.on("close", () => {
      console.log("🔌 Printer connection closed.");
    });
  });
});

server.listen(CLIENT_PORT, () => {
  console.log(`🚀 Client listening on port ${CLIENT_PORT} for print jobs...`);
});
