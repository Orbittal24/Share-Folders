const sql = require("mssql");

// DB CONFIGS
const sqlConfig1 = {
  user: "user_mis",
  password: "admin",
  database: "taco_treceability",
  server: "10.9.4.28",
  pool: { max: 10, min: 0, idleTimeoutMillis: 30000 },
  options: { encrypt: true, trustServerCertificate: true }
};

const sqlConfig2 = {
  user: "user_mis",
  password: "admin",
  database: "taco_treceability_OVC",
  server: "10.9.4.28",
  pool: { max: 10, min: 0, idleTimeoutMillis: 30000 },
  options: { encrypt: true, trustServerCertificate: true }
};

// MAPPING TABLES
const yearMap = {
  B: 21, C: 22, D: 23, E: 24, F: 25, G: 26, H: 27, J: 28, K: 29, L: 30,
  M: 31, N: 32, P: 33, R: 34, S: 35, T: 36, V: 37, W: 38, X: 39, Y: 40,
  1: 41, 2: 42, 3: 43, 4: 44, 5: 45, 6: 46, 7: 47, 8: 48, 9: 49, A: 50
};

const monthMap = { 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, A: 10, B: 11, C: 12 };

const dayMap = {
  1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9,
  A: 10, B: 11, C: 12, D: 13, E: 14, F: 15, G: 16, H: 17, J: 18, K: 19,
  L: 20, M: 21, N: 22, P: 23, R: 24, S: 25, T: 26, V: 27, W: 28, X: 29,
  Y: 30, 0: 31
};

const specialCodes = ["BJ", "CJ", "CR", "GD", "AG", "DR"];

// -----------------------------------------------------
// PROCESS ONE RECORD
// -----------------------------------------------------
async function processRecord() {
  const src = await sql.connect(sqlConfig1);
  const dst = await sql.connect(sqlConfig2);

  // Fetch ONE record
  const fetch = await src.request().query(`
        SELECT TOP 1 *
        FROM taco_treceability.ocv_machine_data_mirror
        ORDER BY sr_no ASC
    `);

  if (fetch.recordset.length === 0) {
    console.log("No new records...");
    return;
  }

  const row = fetch.recordset[0];
  const qr = row.cell_qrcode;

  console.log("\n================ NEW RECORD ================");
  console.log("QR CODE:", qr);

  // -----------------------
  // STEP 1: Extract date code safely
  // -----------------------
  if (!qr || qr.length < 16) {
    console.error("âŒ ERROR: QR too short, skipping:", qr);
    return;
  }

  const code12_13 = qr.substring(11, 13);
  console.log("Extracted 12-13 Code:", code12_13);

  let dateCode = "";

  if (specialCodes.includes(code12_13)) {
    dateCode = qr.substring(13, 16);
  } else {
    dateCode = qr.substring(7, 10);
  }

  console.log("Extracted Date Code:", dateCode);

  const yearChar = dateCode[0];
  const monthChar = dateCode[1];
  const dayChar = dateCode[2];

  console.log("Parsed Date Characters:", { yearChar, monthChar, dayChar });

  // -----------------------
  // STEP 2: Map from code tables
  // -----------------------
  const yearValue = yearMap[yearChar];
  const monthValue = monthMap[monthChar];
  const dayValue = dayMap[dayChar];

  console.log("Mapped Date Values:", { yearValue, monthValue, dayValue });

  if (!yearValue || !monthValue || !dayValue) {
    console.error("âŒ ERROR: Mapping failed! Skipping QR:", qr);
    return;
  }

  const year = 2000 + yearValue;
  const month = monthValue.toString().padStart(2, "0");
  const day = dayValue.toString().padStart(2, "0");

  const tableName = `dbo.ocv_cell_data_${year}_${month}_${day}`;
  console.log("Target Table:", tableName);

  // -----------------------
  // STEP 3: Create table if missing
  // -----------------------
  await dst.request().query(`
        IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'ocv_cell_data_${year}_${month}_${day}')
        CREATE TABLE ${tableName} (
            sr_no INT,
            cell_qrcode VARCHAR(100),
            voltage FLOAT,
            ir FLOAT,
            today_date DATETIME,
            updated_time DATETIME,
            machine_location VARCHAR(50),
            shift VARCHAR(10),
            used_on_line VARCHAR(10),
            kvalue FLOAT,
            grade VARCHAR(50),
            cell_capacity FLOAT,
            cell_class VARCHAR(50)
        );
    `);

  // -----------------------
  // STEP 4: Insert / Update
  // -----------------------
  const check = await dst.request()
    .input("qr", sql.VarChar, qr)
    .query(`SELECT * FROM ${tableName} WHERE cell_qrcode = @qr`);

  if (check.recordset.length === 0) {
    // INSERT
    await dst.request()
      .input("sr_no", sql.Int, row.sr_no)
      .input("cell_qrcode", sql.VarChar, row.cell_qrcode)
      .input("voltage", sql.Float, row.voltage)
      .input("ir", sql.Float, row.ir)
      .input("today_date", sql.DateTime, row.today_date)
      .input("updated_time", sql.DateTime, row.updated_time)
      .input("machine_location", sql.VarChar, row.machine_location)
      .input("shift", sql.VarChar, row.shift)
      .input("used_on_line", sql.VarChar, row.used_on_line)
      .input("kvalue", sql.Float, row.kvalue)
      .input("grade", sql.VarChar, row.grade)
      .input("cell_capacity", sql.Float, row.cell_capacity)
      .input("cell_class", sql.VarChar, row.cell_class)
      .query(`
                INSERT INTO ${tableName}
                VALUES (@sr_no, @cell_qrcode, @voltage, @ir, @today_date, @updated_time,
                        @machine_location, @shift, @used_on_line, @kvalue, @grade, @cell_capacity, @cell_class)
            `);

    console.log(`âœ… INSERTED â†’ ${qr}`);
  } else {
    // UPDATE
    await dst.request()
      .input("qr", sql.VarChar, qr)
      .input("voltage", sql.Float, row.voltage)
      .input("ir", sql.Float, row.ir)
      .input("today_date", sql.DateTime, row.today_date)
      .input("updated_time", sql.DateTime, row.updated_time)
      .input("machine_location", sql.VarChar, row.machine_location)
      .input("shift", sql.VarChar, row.shift)
      .input("used_on_line", sql.VarChar, row.used_on_line)
      .input("kvalue", sql.Float, row.kvalue)
      .input("grade", sql.VarChar, row.grade)
      .input("cell_capacity", sql.Float, row.cell_capacity)
      .input("cell_class", sql.VarChar, row.cell_class)
      .query(`
                UPDATE ${tableName}
                SET voltage=@voltage, ir=@ir, today_date=@today_date, updated_time=@updated_time,
                    machine_location=@machine_location, shift=@shift, used_on_line=@used_on_line,
                    kvalue=@kvalue, grade=@grade, cell_capacity=@cell_capacity, cell_class=@cell_class
                WHERE cell_qrcode = @qr
            `);

    console.log(`ðŸ”„ UPDATED â†’ ${qr}`);
  }

  // -----------------------
  // STEP 5: DELETE source row
  // -----------------------
  await src.request()
    .input("qr", sql.VarChar, qr)
    .query(`
        DELETE FROM taco_treceability.ocv_machine_data_mirror
        WHERE cell_qrcode = @qr
    `);

  console.log(`ðŸ—‘ï¸ DELETED SOURCE â†’ ${qr}`);
}

// -----------------------------------------------------
// CONTINUOUS LOOP
// -----------------------------------------------------
async function start() {
  while (true) {
    try {
      await processRecord();
    } catch (err) {
      console.error("ERROR:", err);
    }
    await new Promise(res => setTimeout(res, 2000));
  }
}

start();
