socket.on("get_popup_4_torque_rework", function (barcode, pack_battery) {

    console.log("üì• Socket Triggered");
    console.log("‚û°Ô∏è Barcode:", barcode);
    console.log("‚û°Ô∏è Pack Battery:", pack_battery);

    sql.connect(sqlConfig, function (err) {
        if (err) {
            console.log("‚ùå SQL Connection Error:", err);
            return;
        }

        const request = new sql.Request();

        // 1Ô∏è‚É£ Get FinalQRCode
        const finalQRQuery = `
            SELECT FinalQRCode 
            FROM taco_treceability.station_status
            WHERE PackName='${pack_battery}' 
            AND ModuleBarcode='${barcode}'
        `;

        console.log("üü° FinalQRCode Query:", finalQRQuery);

        request.query(finalQRQuery, function (err, resultQR) {
            if (err) {
                console.log("‚ùå FinalQRCode Query Error:", err);
                return;
            }

            console.log("üü¢ FinalQRCode Query Result:", resultQR.recordset);

            if (!resultQR.recordset.length) {
                console.log("‚ö†Ô∏è No FinalQRCode found for given barcode & pack");
                return;
            }

            const pack_no = resultQR.recordset[0].FinalQRCode;
            console.log("‚úÖ FinalQRCode (pack_no):", pack_no);

            let ingwholeData = [];
            let ingpackDAta = [];

            // 2Ô∏è‚É£ Global torque master data
            const query_GLOBALDATA = `
                SELECT pack_name, Station_name, process_name, 
                       SUM(total_screw) AS tot_screw_count 
                FROM taco_treceability.torque_masterEIP 
                WHERE pack_name='${pack_battery}' 
                AND Station_name='Bus_bar_rework'
                GROUP BY process_name, Station_name, pack_name
            `;

            console.log("üü° Global Torque Query:", query_GLOBALDATA);

            request.query(query_GLOBALDATA, function (err, globalResult) {
                if (err) {
                    console.log("‚ùå Global Torque Query Error:", err);
                    return;
                }

                console.log("üü¢ Global Torque Result:", globalResult.recordset);

                if (globalResult.recordset.length) {
                    globalResult.recordset.forEach(row => {
                        console.log("‚û°Ô∏è Process:", row.process_name, 
                                    "| Total Screw:", row.tot_screw_count);

                        ingwholeData.push(row.process_name);
                        ingwholeData.push(row.tot_screw_count);
                    });
                }

                console.log("üì¶ ingwholeData:", ingwholeData);

                // 3Ô∏è‚É£ Torque details query
                const dbQueryPack1 = `
                    SELECT process_name, COUNT(process_name) AS total_bolts 
                    FROM taco_treceability.torque_details_EIP 
                    WHERE pack_name='${pack_battery}' 
                    AND pack_no='${pack_no}' 
                    GROUP BY process_name
                `;

                console.log("üü° Torque Details Query:", dbQueryPack1);

                new sql.Request().query(dbQueryPack1)
                    .then(detailResult => {

                        console.log("üü¢ Torque Details Result:", detailResult.recordset);

                        detailResult.recordset.forEach(row => {
                            console.log("‚û°Ô∏è Process:", row.process_name, 
                                        "| Total Bolts:", row.total_bolts);

                            ingpackDAta.push(row.process_name);
                            ingpackDAta.push(row.total_bolts);
                        });

                        console.log("üì¶ ingpackDAta:", ingpackDAta);

                        // 4Ô∏è‚É£ Emit final data
                        console.log("üì§ Emitting Data to Frontend:");
                        console.log("‚û°Ô∏è ingwholeData:", ingwholeData);
                        console.log("‚û°Ô∏è ingpackDAta:", ingpackDAta);
                        console.log("‚û°Ô∏è pack_no:", pack_no);

                        socket.emit(
                            "setGlobalIngersollData_bajaj",
                            ingwholeData,
                            ingpackDAta,
                            pack_no
                        );
                    })
                    .catch(err => {
                        console.log("‚ùå Torque detail query error:", err);

                        socket.emit(
                            "setGlobalIngersollData_bajaj",
                            ingwholeData,
                            [],
                            pack_no
                        );
                    });
            });
        });
    });
});
