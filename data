import pyodbc
import requests
import time
import re
from Levenshtein import ratio as levenshtein_ratio

# ======================================================
# DB CONFIG
# ======================================================

def connect(cfg):
    return pyodbc.connect(
        f"DRIVER={{ODBC Driver 17 for SQL Server}};"
        f"SERVER={cfg['server']};"
        f"DATABASE={cfg['database']};"
        f"UID={cfg['user']};"
        f"PWD={cfg['password']};"
        "TrustServerCertificate=yes;"
    )

db1 = connect({
    "server": "10.9.4.28",
    "database": "taco_treceability",
    "user": "user_mis",
    "password": "admin"
})

db2 = connect({
    "server": "10.9.4.28",
    "database": "taco_treceability_master",
    "user": "user_mis",
    "password": "admin"
})

db3 = connect({
    "server": "10.9.4.28",
    "database": "master_taco_treceability_IR",
    "user": "user_mis",
    "password": "admin"
})

c1 = db1.cursor()
c2 = db2.cursor()
c3 = db3.cursor()

print("âœ… All DBs connected")

# ======================================================
# GLOBAL STATE
# ======================================================

lastSeenSrNo = 0

# ======================================================
# UTILITIES
# ======================================================

def normalize(text):
    return re.sub(r"\s+", " ",
                  re.sub(r"[^a-z0-9+/\-()& ]", "", text.lower())
                  ).strip()

def common_score(a, b):
    sa, sb = set(a.split()), set(b.split())
    return len(sa & sb) / max(len(sa), len(sb), 1)

# ======================================================
# UNIQUE PROCESSES (UNCHANGED)
# ======================================================

uniqueProcesses = [  # EXACT list from Node.js
    "IBB connector installation",
    "Module installation into tray (Front 3 module - A1 B2 A3)",
    "Module installation into tray (Rear 2 module - B6 A7)",
    "Module installation on cooling plate B4 A5",
    "A1 +ve to B2 -ve module series busbar connection",
    "B2 +ve to A3 -ve module series busbar connection",
    "A7 -ve to B6 +ve module series busbar connection",
    "B4 +ve to A5 -ve module series busbar connection",
    "A5 -ve to B6 +ve module series busbar connection",
    "A1 -ve to shunt busbar",
    "A3 +ve to B4 -ve busbar",
    "B4 -ve to A3 +ve busbar",
    "A7 +ve to BDU busbar",
    "BMS mounting and ground wire",
    "HV connector LR",
    "Coolant connector inlet LR",
    "Coolant connector outlet LR",
    "BDU mounting LR",
    "Fuse mounting LR",
    "Pyro switching mounting LR",
    "Smoke sensor LR",
    "Relay mounting LR",
    "Shunt mounting LR",
    "HV +ve to pyro switch busbar LR",
    "Pyro switch to HV +ve busbar LR",
    "HV -ve to relay busbar LR",
    "Relay to shunt +ve busbar LR",
    "Shunt -ve to module A1 busbar LR",
    "Pyro switch to fuse busbar LR",
    "Fuse busbar LR",
    "BDU to fuse busbar",
    "BDU to module A7 busbar LR",
    "Top cover assembly LR",
    "Waterproof vent valve LR",
    "L Plate Fixing(M1+M2+M3+M4)",
    "Busbar Fixing",
    "Tie Rod Fixing(M1+M2+M3+M4)",
    "Low Voltage Wiring Harness",
    "Flexible Negative Busbar",
    "Modules Installation into the Tray",
    "HV Connector",
    "Positive & Neg.",
    "BMS bracket installation",
    "Flexible HV negative busbar to BMS",
    "B+ fuse connector, +ve busbar/+HV busbar connector",
    "Negative busbar to BMS",
    "BMS on BMS bracket (6.1)",
    "fuse connector on the side bracket plate",
    "B+ev HV cable to BMS",
    "Communication plug-in installation (6.1)",
    "bolts to fix the upper and lower panel (6.1)",
    "C PlateFixing Plate Installation",
    "Top lid (Top cover)",
    "Breather plug",
    "L Plate Fixing(M5+M6+M7+M8)",
    "Tie Rod Fixing(M5+M6+M7+M8)",
    "busbar +ve module 4 to Module-5 -ev busbar -ev module5 to Module-5",
    "BMS on BMS bracket (12.2)",
    "Communication plug-in installation (12.2)",
    "bolts to fix the upper and lower panel (12.2)"
]

# ======================================================
# MAIN LOOP (1:1 LOGIC)
# ======================================================

def fetch_loop():
    global lastSeenSrNo

    try:
        process_sql = ",".join(f"'{p.replace(\"'\", \"''\")}'" for p in uniqueProcesses)

        c1.execute(f"""
            SELECT TOP(1) *
            FROM taco_treceability.torque_details_EIP_mirror
            WHERE sr_no > ?
              AND pack_name IN ('NOVA Prismatic LR','Bajaj 6.1','Bajaj 12.2')
              AND process_name IN ({process_sql})
            ORDER BY sr_no ASC
        """, lastSeenSrNo)

        rows = c1.fetchall()
        if not rows:
            return

        for r in rows:
            sr_no = r.sr_no
            processedPackNo = "not_linked" if r.pack_no == "not_linked" else r.pack_no[-6:]

            # ================= PACK ID =================
            c2.execute("SELECT Pack_ID FROM taco_treceability.master_pack WHERE Pack_Name=?", r.pack_name)
            pack = c2.fetchone()
            if not pack:
                continue
            packID = pack.Pack_ID

            # ================= SCAN TYPE =================
            scanType = None
            scanID = None
            moduleName = None
            moduleQR = None

            if not r.smoke_sensor_linked_pack_no or r.smoke_sensor_linked_pack_no.lower() == "null":
                c2.execute("""
                    SELECT Module_Name, Module_ID
                    FROM taco_treceability.master_module
                    WHERE moduleNumber=? AND Pack_ID=?
                """, r.module_name, packID)
                m = c2.fetchone()
                if not m:
                    continue
                scanType = "Module"
                scanID = m.Module_ID
                moduleName = m.Module_Name
            else:
                c2.execute("""
                    SELECT BOM_ID FROM taco_treceability.BOM_Master
                    WHERE BOM_Name='Smoke sensor' AND Pack_ID=?
                """, packID)
                b = c2.fetchone()
                if not b:
                    continue
                scanType = "BOM"
                scanID = b.BOM_ID

            # ================= PROCESS MASTER =================
            c3.execute("""
                SELECT Process_Name, Process_ID, Total_Count, Scan_Name
                FROM taco_treceability.Process_Master
                WHERE Pack_ID=? AND Scan_ID=?
            """, packID, scanID)

            processes = c3.fetchall()
            if not processes:
                continue

            best = {"score": 0}

            inp = normalize(r.process_name)

            for p in processes:
                cand = normalize(p.Process_Name)
                score = (
                    0.7 * common_score(inp, cand) +
                    0.3 * levenshtein_ratio(inp, cand)
                )
                if score > best["score"]:
                    best = {
                        "score": score,
                        "pid": p.Process_ID,
                        "count": p.Total_Count
                    }

            if best["score"] < 0.5:
                continue

            # ================= API =================
            payload = {
                "pack_id": str(packID),
                "process_id": best["pid"],
                "time": r.date_dd,
                "module_name": moduleName or r.pack_name,
                "target_count": best["count"],
                "pack_no": processedPackNo,
                "line_id": 1,
                "Received_Data": f"{r.torque},{r.angle}",
                "module_barcode": r.module_barcode
            }

            resp = requests.post(
                "https://mismainapp.tataautocomp.com:3241/trigger_process_data",
                json=payload,
                timeout=15
            ).json()

            msg = resp.get("message", "")
            status = resp.get("Process_Status", "")

            if msg in (
                "Process register updated successfully",
                "Process already completed. No update necessary."
            ):
                c1.execute("DELETE FROM taco_treceability.torque_details_EIP_mirror WHERE sr_no=?", sr_no)
                db1.commit()
                lastSeenSrNo = max(lastSeenSrNo, sr_no)
                return

    except Exception as e:
        print("âŒ ERROR:", e)

# ======================================================
# RUNNER
# ======================================================

print("ðŸš€ Python service started (Node.js equivalent)")

while True:
    fetch_loop()
    time.sleep(3)
