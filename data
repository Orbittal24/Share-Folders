socket.on('linking_smokeSensor_with_pack', async (newscanbarcode, moduleQR) => {
  console.log('linking', newscanbarcode, moduleQR);

  var dbQuery5 = `SELECT FinalQRCode FROM taco_treceability.station_status WHERE ModuleBarcode='${moduleQR}'`;
  var pack_notray;

  sql.connect(sqlConfig, function (err) {
    if (err) console.log(err);
    var request = new sql.Request();

    // --- Step 1: Check if smoke sensor already linked in table1 ---
    var checkQuery1 = `SELECT TOP (1) pack_no 
                       FROM taco_treceability.torque_details_EIP 
                       WHERE module_barcode = '${newscanbarcode}'`;

    request.query(checkQuery1, function (err, recordset1) {
      if (err) console.log(err);

      if (recordset1 && recordset1.recordset.length > 0 && recordset1.recordset[0].pack_no) {
        // Already linked in table 1
        socket.emit('already_linked', newscanbarcode, recordset1.recordset[0].pack_no);
        return;
      }

      // --- Step 2: If not found in table1, check table2 ---
      var checkQuery2 = `SELECT TOP (1) pack_no 
                         FROM taco_treceability.torque_details_EIP_import2 
                         WHERE module_barcode = '${newscanbarcode}'`;

      request.query(checkQuery2, function (err, recordset2) {
        if (err) console.log(err);

        if (recordset2 && recordset2.recordset.length > 0 && recordset2.recordset[0].pack_no) {
          // Already linked in table 2
          socket.emit('already_linked', newscanbarcode, recordset2.recordset[0].pack_no);
          return;
        }

        // --- Step 3: Not linked in either table â†’ proceed with your existing logic ---
        request.query(dbQuery5, function (err, recordset3) {
          if (err) console.log(err);
          if (recordset3) {
            var res = recordset3.recordset;
            if (res.length > 0) {
              for (var i in res) {
                pack_notray = res[i].FinalQRCode;
              }

              var dqQuery = `SELECT * FROM taco_treceability.torque_details_EIP 
                             WHERE smoke_sensor_linked_pack_no = '${newscanbarcode}'`;
              var dqQuery2 = `UPDATE taco_treceability.torque_details_EIP 
                              SET pack_no = '${pack_notray}' 
                              WHERE smoke_sensor_linked_pack_no = '${newscanbarcode}'`;

              request.query(dqQuery, function (err, recordset4) {
                var result = recordset4.recordset;
                if (result.length > 0) {
                  request.query(dqQuery2, function (err, recordset5) {
                    if (err) console.log(err);
                    console.log('linked');
                    socket.emit('linked_pack', newscanbarcode, pack_notray);
                  });
                }
              });
            } else {
              socket.emit('not_found_pack', newscanbarcode, moduleQR);
            }
          }
        });
      });
    });
  });
});
