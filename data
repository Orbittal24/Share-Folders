const net = require("net");
const { spawn } = require("child_process");

const CLIENT_PORT = 7090; // Must match server port
const PRINTER_NAME = "TOSHIBA"; // Change to your USB printerâ€™s installed name

// Create TCP server to receive PRN data
const server = net.createServer((socket) => {
  console.log("ðŸ“¥ Connection received from server.");

  let prnData = "";

  socket.on("data", (chunk) => {
    prnData += chunk.toString();
  });

  socket.on("end", () => {
    console.log("âœ… Data received. Sending to USB printer...");

    // Spawn Windows print command and send PRN data via stdin
    const printProcess = spawn("PRINT", [`/D:${PRINTER_NAME}`], {
      shell: true,
      windowsHide: true,
    });

    // Write data directly without saving file
    printProcess.stdin.write(prnData, "utf8");
    printProcess.stdin.end();

    printProcess.stdout.on("data", (data) => {
      console.log("ðŸ–¨ï¸ Printer response:", data.toString());
    });

    printProcess.stderr.on("data", (data) => {
      console.error("âŒ Print error:", data.toString());
    });

    printProcess.on("close", (code) => {
      console.log(`ðŸ”Œ Print job finished with code ${code}`);
    });
  });
});

server.listen(CLIENT_PORT, () => {
  console.log(`ðŸš€ Client listening on port ${CLIENT_PORT} for print jobs...`);
});
