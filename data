const sql = require('mssql');
const moment = require('moment');

const sqlConfig = {
  user: "user_mis",
  password: "admin",
  database: "taco_treceability",
  server: 'localhost\\MSSQLSERVER',
  pool: { max: 10, min: 0, idleTimeoutMillis: 30000 },
  options: { encrypt: true, trustServerCertificate: true }
};

// Array of QR codes to process dynamically
const New_final_qr_code_arr = [
  'DJ1919-F9E0000262',
  'DJ1919-FBD0000282',
  'DJ1919-G140000379'
];

async function main() {
  try {
    let pool = await sql.connect(sqlConfig);
    console.log("Connected to taco_treceability...");

    for (const currentQR of New_final_qr_code_arr) {
      console.log(`\n=== Processing QR: ${currentQR} ===`);

      // Step 1: Get module_barcode_string for Smoke Sensor
      const smokeQuery = `
        SELECT module_barcode_string
        FROM taco_treceability.battery_details
        WHERE battery_pack_name = 'SM eDost'
          AND final_qrcode = '${currentQR}'
          AND module_name = 'Smoke Sensor'
      `;
      const smokeResult = await pool.request().query(smokeQuery);

      if (smokeResult.recordset.length === 0) {
        console.warn(`⚠️ No Smoke Sensor found for ${currentQR}, skipping...`);
        continue;
      }

      const new_smoke = smokeResult.recordset[0].module_barcode_string;
      console.log(`Found Smoke Sensor Barcode: ${new_smoke}`);

      // Step 2: Get ModuleBarcode and moduleNumber for this QR
      const moduleQuery = `
        SELECT ModuleBarcode, moduleNumber 
        FROM taco_treceability.station_status 
        WHERE FinalQRCode='${currentQR}'
      `;
      const moduleResult = await pool.request().query(moduleQuery);
      const modules = moduleResult.recordset;

      if (modules.length === 0) {
        console.warn(`⚠️ No module records found for ${currentQR}, skipping...`);
        continue;
      }

      // Step 3: Update all module records one by one
      for (let i = 0; i < modules.length; i++) {
        const { ModuleBarcode, moduleNumber } = modules[i];
        const updateQuery = `
          UPDATE taco_treceability.torque_details_EIP_traial2
          SET pack_no='${currentQR}', module_barcode='${ModuleBarcode}'
          WHERE module_name='${moduleNumber}'
        `;
        await pool.request().query(updateQuery);
        console.log(`✔️ Updated module ${i + 1}/${modules.length} for ${currentQR}`);
      }

      // Step 4: Update smoke sensor barcode
      const smokeUpdateQuery = `
        UPDATE taco_treceability.torque_details_EIP_traial2
        SET module_barcode='${new_smoke}', smoke_sensor_linked_pack_no='${new_smoke}'
        WHERE smoke_sensor_linked_pack_no LIKE 'BA%'
      `;
      await pool.request().query(smokeUpdateQuery);
      console.log(`✔️ Updated Smoke Sensor for ${currentQR}`);

      // Step 5: Copy data to import2 (optional per QR)
      await copyDataToImportTable(pool);
    }

    console.log("\n✅ All QR codes processed successfully.");
  } catch (err) {
    console.error("❌ Error:", err);
  } finally {
    sql.close();
  }
}

// === Function to copy data ===
async function copyDataToImportTable(pool) {
  const selectQuery = `
    SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift,
           module_barcode, process_status, pack_no, rework_status, bypass_operator,
           bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no
    FROM taco_treceability.torque_details_EIP_traial2
  `;

  const insertQueryBase = `
    INSERT INTO taco_treceability.torque_details_EIP_mirror_import2 
    (pack_name, module_name, torque, angle, torque_status, date_dd, shift,
     module_barcode, process_status, pack_no, rework_status, bypass_operator,
     bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no)
    VALUES
  `;

  const result = await pool.request().query(selectQuery);
  const rows = result.recordset;

  if (rows.length === 0) {
    console.log("No data to insert.");
    return;
  }

  const values = rows.map(r => `(
    '${r.pack_name}',
    '${r.module_name}',
    ${r.torque !== null ? r.torque : 'NULL'},
    ${r.angle !== null ? r.angle : 'NULL'},
    '${r.torque_status}',
    '${moment(r.date_dd).format('YYYY-MM-DD HH:mm:ss')}',
    '${r.shift}',
    '${r.module_barcode}',
    '${r.process_status}',
    '${r.pack_no}',
    '${r.rework_status}',
    '${r.bypass_operator}',
    '${r.bypass_reason}',
    '${r.process_name}',
    '${r.station_name}',
    '${r.smoke_sensor_linked_pack_no}'
  )`).join(",");

  const insertQuery = insertQueryBase + values;
  await pool.request().query(insertQuery);
  console.log("✔️ Data copied successfully to import2.");
}

// Start process
main();
