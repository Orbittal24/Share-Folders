/******************** MODULES ********************/
const express = require("express");
const app = express();
const http = require("http").Server(app);
const io = require("socket.io")(http);
const path = require("path");
const sql = require("mssql");
const axios = require("axios");   // âœ… NEW

/******************** MIDDLEWARE ********************/
app.use(express.static(__dirname));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

/******************** DB CONFIG ********************/
const sqlConfig = {
    user: "user_mis",
    password: "admin",
    database: "taco_treceability_master",
    server: "localhost\\MSSQLSERVER",
    pool: {
        max: 10,
        min: 0,
        idleTimeoutMillis: 30000
    },
    options: {
        encrypt: true,
        trustServerCertificate: true
    }
};

/******************** DB CONNECTION ********************/
const dbConn = new sql.ConnectionPool(sqlConfig);
dbConn.connect()
    .then(() => console.log("âœ… Connected to taco_treceability_master"))
    .catch(err => console.error("âŒ DB Connection Error:", err));

/******************** SERVER ********************/
http.listen(5400, "0.0.0.0", () => {
    console.log("ğŸš€ Server running on port 5400");
});

/******************** UI ROUTE ********************/
app.get("/station_status", (req, res) => {
    res.sendFile(path.join(__dirname, "app_station_status_ui.html"));
});

/******************** API: LOAD STATIONS ********************/
app.get("/api/stations", async (req, res) => {
    try {
        const result = await dbConn.request().query(`
            SELECT Station_ID, Station_Name
            FROM taco_treceability.master_station
            ORDER BY Station_Name
        `);
        res.json(result.recordset);
    } catch (err) {
        console.error("âŒ Station fetch error:", err);
        res.status(500).json({ error: "Failed to load stations" });
    }
});

/******************** API: BARCODE SCAN ********************/
app.post("/api/scan", async (req, res) => {
    try {
        const { stationId, line, barcode } = req.body;

        if (!stationId || !barcode) {
            return res.status(400).json({ message: "Station & barcode required" });
        }

        console.log("ğŸ“¥ SCAN RECEIVED");
        console.log("Station ID:", stationId);
        console.log("Line:", line);
        console.log("Barcode:", barcode);

        /* ========= FORWARD DATA TO EXTERNAL API ========= */
        const apiPayload = {
            station_id: stationId,
            line_id: line,
            customer_qrcode: barcode,
            station_status: "OK",
            checklist_name: "NA",
            substation_id: "NA"
        };

        try {
            const apiResponse = await axios.post(
                "https://localhost:5555/station_status/filter",
                apiPayload,
                {
                    httpsAgent: new (require("https").Agent)({
                        rejectUnauthorized: false // âš ï¸ needed for localhost HTTPS
                    })
                }
            );

            console.log("âœ… External API Response:", apiResponse.data);
        } catch (apiErr) {
            console.error("âŒ External API Error:", apiErr.message);
        }

        res.json({ message: "Barcode processed successfully" });

    } catch (err) {
        console.error("âŒ Scan error:", err);
        res.status(500).json({ message: "Scan failed" });
    }
});

/******************** SOCKET.IO ********************/
io.on("connection", (socket) => {
    console.log("ğŸ”Œ Client connected");

    socket.on("disconnect", () => {
        console.log("âŒ Client disconnected");
    });
});
