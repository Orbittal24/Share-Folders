const sql = require('mssql');

const sqlConfig = {
  user: "user_mis",
  password: "admin",
  database: "taco_treceability",
  server: 'localhost\\MSSQLSERVER',
  pool: {
    max: 10,
    min: 0,
    idleTimeoutMillis: 30000
  },
  options: {
    encrypt: true,
    trustServerCertificate: true
  }
};

// ‚úÖ Static list of ModuleBarcodes
const moduleBarcodes = [
  '01TS0043000021E8G0000005',
  '01TS0043000021E8K0000006',
  '01TS0043000021E9A0000007'
  // üëâ Add more ModuleBarcodes as needed
];

async function processModuleBarcodes() {
  try {
    const pool = await sql.connect(sqlConfig);
    console.log("‚úÖ Connected to taco_treceability...");

    console.log(`üì¶ Found ${moduleBarcodes.length} ModuleBarcodes to process`);

    // Process each barcode one by one
    for (const barcode of moduleBarcodes) {
      console.log(`\nüîπ Processing ModuleBarcode: ${barcode}`);

      // Step 1: Update torque_details_EIP_pdu_alt
      const updateResult = await pool.request()
        .input('module_barcode', sql.VarChar, barcode)
        .input('pack_no', sql.VarChar, barcode)
        .query(`
          UPDATE taco_treceability.torque_details_EIP_pdu_alt
          SET module_barcode = @module_barcode, pack_no = @pack_no
          WHERE pack_no = @pack_no OR (pack_no IS NULL OR pack_no = '')
        `);

      console.log(`‚úÖ Updated ${updateResult.rowsAffected} rows for ${barcode}`);

      // Step 2: Select updated records for this barcode
      const selectResult = await pool.request()
        .input('pack_no', sql.VarChar, barcode)
        .query(`
          SELECT pack_name, module_name, torque, angle, torque_status, date_dd, shift,
                 module_barcode, process_status, pack_no, rework_status, bypass_operator,
                 bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no
          FROM taco_treceability.torque_details_EIP_pdu_alt
          WHERE pack_no = @pack_no
        `);

      const records = selectResult.recordset;

      if (records.length === 0) {
        console.log(`‚ö†Ô∏è No records found for ${barcode}`);
        continue;
      }

      console.log(`üì• Found ${records.length} records for ${barcode}, inserting into _alt_all...`);

      // Step 3: Insert selected records into torque_details_EIP_pdu_alt_all
      for (const r of records) {
        const dateValue = r.date_dd instanceof Date ? r.date_dd : new Date(r.date_dd);

        await pool.request()
          .input('pack_name', sql.VarChar, r.pack_name)
          .input('module_name', sql.VarChar, r.module_name)
          .input('torque', sql.Float, r.torque)
          .input('angle', sql.Float, r.angle)
          .input('torque_status', sql.VarChar, r.torque_status)
          .input('date_dd', sql.DateTime, dateValue) // ‚úÖ preserves exact SQL datetime
          .input('shift', sql.VarChar, r.shift)
          .input('module_barcode', sql.VarChar, r.module_barcode)
          .input('process_status', sql.VarChar, r.process_status)
          .input('pack_no', sql.VarChar, r.pack_no)
          .input('rework_status', sql.VarChar, r.rework_status)
          .input('bypass_operator', sql.VarChar, r.bypass_operator)
          .input('bypass_reason', sql.VarChar, r.bypass_reason)
          .input('process_name', sql.VarChar, r.process_name)
          .input('station_name', sql.VarChar, r.station_name)
          .input('smoke_sensor_linked_pack_no', sql.VarChar, r.smoke_sensor_linked_pack_no)
          .query(`
            INSERT INTO taco_treceability.torque_details_EIP_pdu_alt_all
            (pack_name, module_name, torque, angle, torque_status, date_dd, shift,
             module_barcode, process_status, pack_no, rework_status, bypass_operator,
             bypass_reason, process_name, station_name, smoke_sensor_linked_pack_no)
            VALUES (@pack_name, @module_name, @torque, @angle, @torque_status, @date_dd, @shift,
                    @module_barcode, @process_status, @pack_no, @rework_status, @bypass_operator,
                    @bypass_reason, @process_name, @station_name, @smoke_sensor_linked_pack_no)
          `);
      }

      console.log(`‚úÖ Inserted ${records.length} rows for ${barcode} into torque_details_EIP_pdu_alt_all`);
    }

    console.log("\nüéâ All ModuleBarcodes processed successfully!");
    await pool.close();

  } catch (err) {
    console.error("‚ùå Error:", err);
  }
}

// Run the script
processModuleBarcodes();
