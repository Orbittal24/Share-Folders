try {
  /* ---------------- YOUR EXISTING LOGIC (UNCHANGED) ---------------- */

  const processedPackNo =
    row.pack_no === 'not_linked' ? 'not_linked' : row.pack_no.slice(-6);

  const packRes = await pool2.request().query(`
    SELECT Pack_ID FROM taco_treceability.master_pack
    WHERE Pack_Name='${row.pack_name}'
  `);
  if (!packRes.recordset.length) {
    await deleteRow(row.sr_no);
    continue;
  }
  const packID = packRes.recordset[0].Pack_ID;

  let scanType, scanID, moduleName, modulebarQR;

  if (!row.smoke_sensor_linked_pack_no || row.smoke_sensor_linked_pack_no === 'null') {
    const modRes = await pool2.request().query(`
      SELECT Module_Name, Module_ID FROM taco_treceability.master_module
      WHERE moduleNumber='${row.module_name}' AND Pack_ID='${packID}'
    `);
    if (!modRes.recordset.length) {
      await deleteRow(row.sr_no);
      continue;
    }
    scanType = 'Module';
    scanID = modRes.recordset[0].Module_ID;
    moduleName = modRes.recordset[0].Module_Name;
  } else {
    const bomRes = await pool2.request().query(`
      SELECT BOM_ID FROM taco_treceability.BOM_Master
      WHERE BOM_Name='Smoke sensor' AND Pack_ID='${packID}'
    `);
    if (!bomRes.recordset.length) {
      await deleteRow(row.sr_no);
      continue;
    }
    scanType = 'BOM';
    scanID = bomRes.recordset[0].BOM_ID;
  }

  if (row.module_barcode.startsWith('DJ')) {
    const qrRes = await pool1.request().query(`
      SELECT CustomerQRCode FROM taco_treceability.final_qrcode_details
      WHERE final_qrcode='${row.pack_no}'
    `);
    if (!qrRes.recordset.length) {
      await deleteRow(row.sr_no);
      continue;
    }
    scanType = 'Pack';
    modulebarQR = qrRes.recordset[0].CustomerQRCode;
  }

  const [pmRes, pmResPack, pmResBom] = await Promise.all([
    pool3.request().query(`
      SELECT Process_Name, Process_ID, Total_Count, Scan_Name
      FROM taco_treceability.Process_Master
      WHERE Pack_ID='${packID}' AND Scan_ID='${scanID}'
    `),
    pool3.request().query(`
      SELECT Process_Name, Process_ID, Total_Count, Scan_Name
      FROM taco_treceability.Process_Master
      WHERE Pack_ID='${packID}' AND Scan_ID='${packID}' AND Scan_Name='Pack'
    `),
    pool3.request().query(`
      SELECT Process_Name, Process_ID, Total_Count, Scan_Name
      FROM taco_treceability.Process_Master
      WHERE Pack_ID='${packID}' AND Scan_Name='BOM'
    `)
  ]);

  if (scanType === 'Module' && !pmRes.recordset.length) {
    await deleteRow(row.sr_no);
    continue;
  }
  if (scanType === 'Pack' && !pmResPack.recordset.length) {
    await deleteRow(row.sr_no);
    continue;
  }
  if (scanType === 'BOM' && !pmResBom.recordset.length) {
    await deleteRow(row.sr_no);
    continue;
  }

  let best = { score: 0 }, best1 = { score: 0 }, best2 = { score: 0 };

  /* ---------------- MODULE MATCH LOGIC ---------------- */
  if (scanType === 'Module') {
    const inputNorm = normalizeProcess(row.process_name);
    const modKey = moduleName.toLowerCase();

    for (const p of pmRes.recordset) {
      const raw = p.Process_Name.toLowerCase();
      const needsModuleMatch = /\bM\d+\b/i.test(raw);
      const processModules = raw.match(/\bM\d+\b/gi) || [];

      if (
        needsModuleMatch &&
        !raw.includes(modKey) &&
        !processModules.some(m => m.toLowerCase() === modKey)
      ) continue;

      const cand = normalizeProcess(p.Process_Name);
      let score =
        inputNorm === cand ? 1 :
        cand.includes(inputNorm) ? 0.95 :
        inputNorm.includes(cand) ? 0.9 :
        0.7 * getCommonWordsScore(inputNorm, cand) +
        0.3 * stringSimilarity.compareTwoStrings(inputNorm, cand);

      if (score > best.score) {
        best = { score, processID: p.Process_ID, totalCount: p.Total_Count };
      }
    }

    if (!best.processID) {
      await deleteRow(row.sr_no);
      continue;
    }

    const apiPayload = {
      pack_id: String(packID),
      process_id: best.processID,
      time: row.date_dd,
      module_name: moduleName,
      target_count: best.totalCount,
      pack_no: processedPackNo,
      line_id: 1,
      Received_Data: `${row.torque},${row.angle}`,
      module_barcode: row.module_barcode
    };

    const res = await axios.post(
      'https://mismainapp.tataautocomp.com:3241/trigger_process_data',
      apiPayload
    );

    if (res.data?.message) {
      await deleteRow(row.sr_no);
    }
  }

  /* ---------------- PACK MATCH LOGIC ---------------- */
  else if (scanType === 'Pack') {
    const inputNorm = normalizeProcess(row.process_name);
    for (const p of pmResPack.recordset) {
      const cand = normalizeProcess(p.Process_Name);
      const score =
        inputNorm === cand ? 1 :
        0.7 * getCommonWordsScore(inputNorm, cand) +
        0.3 * stringSimilarity.compareTwoStrings(inputNorm, cand);

      if (score > best1.score) {
        best1 = { score, processID: p.Process_ID, totalCount: p.Total_Count };
      }
    }

    if (!best1.processID) {
      await deleteRow(row.sr_no);
      continue;
    }

    await axios.post(
      'https://mismainapp.tataautocomp.com:3241/trigger_process_data',
      {
        pack_id: String(packID),
        process_id: best1.processID,
        time: row.date_dd,
        module_name: row.pack_name,
        target_count: best1.totalCount,
        pack_no: processedPackNo,
        line_id: 1,
        Received_Data: `${row.torque},${row.angle}`,
        module_barcode: modulebarQR
      }
    );

    await deleteRow(row.sr_no);
  }

  /* ---------------- BOM MATCH LOGIC ---------------- */
  else if (scanType === 'BOM') {
    const inputNorm = normalizeProcess(row.process_name);

    for (const p of pmResBom.recordset) {
      const cand = normalizeProcess(p.Process_Name);
      const score =
        0.7 * getCommonWordsScore(inputNorm, cand) +
        0.3 * stringSimilarity.compareTwoStrings(inputNorm, cand);

      if (score > best2.score) {
        best2 = { score, processID: p.Process_ID, totalCount: p.Total_Count };
      }
    }

    if (!best2.processID) {
      await deleteRow(row.sr_no);
      continue;
    }

    const apiUrl =
      processedPackNo === 'not_linked'
        ? 'trigger_tray_data'
        : 'trigger_tray_after_link_data';

    await axios.post(
      `https://mismainapp.tataautocomp.com:3241/${apiUrl}`,
      {
        pack_id: String(packID),
        process_id: best2.processID,
        time: row.date_dd,
        bom_id: scanID,
        Pack_Number: processedPackNo,
        target_count: best2.totalCount,
        line_id: 1,
        Received_Data: `${row.torque},${row.angle}`,
        bom_qr: `${row.module_barcode},${row.module_barcode}`
      }
    );

    await deleteRow(row.sr_no);
  }

  /* ---------------- END OF YOUR LOGIC ---------------- */

} catch (err) {
  console.error("Row error:", err.message);
  await deleteRow(row.sr_no);
}
