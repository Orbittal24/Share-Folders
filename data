socket.on('getGlobalIngersollData_alt_pdu', (pack_name, pack_no) => {
    console.log('pack_name, pack_no $$$$$$', pack_name, pack_no);

    var ingwholeData = [];
    var ingpackDAta = [];

    // Step 1: First query to get module_barcode from pack_name and pack_no
    var moduleBarcodeQuery = `SELECT module_barcode FROM taco_treceability.pdu_qrcode_details WHERE final_qrcode = '${pack_no}' AND battery_pack_name = '${pack_name}'`;

    sql.connect(sqlConfig, function (err) {
        if (err) {
            console.log("Connection error:", err);
            return;
        }

        let request = new sql.Request();
        request.query(moduleBarcodeQuery, function (err, recordset) {
            if (err) {
                console.log("Error fetching module_barcode:", err);
                return;
            }

            // Check if module_barcode found
            let module_barcode = (recordset.recordset.length > 0) ? recordset.recordset[0].module_barcode : pack_no; // Fallback to pack_no if not found

            // Now proceed with original logic (first main query)
            var query_GLOBALDATA = `SELECT module_name,pack_name,Station_name,process_name,COUNT(process_name) as processcount,sum(total_screw) as tot_screw_count FROM taco_treceability.taco_treceability.torque_masterEIP where pack_name='${pack_name}' AND Station_name IN ('PDU_alt_Cerus_450','PDU_alt_Cerus_300','PDU_alt_Kratos_450','PDU_alt_Kratos_300','PDU_alt_283','PDU_alt_424','PDU_alt_184') AND process_name IN ('Lid fitment to tray (Cerus_450_pdu)','Lid fitment to tray (Cerus_300_pdu)','Lid fitment to tray (Kratos_450_pdu)','Lid fitment to tray (Kratos_300_pdu)','Lid fitment to tray pdu 283','Lid fitment to tray pdu 424','Lid fitment to tray pdu 184') GROUP BY process_name,Station_name,pack_name,total_screw,module_name`;

            request.query(query_GLOBALDATA, function (err, recordset) {
                if (err) {
                    console.log("Error in GLOBALDATA query:", err);
                    return;
                }

                var result = recordset.recordset;

                if (result.length != 0) {
                    for (var i in result) {
                        var module_name = result[i].module_name;
                        var station_name = result[i].Station_name;
                        var process_name = result[i].process_name;
                        var processcount = result[i].processcount;
                        var tot_screw_count = result[i].tot_screw_count;

                        ingwholeData.push(module_name);
                        ingwholeData.push(station_name);
                        ingwholeData.push(process_name);
                        ingwholeData.push(processcount);
                        ingwholeData.push(tot_screw_count);
                    }

                    // Step 2: Use module_barcode instead of pack_no in dbQueryPack
                    var dbQueryPack = `SELECT module_name,pack_name,pack_no,station_name,process_name,COUNT(process_name) as total_bolts FROM taco_treceability.taco_treceability.torque_details_EIP where pack_name='${pack_name}' and pack_no='${module_barcode}' GROUP BY process_name,station_name,pack_name,pack_no,module_name`;

                    request.query(dbQueryPack, function (err, recordset) {
                        if (err) {
                            console.log("Error in dbQueryPack:", err);
                            return;
                        }

                        var result = recordset.recordset;

                        if (result.length != 0) {
                            for (var i in result) {
                                var module_name = result[i].module_name;
                                var station_name = result[i].station_name;
                                var process_name = result[i].process_name;
                                var total_bolts = result[i].total_bolts;

                                ingpackDAta.push(module_name);
                                ingpackDAta.push(station_name);
                                ingpackDAta.push(process_name);
                                ingpackDAta.push(total_bolts);
                            }

                            socket.emit("setGlobalIngersollData", ingwholeData, ingpackDAta, pack_no);
                        } else {
                            socket.emit("setGlobalIngersollData", ingwholeData, ingpackDAta, pack_no);
                        }
                    });

                }
            });
        });
    });
});
