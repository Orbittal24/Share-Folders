app.post("/api/scan", async (req, res) => {
    try {
        const { stationId, line, barcode } = req.body;

        if (!stationId || !barcode) {
            return res.status(400).json({ message: "Station & barcode required" });
        }

        console.log("üì• SCAN RECEIVED");
        console.log("Station ID:", stationId);
        console.log("Line:", line);
        console.log("Barcode:", barcode);

        const apiPayload = {
            station_id: stationId,
            line_id: line,
            customer_qrcode: barcode,
            station_status: "OK",
            checklist_name: "NA",
            substation_id: "NA"
        };

        console.log("‚û°Ô∏è Sending Payload:", apiPayload);

        try {
            const apiResponse = await axios.post(
                "https://mismainapp.tataautocomp.com:3241/station_status/filter",
                apiPayload,
                {
                    httpsAgent: new (require("https").Agent)({
                        rejectUnauthorized: false
                    }),
                    timeout: 10000
                }
            );

            /* ===== PRINT FULL RESPONSE ===== */
            console.log("‚úÖ External API STATUS:", apiResponse.status);
            console.log("‚úÖ External API DATA:", apiResponse.data);

            /* ===== SEND RESPONSE TO UI ===== */
            return res.json({
                message: "Barcode processed successfully",
                externalApiStatus: apiResponse.status,
                externalApiResponse: apiResponse.data
            });

        } catch (apiErr) {

            /* ===== PRINT ERROR RESPONSE (IF ANY) ===== */
            console.error("‚ùå External API ERROR STATUS:", apiErr.response?.status);
            console.error("‚ùå External API ERROR DATA:", apiErr.response?.data || apiErr.message);

            return res.status(500).json({
                message: "External API failed",
                error: apiErr.response?.data || apiErr.message
            });
        }

    } catch (err) {
        console.error("‚ùå Scan error:", err);
        res.status(500).json({ message: "Scan failed" });
    }
});
