js
const axios = require('axios');

socket.on('getFinalQRCodeStatus_nova_pa_gun5', async (battery_qrcode) => {
    try {
        // Call your API with barcode
        const response = await axios.post("http://your-api-server/api/getStatus", {
            barcode: battery_qrcode
        });

        // Assume API returns something like:
        // { ModulePrintStatus: "OK", Welding_status: "Pending", IR_V_status: "OK", FinalQRCodePrint_status: "Pending" }

        let dataObj = {
            ModulePrintStatus: response.data.ModulePrintStatus === "OK",
            Welding_status: response.data.Welding_status === "OK",
            IR_V_status: response.data.IR_V_status === "OK",
            FinalQRCodePrint_status: response.data.FinalQRCodePrint_status === "OK"
        };

        socket.emit("setFinalQRCodeStatus", dataObj, battery_qrcode);
    } catch (error) {
        console.error("API error:", error.message);
        socket.emit("setFinalQRCodeStatus", { error: true }, battery_qrcode);
    }
});

html
socket.on("setFinalQRCodeStatus", function (data, battery_qrcode) {
    globalBatteryFinalQRCode = battery_qrcode;
    console.log("setFinalQRCodeStatus:", data);

    if (data.error) {
        Swal.fire("Error", "Could not fetch process status. Try again.", "error");
        return;
    }

    // Collect pending processes
    let pendingProcesses = [];
    if (!data.ModulePrintStatus) pendingProcesses.push("Module Printing");
    if (!data.Welding_status) pendingProcesses.push("Welding");
    if (!data.IR_V_status) pendingProcesses.push("Voltage & IR Testing");
    if (!data.FinalQRCodePrint_status) pendingProcesses.push("Final QR Code Printing");

    if (pendingProcesses.length > 0) {
        Swal.fire({
            title: `Pending Processes for Module: ${globalBatteryFinalQRCode}`,
            html: `<ul>${pendingProcesses.map(p => `<li>${p}</li>`).join("")}</ul>`,
            icon: "info",
            confirmButtonText: "Bypass Check"
        }).then(() => {
            console.log("Bypassing checks:", globalBatteryFinalQRCode);
            checkPasscode("valid", globalBatteryFinalQRCode);
        });
    } else {
        // All good â†’ proceed
        handleBarcode2(globalBatteryFinalQRCode);
    }
});


//////////////////actual
fe
socket.on("setFinalQRCodeStatus", function (data, battery_qrcode) {
    globalBatteryFinalQRCode = battery_qrcode;

    if (data.error) {
        Swal.fire("Error", "Could not fetch process status. Try again.", "error");
        return;
    }

    if (data.pendingProcesses.length > 0) {
        Swal.fire({
            title: `Pending Processes for Module: ${globalBatteryFinalQRCode}`,
            html: `<ul>${data.pendingProcesses.map(p => `<li>${p}</li>`).join("")}</ul>`,
            icon: "info",
            confirmButtonText: "Bypass Check"
        }).then(() => {
            console.log("Bypassing checks:", globalBatteryFinalQRCode);
            checkPasscode("valid", globalBatteryFinalQRCode);
        });
    } else {
        // All processes completed
        handleBarcode2(globalBatteryFinalQRCode);
    }
});

/////////actual be
const axios = require("axios");

socket.on("getFinalQRCodeStatus_nova_pa_gun5", async (battery_qrcode) => {
    try {
        // Build request body for API
        const requestData = {
            station_id: 8, // <-- adjust dynamically if needed
            line_id: 1,    // <-- adjust dynamically if needed
            customer_qrcode: battery_qrcode
        };

        // Call API
        const response = await axios.post("http://your-api-server/station_interlock", requestData);

        // Parse response
        const result = response.data;
        let pendingProcesses = [];

        if (Array.isArray(result) && result.length > 0) {
            const rows = result[0].rows[0]; // first object inside rows
            const audit_status = result[0].audit_status;

            // Check each process in rows
            for (let [process, status] of Object.entries(rows)) {
                if (status !== "OK") {
                    pendingProcesses.push(process);
                }
            }

            // Check audit status
            if (audit_status !== "OK") {
                pendingProcesses.push("Audit Status");
            }
        }

        socket.emit("setFinalQRCodeStatus", { pendingProcesses }, battery_qrcode);

    } catch (error) {
        console.error("API error:", error.message);
        socket.emit("setFinalQRCodeStatus", { error: true }, battery_qrcode);
    }
});
//////new
socket.on("setFinalQRCodeStatus", function (data, battery_qrcode) {
    globalBatteryFinalQRCode = battery_qrcode;

    if (data.error) {
        Swal.fire("Error", "Could not fetch process status. Try again.", "error");
        return;
    }

    // If audit_status is NOT OK -> show popup
    if (data.audit_status && data.audit_status !== "OK") {
        Swal.fire({
            title: `Voltage IR Pending!`,
            text: `Module and Barcode: ${globalBatteryFinalQRCode} still pending.`,
            icon: "info",
            confirmButtonText: "Bypass Check"
        }).then(() => {
            console.log("Bypassing checks:", globalBatteryFinalQRCode);
            checkPasscode("valid", globalBatteryFinalQRCode);
        });
    } else {
        // If audit_status is OK -> go further
        handleBarcode2(globalBatteryFinalQRCode);
    }
});

