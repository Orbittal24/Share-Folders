import fetch from "node-fetch";

socket.on("getGlobalIngersollData", async (pack_name, pack_no) => {
    try {
        console.log("pack_name, pack_no:::::::::::", pack_name, pack_no);

        // ✅ Step 1: First API → Get Pack_ID from Pack_Name
        const firstApiUrl = `https://Misapp.tataautocomp.com:5555/packs?Pack_Name=${encodeURIComponent(pack_name.trim())}`;
        const firstRes = await fetch(firstApiUrl);
        const firstData = await firstRes.json();
        console.log("Pack API result:", JSON.stringify(firstData, null, 2));

        if (!firstData.length || !firstData[0].Pack_ID) {
            console.error("No Pack_ID found for pack_name:", pack_name);
            return;
        }

        const pack_id = firstData[0].Pack_ID;

        // ✅ Step 2: Second API → Use last 6 digits of pack_no + Pack_ID
        const pack_number = pack_no.slice(-6); // last 6 digits
        const secondApiUrl = `https://Misapp.tataautocomp.com:5555/pack-duplicates?Pack_No=${pack_number}&Pack_ID=${pack_id}`;
        const secondRes = await fetch(secondApiUrl);
        const secondData = await secondRes.json();
        console.log("Second API raw result:", JSON.stringify(secondData, null, 2));

        if (!secondData.length) {
            console.error("No data found in second API for:", pack_no);
            return;
        }

        const { Pack_No, Pack_creation_Date } = secondData[0];

        // ✅ Format date to YY-MM-DD
        const [year, month, day] = Pack_creation_Date.split("T")[0].split("-");
        const formattedDate = `${year.slice(2)}-${month}-${day}`; // e.g. 2025-08-20 → 25-08-20

        // ✅ Step 3: Third API call using Pack_No & formatted date
        const thirdApiUrl = `https://Misapp.tataautocomp.com:5555/tray-bolting-like-table?pack_number=${Pack_No}&pack_date=${formattedDate}`;
        console.log("Third API URL:", thirdApiUrl);

        const thirdRes = await fetch(thirdApiUrl);
        const thirdData = await thirdRes.json();
        console.log("Third API result:", JSON.stringify(thirdData, null, 2));

    } catch (err) {
        console.error("Error in API chain:", err.message);
    }
});
